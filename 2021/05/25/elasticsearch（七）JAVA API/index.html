<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yrlzero.gitee.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="JAVA APITransport Client：TransportClient不推荐使用，而推荐使用Java High Level REST Client，并将在Elasticsearch 8.0中删除。Java Low Level REST Client：低级别的REST客户端，通过http与集群交互，用户需自己编组请求JSON串，及解析响应JSON串。兼容所有ES版本Java High Le">
<meta property="og:type" content="article">
<meta property="og:title" content="elasticsearch(七)-JAVA API">
<meta property="og:url" content="http://yrlzero.gitee.io/2021/05/25/elasticsearch%EF%BC%88%E4%B8%83%EF%BC%89JAVA%20API/index.html">
<meta property="og:site_name" content="yrl&#39;s blog">
<meta property="og:description" content="JAVA APITransport Client：TransportClient不推荐使用，而推荐使用Java High Level REST Client，并将在Elasticsearch 8.0中删除。Java Low Level REST Client：低级别的REST客户端，通过http与集群交互，用户需自己编组请求JSON串，及解析响应JSON串。兼容所有ES版本Java High Le">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-05-25T14:12:05.451Z">
<meta property="article:modified_time" content="2021-05-26T13:29:29.220Z">
<meta property="article:author" content="yrl">
<meta property="article:tag" content="elasticsearch">
<meta property="article:tag" content="elk">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yrlzero.gitee.io/2021/05/25/elasticsearch%EF%BC%88%E4%B8%83%EF%BC%89JAVA%20API/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>elasticsearch(七)-JAVA API | yrl's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">yrl's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yrlzero.gitee.io/2021/05/25/elasticsearch%EF%BC%88%E4%B8%83%EF%BC%89JAVA%20API/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="yrl">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yrl's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          elasticsearch(七)-JAVA API
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-25 22:12:05" itemprop="dateCreated datePublished" datetime="2021-05-25T22:12:05+08:00">2021-05-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-26 21:29:29" itemprop="dateModified" datetime="2021-05-26T21:29:29+08:00">2021-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/elasticsearch/" itemprop="url" rel="index"><span itemprop="name">elasticsearch</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="JAVA-API"><a href="#JAVA-API" class="headerlink" title="JAVA API"></a>JAVA API</h2><p><strong>Transport Client</strong>：TransportClient不推荐使用，而推荐使用Java High Level REST Client，并将在Elasticsearch 8.0中删除。<br><strong>Java Low Level REST Client</strong>：低级别的REST客户端，通过http与集群交互，用户需自己编组请求JSON串，及解析响应JSON串。兼容所有ES版本<br><strong>Java High Level REST Client</strong>：高级别的REST客户端，基于低级别的REST客户端，增加了编组请求JSON串、解析响应JSON串等相关api。使用的版本需要保持和ES服务端的版本一致，否则会有版本问题。</p>
<a id="more"></a>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--ES transport client--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>transport<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.12.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--high-level-client--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.12.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Transport-Client"><a href="#Transport-Client" class="headerlink" title="Transport Client"></a>Transport Client</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//配置集群名称</span></span><br><span class="line">    Settings settings = Settings.builder().put(<span class="string">"cluster.name"</span>, <span class="string">"elasticsearch"</span>).build();</span><br><span class="line">    <span class="comment">//创建连接</span></span><br><span class="line">    <span class="comment">//TransportClient client = new PreBuiltTransportClient(Settings.EMPTY)</span></span><br><span class="line">    TransportClient client = <span class="keyword">new</span> PreBuiltTransportClient(settings)</span><br><span class="line">        .addTransportAddress(<span class="keyword">new</span> TransportAddress(InetAddress.getByName(<span class="string">"localhost"</span>), <span class="number">9300</span>))<span class="comment">//通讯端口  而不是服务端口</span></span><br><span class="line">        .addTransportAddress(<span class="keyword">new</span> TransportAddress(InetAddress.getByName(<span class="string">"localhost"</span>), <span class="number">9301</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加数据</span></span><br><span class="line">    create(client);</span><br><span class="line">    <span class="comment">//关闭连接</span></span><br><span class="line">    client.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">(TransportClient client)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//查询数据</span></span><br><span class="line">    List&lt;Product&gt; list = service.list();</span><br><span class="line">    <span class="keyword">for</span> (Product item : list) &#123;</span><br><span class="line">       	<span class="comment">//固定语法</span></span><br><span class="line">        IndexResponse response = client.prepareIndex(<span class="string">"product2"</span>, <span class="string">"_doc"</span>, item.getId().toString())</span><br><span class="line">            .setSource(XContentFactory.jsonBuilder()</span><br><span class="line">                       .startObject()</span><br><span class="line">                       .field(<span class="string">"name"</span>, item.getName())</span><br><span class="line">                       .field(<span class="string">"desc"</span>, item.getDesc())</span><br><span class="line">                       .field(<span class="string">"price"</span>, item.getPrice())</span><br><span class="line">                       .field(<span class="string">"date"</span>, item.getCreateTime().toLocalDateTime().format(DateTimeFormatter.ofPattern(<span class="string">"yyyy-MM-dd"</span>)))</span><br><span class="line">                       .field(<span class="string">"tags"</span>, item.getTags().split(<span class="string">","</span>))</span><br><span class="line">                       .endObject())</span><br><span class="line">            .get();</span><br><span class="line">        System.out.println(response.getResult());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询一条数据</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">get</span><span class="params">(TransportClient client)</span> </span>&#123;</span><br><span class="line">    GetResponse response = client.prepareGet(<span class="string">"product"</span>, <span class="string">"_doc"</span>, <span class="string">"1"</span>).get();</span><br><span class="line">    String index = response.getIndex();<span class="comment">//获取索引名称</span></span><br><span class="line">    String type = response.getType();<span class="comment">//获取索引类型</span></span><br><span class="line">    String id = response.getId();<span class="comment">//获取索引id</span></span><br><span class="line">    System.out.println(<span class="string">"index:"</span> + index);</span><br><span class="line">    System.out.println(<span class="string">"type:"</span> + type);</span><br><span class="line">    System.out.println(<span class="string">"id:"</span> + id);</span><br><span class="line">    System.out.println(response.getSourceAsString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//批量查询</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getAll</span><span class="params">(TransportClient client)</span> </span>&#123;</span><br><span class="line">    SearchResponse response = client.prepareSearch(<span class="string">"product"</span>)</span><br><span class="line">        .get();</span><br><span class="line">    SearchHits searchHits = response.getHits();</span><br><span class="line">    SearchHit[] hits = searchHits.getHits();</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        String res = hit.getSourceAsString();</span><br><span class="line">        System.out.println(<span class="string">"res"</span> + res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//增量更新</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(TransportClient client)</span> </span>&#123;</span><br><span class="line">    UpdateResponse response = client.prepareUpdate(<span class="string">"product"</span>, <span class="string">"_doc"</span>, <span class="string">"2"</span>)</span><br><span class="line">        .setDoc(XContentFactory.jsonBuilder()</span><br><span class="line">                .startObject()</span><br><span class="line">                .field(<span class="string">"name"</span>, <span class="string">"update name"</span>)</span><br><span class="line">                .endObject())</span><br><span class="line">        .get();</span><br><span class="line">    System.out.println(response.getResult());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//删除数据</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(TransportClient client)</span> </span>&#123;</span><br><span class="line">    DeleteResponse response = client.prepareDelete(<span class="string">"product"</span>, <span class="string">"_doc"</span>, <span class="string">"2"</span>).get();</span><br><span class="line">    System.out.println(response.getResult());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//多条件查询</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">multiSearch</span><span class="params">(TransportClient client)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//SearchResponse：返回的结果集</span></span><br><span class="line">    SearchResponse response = client.prepareSearch(<span class="string">"product2"</span>)</span><br><span class="line">        .setQuery(QueryBuilders.termQuery(<span class="string">"name"</span>, <span class="string">"xiaomi"</span>))                 <span class="comment">// Query</span></span><br><span class="line">        .setPostFilter(QueryBuilders.rangeQuery(<span class="string">"price"</span>).from(<span class="number">0</span>).to(<span class="number">4000</span>))</span><br><span class="line">        .setFrom(<span class="number">1</span>).setSize(<span class="number">3</span>)</span><br><span class="line">        .get();</span><br><span class="line">    SearchHits searchHits = response.getHits();</span><br><span class="line">    SearchHit[] hits = searchHits.getHits();</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        String res = hit.getSourceAsString();</span><br><span class="line">        System.out.println(<span class="string">"res"</span> + res);</span><br><span class="line">    &#125;</span><br><span class="line">    client.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//统计每个月份的tags中每个词项term的平均价格</span></span><br><span class="line">GET /product/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">        <span class="attr">"group_by_month"</span>: &#123;</span><br><span class="line">            <span class="attr">"date_histogram"</span>: &#123;</span><br><span class="line">                <span class="attr">"field"</span>: <span class="string">"date"</span>,</span><br><span class="line">                <span class="attr">"calendar_interval"</span>: <span class="string">"month"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">                <span class="attr">"by_tags"</span>: &#123;</span><br><span class="line">                    <span class="attr">"terms"</span>: &#123;</span><br><span class="line">                        <span class="attr">"field"</span>: <span class="string">"tags.keyword"</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">                        <span class="attr">"avg_price"</span>: &#123;</span><br><span class="line">                            <span class="attr">"avg"</span>: &#123;</span><br><span class="line">                                <span class="attr">"field"</span>: <span class="string">"price"</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"size"</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询结果</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"aggregations"</span> : &#123;</span><br><span class="line">        <span class="attr">"group_by_month"</span> : &#123;</span><br><span class="line">            <span class="attr">"buckets"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"key_as_string"</span> : <span class="string">"2020-04-01T00:00:00.000Z"</span>,</span><br><span class="line">                    <span class="attr">"key"</span> : <span class="number">1585699200000</span>,</span><br><span class="line">                    <span class="attr">"doc_count"</span> : <span class="number">3</span>,</span><br><span class="line">                    <span class="attr">"by_tags"</span> : &#123;</span><br><span class="line">                        <span class="attr">"doc_count_error_upper_bound"</span> : <span class="number">0</span>,</span><br><span class="line">                        <span class="attr">"sum_other_doc_count"</span> : <span class="number">0</span>,</span><br><span class="line">                        <span class="attr">"buckets"</span> : [</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">"key"</span> : <span class="string">"bufangshui"</span>,</span><br><span class="line">                                <span class="attr">"doc_count"</span> : <span class="number">1</span>,</span><br><span class="line">                                <span class="attr">"avg_price"</span> : &#123;</span><br><span class="line">                                    <span class="attr">"value"</span> : <span class="number">999.0</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;,</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">"key"</span> : <span class="string">"fashao"</span>,</span><br><span class="line">                                <span class="attr">"doc_count"</span> : <span class="number">1</span>,</span><br><span class="line">                                <span class="attr">"avg_price"</span> : &#123;</span><br><span class="line">                                    <span class="attr">"value"</span> : <span class="number">2999.0</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"key_as_string"</span> : <span class="string">"2020-05-01T00:00:00.000Z"</span>,</span><br><span class="line">                    <span class="attr">"key"</span> : <span class="number">1588291200000</span>,</span><br><span class="line">                    <span class="attr">"doc_count"</span> : <span class="number">2</span>,</span><br><span class="line">                    <span class="attr">"by_tags"</span> : &#123;</span><br><span class="line">                        <span class="attr">"doc_count_error_upper_bound"</span> : <span class="number">0</span>,</span><br><span class="line">                        <span class="attr">"sum_other_doc_count"</span> : <span class="number">0</span>,</span><br><span class="line">                        <span class="attr">"buckets"</span> : [</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">"key"</span> : <span class="string">"fashao"</span>,</span><br><span class="line">                                <span class="attr">"doc_count"</span> : <span class="number">2</span>,</span><br><span class="line">                                <span class="attr">"avg_price"</span> : &#123;</span><br><span class="line">                                    <span class="attr">"value"</span> : <span class="number">4499.0</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;,</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">"key"</span> : <span class="string">"xingjiabi"</span>,</span><br><span class="line">                                <span class="attr">"doc_count"</span> : <span class="number">2</span>,</span><br><span class="line">                                <span class="attr">"avg_price"</span> : &#123;</span><br><span class="line">                                    <span class="attr">"value"</span> : <span class="number">4499.0</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过Java代码实现上面案例的聚合查询</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">aggSearch</span><span class="params">(TransportClient client)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//region 1-&gt;计算并返回聚合分析response对象</span></span><br><span class="line">    SearchResponse response = client.prepareSearch(<span class="string">"product"</span>)</span><br><span class="line">        .addAggregation(</span><br><span class="line">        AggregationBuilders.dateHistogram(<span class="string">"group_by_month"</span>)</span><br><span class="line">        .field(<span class="string">"date"</span>)</span><br><span class="line">        .calendarInterval(DateHistogramInterval.MONTH)</span><br><span class="line">        <span class="comment">//.dateHistogramInterval(DateHistogramInterval.MONTH)</span></span><br><span class="line">        .subAggregation(</span><br><span class="line">            AggregationBuilders</span><br><span class="line">            .terms(<span class="string">"by_tag"</span>)</span><br><span class="line">            .field(<span class="string">"tags.keyword"</span>)</span><br><span class="line">            .subAggregation(</span><br><span class="line">                AggregationBuilders</span><br><span class="line">                .avg(<span class="string">"avg_price"</span>)</span><br><span class="line">                .field(<span class="string">"price"</span>)</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">        .execute().actionGet();  <span class="comment">//执行查询</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//region 2-&gt;输出结果信息</span></span><br><span class="line">    SearchHit[] hits = response.getHits().getHits();</span><br><span class="line">    <span class="comment">//获取aggregations结果</span></span><br><span class="line">    Map&lt;String, Aggregation&gt; map = response.getAggregations().asMap();</span><br><span class="line">    <span class="comment">//获取group_by_month结果</span></span><br><span class="line">    Aggregation group_by_month = map.get(<span class="string">"group_by_month"</span>);</span><br><span class="line">    Histogram dates = (Histogram) group_by_month;</span><br><span class="line">    <span class="comment">//转换成分组的桶</span></span><br><span class="line">    Iterator&lt;Histogram.Bucket&gt; buckets = (Iterator&lt;Histogram.Bucket&gt;) dates.getBuckets().iterator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (buckets.hasNext()) &#123;</span><br><span class="line">        <span class="comment">//遍历桶中的数据</span></span><br><span class="line">        Histogram.Bucket dateBucket = buckets.next();</span><br><span class="line">        System.out.println(<span class="string">"\n\n月份："</span> + dateBucket.getKeyAsString() + <span class="string">"\n计数："</span> + dateBucket.getDocCount());</span><br><span class="line">        <span class="comment">//获取桶里面的桶by_tag</span></span><br><span class="line">        Aggregation group_by_tag = dateBucket.getAggregations().asMap().get(<span class="string">"by_tag"</span>);</span><br><span class="line">        StringTerms terms = (StringTerms) group_by_tag;</span><br><span class="line">        Iterator&lt;StringTerms.Bucket&gt; tagsBucket = terms.getBuckets().iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (tagsBucket.hasNext()) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//遍历by_tag桶，获取桶中的平均价格</span></span><br><span class="line">            StringTerms.Bucket tagBucket = tagsBucket.next();</span><br><span class="line">            System.out.println(<span class="string">"\t标签名称："</span> + tagBucket.getKey() + <span class="string">"\n\t数量："</span> + tagBucket.getDocCount());</span><br><span class="line">            Aggregation avg_price = tagBucket.getAggregations().get(<span class="string">"avg_price"</span>);</span><br><span class="line">            Avg avg = (Avg) avg_price;</span><br><span class="line">            System.out.println(<span class="string">"\t平均价格："</span> + avg.getValue() + <span class="string">"\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//endregion</span></span><br><span class="line"></span><br><span class="line">    client.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="High-Level-REST-Client"><a href="#High-Level-REST-Client" class="headerlink" title="High Level REST Client"></a>High Level REST Client</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">常见步骤：</span><br><span class="line">1.创建对应的Request对象</span><br><span class="line">2.创建对应的Builder对象&#x2F;编写对应操作</span><br><span class="line">3.Client执行对应的方法</span><br></pre></td></tr></table></figure>



<h4 id="创建连接"><a href="#创建连接" class="headerlink" title="创建连接"></a>创建连接</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用 RestHighLevelClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> createConnection &#123;</span><br><span class="line">    RestHighLevelClient client = <span class="keyword">new</span> RestHighLevelClient(</span><br><span class="line">        RestClient.builder(</span><br><span class="line">            <span class="keyword">new</span> HttpHost(<span class="string">"localhost"</span>, <span class="number">9200</span>, <span class="string">"http"</span>),</span><br><span class="line">            <span class="keyword">new</span> HttpHost(<span class="string">"localhost"</span>, <span class="number">9201</span>, <span class="string">"http"</span>)));  <span class="comment">//使用的是9200服务端口</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createIndex</span><span class="params">(RestHighLevelClient client)</span> </span>&#123;</span><br><span class="line">    CreateIndexRequest request = <span class="keyword">new</span> CreateIndexRequest(<span class="string">"test_index"</span>);</span><br><span class="line"></span><br><span class="line">    request.settings(Settings.builder()</span><br><span class="line">                     .put(<span class="string">"index.number_of_shards"</span>, <span class="number">3</span>)</span><br><span class="line">                     .put(<span class="string">"index.number_of_replicas"</span>, <span class="number">2</span>)</span><br><span class="line">                    );</span><br><span class="line">    CreateIndexResponse createIndexResponse = client.indices().create(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="keyword">if</span> (createIndexResponse.isAcknowledged()) &#123;</span><br><span class="line">        System.out.println(<span class="string">"创建index成功!"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"创建index失败!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    client.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="查询索引"><a href="#查询索引" class="headerlink" title="查询索引"></a>查询索引</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getIndex</span><span class="params">(RestHighLevelClient client)</span> </span>&#123;</span><br><span class="line">    GetIndexRequest request = <span class="keyword">new</span> GetIndexRequest(<span class="string">"test_index*"</span>);</span><br><span class="line">    GetIndexResponse response = client.indices().get(request, RequestOptions.DEFAULT);</span><br><span class="line">    String[] indices = response.getIndices();</span><br><span class="line">    <span class="keyword">for</span> (String indexName : indices) &#123;</span><br><span class="line">        System.out.println(<span class="string">"index name:"</span> + indexName);</span><br><span class="line">    &#125;</span><br><span class="line">    client.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delIndex</span><span class="params">(RestHighLevelClient client)</span> </span>&#123;</span><br><span class="line">    DeleteIndexRequest request = <span class="keyword">new</span> DeleteIndexRequest(<span class="string">"test_index"</span>);</span><br><span class="line">    AcknowledgedResponse response = client.indices().delete(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="keyword">if</span> (response.isAcknowledged()) &#123;</span><br><span class="line">        System.out.println(<span class="string">"删除index成功!"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"删除index失败!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    client.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertData</span><span class="params">(RestHighLevelClient client)</span> </span>&#123;</span><br><span class="line">    List&lt;Product&gt; list = service.list();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//插入数据，index不存在则自动根据匹配到的template创建。index没必要每天创建一个，如果是为了灵活管理，最低建议每月一个 yyyyMM。</span></span><br><span class="line">    IndexRequest request = <span class="keyword">new</span> IndexRequest(<span class="string">"test_index"</span>);</span><br><span class="line">    <span class="comment">//最好不要自定义id 会影响插入速度。</span></span><br><span class="line">    Product product = list.get(<span class="number">0</span>);</span><br><span class="line">    Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">    request.id(product.getId().toString());</span><br><span class="line">    request.source(gson.toJson(product), XContentType.JSON);</span><br><span class="line">    IndexResponse response = client.index(request, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(response);</span><br><span class="line">    client.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="批量插入"><a href="#批量插入" class="headerlink" title="批量插入"></a>批量插入</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">batchInsertData</span><span class="params">(RestHighLevelClient client)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//批量插入数据，更新和删除同理</span></span><br><span class="line">    BulkRequest request = <span class="keyword">new</span> BulkRequest(<span class="string">"test_index"</span>);</span><br><span class="line">    Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">    Product product = <span class="keyword">new</span> Product();</span><br><span class="line">    product.setPrice(<span class="number">3999.00</span>);</span><br><span class="line">    product.setDesc(<span class="string">"xioami"</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        product.setName(<span class="string">"name"</span> + i);</span><br><span class="line">        request.add(<span class="keyword">new</span> IndexRequest().source(gson.toJson(product), XContentType.JSON));</span><br><span class="line">    &#125;</span><br><span class="line">    BulkResponse response = client.bulk(request, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(<span class="string">"数量:"</span> + response.getItems().length);</span><br><span class="line">    client.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过ID查询数据</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getById</span><span class="params">(RestHighLevelClient client)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//注意 这里查询使用的是别名。</span></span><br><span class="line">    GetRequest request = <span class="keyword">new</span> GetRequest(<span class="string">"test_index"</span>, <span class="string">"PPWhwnIBRwX67j4bTmV1"</span>);</span><br><span class="line">    String[] includes = &#123;<span class="string">"name"</span>, <span class="string">"price"</span>&#125;;</span><br><span class="line">    String[] excludes = &#123;<span class="string">"desc"</span>&#125;;</span><br><span class="line">    FetchSourceContext fetchSourceContext = <span class="keyword">new</span> FetchSourceContext(<span class="keyword">true</span>, includes, excludes);</span><br><span class="line">    <span class="comment">//只查询特定字段。如果需要查询所有字段则不设置该项。</span></span><br><span class="line">    request.fetchSourceContext(fetchSourceContext);</span><br><span class="line">    GetResponse response = client.get(request, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(response);</span><br><span class="line">    client.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过ID删除数据</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delById</span><span class="params">(RestHighLevelClient client)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    DeleteRequest request = <span class="keyword">new</span> DeleteRequest(<span class="string">"test_index"</span>, <span class="string">"1"</span>);</span><br><span class="line">    DeleteResponse response = client.delete(request, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(response);</span><br><span class="line">    client.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="批量查询"><a href="#批量查询" class="headerlink" title="批量查询"></a>批量查询</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">multiGetById</span><span class="params">(RestHighLevelClient client)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//多个根据id查询</span></span><br><span class="line">    MultiGetRequest request = <span class="keyword">new</span> MultiGetRequest();</span><br><span class="line">    request.add(<span class="string">"test_index"</span>, <span class="string">"PPWhwnIBRwX67j4bTmV1"</span>);</span><br><span class="line">    <span class="comment">//两种写法</span></span><br><span class="line">    request.add(<span class="keyword">new</span> MultiGetRequest.Item(</span><br><span class="line">        <span class="string">"test_index"</span>,</span><br><span class="line">        <span class="string">"PfWhwnIBRwX67j4bTmV1"</span>));</span><br><span class="line">    MultiGetResponse response = client.mget(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="keyword">for</span> (MultiGetItemResponse itemResponse : response) &#123;</span><br><span class="line">        System.out.println(itemResponse.getResponse().getSourceAsString());</span><br><span class="line">    &#125;</span><br><span class="line">    client.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="查询更新"><a href="#查询更新" class="headerlink" title="查询更新"></a>查询更新</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//更新查询</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateByQuery</span><span class="params">(RestHighLevelClient client)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    UpdateByQueryRequest request = <span class="keyword">new</span> UpdateByQueryRequest(<span class="string">"test_index"</span>);</span><br><span class="line">    <span class="comment">//默认情况下，版本冲突会中止 UpdateByQueryRequest 进程，但是你可以用以下命令来代替</span></span><br><span class="line">    <span class="comment">//设置版本冲突继续</span></span><br><span class="line">    <span class="comment">//        request.setConflicts("proceed");</span></span><br><span class="line">    <span class="comment">//设置更新条件</span></span><br><span class="line">    request.setQuery(QueryBuilders.matchQuery(<span class="string">"name"</span>,<span class="string">"name1 name3"</span>));</span><br><span class="line">    <span class="comment">//        //限制更新条数</span></span><br><span class="line">    <span class="comment">//        request.setMaxDocs(10);</span></span><br><span class="line">    request.setScript(</span><br><span class="line">        <span class="keyword">new</span> Script(ScriptType.INLINE, <span class="string">"painless"</span>, <span class="string">"ctx._source.desc+='#';"</span>, Collections.emptyMap()));</span><br><span class="line">    BulkByScrollResponse response = client.updateByQuery(request,RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(response);</span><br><span class="line">    client.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="分页查询"><a href="#分页查询" class="headerlink" title="分页查询"></a>分页查询</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ResultDto <span class="title">carInfo</span><span class="params">(String keyword,Integer from,Integer size)</span> </span>&#123;</span><br><span class="line">    SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">"product"</span>);</span><br><span class="line">    </span><br><span class="line">    SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    searchSourceBuilder.query(QueryBuilders.matchQuery(<span class="string">"name"</span>, keyword));</span><br><span class="line">    searchSourceBuilder.from(from);</span><br><span class="line">    searchSourceBuilder.size(size);</span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line">    SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="comment">//ESClient.getInstance().closeClient();</span></span><br><span class="line">    </span><br><span class="line">    ResultDto res = <span class="keyword">new</span> ResultDto();</span><br><span class="line">    res.setData(searchResponse.getHits().getHits());</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Scroll查询"><a href="#Scroll查询" class="headerlink" title="Scroll查询"></a>Scroll查询</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ResultDto <span class="title">scroll</span><span class="params">(String scrollId)</span> </span>&#123;</span><br><span class="line">    SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">"product"</span>);</span><br><span class="line">    SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    searchSourceBuilder.size(<span class="number">2</span>); <span class="comment">//每页两条</span></span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">    searchRequest.scroll(TimeValue.timeValueMinutes(<span class="number">1L</span>));  <span class="comment">//scrollID的有效期1分钟</span></span><br><span class="line"></span><br><span class="line">    SearchResponse searchResponse = scrollId == <span class="keyword">null</span></span><br><span class="line">        ? client.search(searchRequest, RequestOptions.DEFAULT)</span><br><span class="line">        : client.scroll(<span class="keyword">new</span> SearchScrollRequest(scrollId), RequestOptions.DEFAULT);</span><br><span class="line">    scrollId = searchResponse.getScrollId();</span><br><span class="line">    SearchHits hits = searchResponse.getHits();</span><br><span class="line">    </span><br><span class="line">    ResultDto res = <span class="keyword">new</span> ResultDto();</span><br><span class="line">    res.setTag(scrollId);</span><br><span class="line">    res.setData(hits.getHits());</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="批量操作"><a href="#批量操作" class="headerlink" title="批量操作"></a>批量操作</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ResultDto <span class="title">bulk</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">"msb_auto"</span>);</span><br><span class="line">    BulkRequest request = <span class="keyword">new</span> BulkRequest();</span><br><span class="line">    request.add(<span class="keyword">new</span> DeleteRequest(<span class="string">"product"</span>, <span class="string">"13"</span>));  <span class="comment">//删除doc</span></span><br><span class="line">    request.add(<span class="keyword">new</span> UpdateRequest(<span class="string">"product"</span>, <span class="string">"22"</span>)</span><br><span class="line">                .doc(XContentType.JSON, <span class="string">"name"</span>, <span class="string">"天籁之音"</span>));  <span class="comment">//修改doc一个字段</span></span><br><span class="line">    request.add(<span class="keyword">new</span> IndexRequest(<span class="string">"product"</span>).id(<span class="string">"4"</span>)</span><br><span class="line">                .source(XContentType.JSON, <span class="string">"myname"</span>, <span class="string">"天津一汽"</span>)); <span class="comment">//修改整doc</span></span><br><span class="line">    BulkResponse bulkResponse = client.bulk(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="搜索模板"><a href="#搜索模板" class="headerlink" title="搜索模板"></a>搜索模板</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ResultDto <span class="title">templateSearch</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//region 创建模板并缓存 作用域为整个集群</span></span><br><span class="line">    Request scriptRequest = <span class="keyword">new</span> Request(<span class="string">"POST"</span>, <span class="string">"_scripts/test_template_search"</span>);</span><br><span class="line">    scriptRequest.setJsonEntity(</span><br><span class="line">        <span class="string">"&#123;"</span> +</span><br><span class="line">        <span class="string">"  \"script\": &#123;"</span> +</span><br><span class="line">        <span class="string">"    \"lang\": \"mustache\","</span> +</span><br><span class="line">        <span class="string">"    \"source\": &#123;"</span> +</span><br><span class="line">        <span class="string">"      \"query\": &#123; \"match\" : &#123; \"&#123;&#123;field&#125;&#125;\" : \"&#123;&#123;value&#125;&#125;\" &#125; &#125;,"</span> +</span><br><span class="line">        <span class="string">"      \"size\" : \"&#123;&#123;size&#125;&#125;\""</span> +</span><br><span class="line">        <span class="string">"    &#125;"</span> +</span><br><span class="line">        <span class="string">"  &#125;"</span> +</span><br><span class="line">        <span class="string">"&#125;"</span>);</span><br><span class="line">    Response scriptResponse = client.getLowLevelClient().performRequest(scriptRequest);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    SearchTemplateRequest request = <span class="keyword">new</span> SearchTemplateRequest();</span><br><span class="line">    request.setRequest(<span class="keyword">new</span> SearchRequest(<span class="string">"msb_auto"</span>));</span><br><span class="line">    <span class="comment">//STORED 保存到内存模板</span></span><br><span class="line">    request.setScriptType(ScriptType.STORED);</span><br><span class="line">    request.setScript(<span class="string">"test_template_search"</span>);</span><br><span class="line">    <span class="comment">// 本地模板</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment">//request.setScriptType(ScriptType.INLINE);</span></span><br><span class="line">    <span class="comment">//    request.setScript(</span></span><br><span class="line">    <span class="comment">//                    "&#123;\n" +</span></span><br><span class="line">    <span class="comment">//                    "  \"from\": &#123;&#123;from&#125;&#125;,\n" +</span></span><br><span class="line">    <span class="comment">//                    "  \"size\": &#123;&#123;size&#125;&#125;,\n" +</span></span><br><span class="line">    <span class="comment">//                    "  \"query\": &#123;\n" +</span></span><br><span class="line">    <span class="comment">//                    "    \"match\": &#123;\n" +</span></span><br><span class="line">    <span class="comment">//                    "      \"master_brand_name\": \"&#123;&#123;master_brand_name&#125;&#125;\"\n" +</span></span><br><span class="line">    <span class="comment">//                    "    &#125;\n" +</span></span><br><span class="line">    <span class="comment">//                    "  &#125;\n" +</span></span><br><span class="line">    <span class="comment">//                    "&#125;");</span></span><br><span class="line">    </span><br><span class="line">    Map&lt;String, Object&gt; scriptParams = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    scriptParams.put(<span class="string">"field"</span>, <span class="string">"master_brand_name"</span>);</span><br><span class="line">    scriptParams.put(<span class="string">"value"</span>, <span class="string">"一汽"</span>);</span><br><span class="line">    scriptParams.put(<span class="string">"size"</span>, <span class="number">5</span>);</span><br><span class="line">    request.setScriptParams(scriptParams);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//查询</span></span><br><span class="line">    SearchTemplateResponse response = client.searchTemplate(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="模糊查询"><a href="#模糊查询" class="headerlink" title="模糊查询"></a>模糊查询</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> SearchHit[] fuzzy(String name) &#123;</span><br><span class="line">    SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">"product"</span>);</span><br><span class="line">    SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    searchSourceBuilder.query(QueryBuilders.fuzzyQuery(<span class="string">"brand_name.keyword"</span>, name).fuzziness(Fuzziness.AUTO));</span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line">    SearchResponse response = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="keyword">return</span> response.getHits().getHits();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="多语句查询"><a href="#多语句查询" class="headerlink" title="多语句查询"></a>多语句查询</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ResultDto <span class="title">multiSearch</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1.创建一个空的MultiSearchRequest</span></span><br><span class="line">    MultiSearchRequest request = <span class="keyword">new</span> MultiSearchRequest();</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//2.创建SearchRequest,并填充查询条件</span></span><br><span class="line">    SearchRequest firstSearchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">"product"</span>);</span><br><span class="line">    SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    searchSourceBuilder.query(QueryBuilders.matchQuery(<span class="string">"series_name"</span>, <span class="string">"朗动"</span>));</span><br><span class="line">    firstSearchRequest.source(searchSourceBuilder);</span><br><span class="line">    <span class="comment">//3.将SearchRequest装配到MultiSearchRequest中</span></span><br><span class="line">    request.add(firstSearchRequest);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//4.创建第二个SearchRequest并重复第三步</span></span><br><span class="line">    SearchRequest secondSearchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">"product"</span>);</span><br><span class="line">    searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    searchSourceBuilder.query(QueryBuilders.matchQuery(<span class="string">"series_name"</span>, <span class="string">"揽胜运动"</span>));</span><br><span class="line">    secondSearchRequest.source(searchSourceBuilder);</span><br><span class="line">    request.add(secondSearchRequest);</span><br><span class="line"></span><br><span class="line">    MultiSearchResponse response = client.msearch(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Bool查询"><a href="#Bool查询" class="headerlink" title="Bool查询"></a>Bool查询</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ResultDto <span class="title">boolSearch</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    MultiSearchRequest request = <span class="keyword">new</span> MultiSearchRequest();</span><br><span class="line"></span><br><span class="line">    SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">"product"</span>);</span><br><span class="line">    SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    searchSourceBuilder.query</span><br><span class="line">        (</span><br><span class="line">        QueryBuilders.boolQuery()</span><br><span class="line">        .must(matchPhraseQuery(<span class="string">"sale_name"</span>, <span class="string">"2018款"</span>))</span><br><span class="line">        .filter(matchQuery(<span class="string">"master_brand_name"</span>, <span class="string">"大众"</span>).analyzer(<span class="string">"ik_max_word"</span>))</span><br><span class="line">        .mustNot(matchQuery(<span class="string">"series_name"</span>, <span class="string">"速腾"</span>))</span><br><span class="line">    );</span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line">    request.add(searchRequest);</span><br><span class="line">    MultiSearchResponse response = client.msearch(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Sniffer-嗅探器"><a href="#Sniffer-嗅探器" class="headerlink" title="Sniffer 嗅探器"></a>Sniffer 嗅探器</h2><p>概念：从运行中的Elasticsearch集群自动发现节点并将它们设置为现有RestClient实例（low实例）。</p>
<p>版本：从ES 2.X开始及更高版本支持。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-client-sniffer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.12.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.12.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">用法：</span><br><span class="line">1.创建RestClient：RestClientBuilder</span><br><span class="line">2.HTTPS支持：NodesSniffer</span><br><span class="line">3.绑定：Sniffer.builder(RestClient)</span><br><span class="line">4.监听：SniffOnFailureListener</span><br><span class="line"></span><br><span class="line">相关设置参数：</span><br><span class="line">1.setSniffIntervalMillis：每隔多久触发一次嗅探，单位毫秒，默认30000（5分钟）。</span><br><span class="line">2.setSniffAfterFailureDelayMillis：嗅探失败时触发嗅探一次,经过设置的时间（默认1min）之后再次嗅探直至正常。若无绑定监听器则无效。</span><br><span class="line">3.setFailureListener：设置用于监听嗅探失败的监听器，当监听到普通嗅探失败，则通知Sniffer实例进行新一轮的嗅探，并更新节点。</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ESClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ESClient ESClient;</span><br><span class="line">    <span class="keyword">private</span> String host = <span class="string">"localhost:9200,localhost:9201"</span>;</span><br><span class="line">    <span class="keyword">private</span> RestClientBuilder builder;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Sniffer sniffer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> RestHighLevelClient highClient;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ESClient</span><span class="params">()</span></span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ESClient <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ESClient == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (ESClient<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (ESClient == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    ESClient = <span class="keyword">new</span> ESClient();</span><br><span class="line">                    ESClient.initBuilder();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ESClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestClientBuilder <span class="title">initBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String[] hosts = host.split(<span class="string">","</span>);</span><br><span class="line">        HttpHost[] httpHosts = <span class="keyword">new</span> HttpHost[hosts.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; hosts.length; i++) &#123;</span><br><span class="line">            String[] host = hosts[i].split(<span class="string">":"</span>);</span><br><span class="line">            httpHosts[i] = <span class="keyword">new</span> HttpHost(host[<span class="number">0</span>], Integer.parseInt(host[<span class="number">1</span>]), <span class="string">"http"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        builder = RestClient.builder(httpHosts);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//region 在Builder中设置请求头</span></span><br><span class="line">        <span class="comment">//  1.设置请求头</span></span><br><span class="line">        Header[] defaultHeaders = <span class="keyword">new</span> Header[]&#123;</span><br><span class="line">            <span class="keyword">new</span> BasicHeader(<span class="string">"Content-Type"</span>, <span class="string">"application/json"</span>)</span><br><span class="line">        &#125;;</span><br><span class="line">        builder.setDefaultHeaders(defaultHeaders);</span><br><span class="line">        <span class="comment">//endregion</span></span><br><span class="line">        <span class="comment">//RestClient restClient = builder.build();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//启用嗅探器</span></span><br><span class="line">        <span class="comment">//SniffOnFailureListener sniffOnFailureListener = new SniffOnFailureListener();</span></span><br><span class="line">        <span class="comment">//builder.setFailureListener(sniffOnFailureListener);</span></span><br><span class="line">        <span class="comment">//sniffer = Sniffer.builder(restClient)</span></span><br><span class="line">        <span class="comment">//        .setSniffIntervalMillis(5000)</span></span><br><span class="line">        <span class="comment">//        .setSniffAfterFailureDelayMillis(10000)</span></span><br><span class="line">        <span class="comment">//        .build();</span></span><br><span class="line">        <span class="comment">//sniffOnFailureListener.setSniffer(sniffer);</span></span><br><span class="line">        <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestHighLevelClient <span class="title">getHighLevelClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (highClient == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (ESClient<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (highClient == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//gighClient是通过lowClient包装产生的</span></span><br><span class="line">                    highClient = <span class="keyword">new</span> RestHighLevelClient(builder);</span><br><span class="line">                    <span class="comment">//设置嗅探器</span></span><br><span class="line">                    <span class="comment">//十秒刷新并更新一次节点</span></span><br><span class="line">                    sniffer = Sniffer.builder(highClient.getLowLevelClient())</span><br><span class="line">                        .setSniffIntervalMillis(<span class="number">5000</span>)</span><br><span class="line">                        .setSniffAfterFailureDelayMillis(<span class="number">15000</span>)</span><br><span class="line">                        .build();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> highClient;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 关闭sniffer client</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != highClient) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sniffer.close();    <span class="comment">//需要在highClient close之前操作</span></span><br><span class="line">                highClient.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">snifferTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RestHighLevelClient client = ESClient.getInstance().getHighLevelClient();</span><br><span class="line">    Iterator&lt;Node&gt; nodes = client.getLowLevelClient().getNodes().iterator();</span><br><span class="line">    <span class="keyword">while</span> (nodes.hasNext()) &#123;</span><br><span class="line">        Node node = nodes.next();</span><br><span class="line">        System.out.println(node);</span><br><span class="line">    &#125;</span><br><span class="line">    Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">    System.out.println(<span class="string">"5秒后:"</span>);</span><br><span class="line">    nodes = client.getLowLevelClient().getNodes().iterator();</span><br><span class="line">    <span class="keyword">while</span> (nodes.hasNext()) &#123;</span><br><span class="line">        Node node = nodes.next();</span><br><span class="line">        System.out.println(node);</span><br><span class="line">    &#125;</span><br><span class="line">    ESClient.getInstance().closeClient();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>假设有5台机器，IP分别是【9200 - 9204】最后嗅探造成的输出结果是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">先输出:</span><br><span class="line">host&#x3D;[http:&#x2F;&#x2F;localhost:9200]</span><br><span class="line">host&#x3D;[http:&#x2F;&#x2F;localhost:9201]</span><br><span class="line">间隔五秒后输出：</span><br><span class="line">host&#x3D;[http:&#x2F;&#x2F;localhost:9200]</span><br><span class="line">host&#x3D;[http:&#x2F;&#x2F;localhost:9201]</span><br><span class="line">host&#x3D;[http:&#x2F;&#x2F;localhost:9202]</span><br><span class="line">host&#x3D;[http:&#x2F;&#x2F;localhost:9203]</span><br><span class="line">host&#x3D;[http:&#x2F;&#x2F;localhost:9204]</span><br></pre></td></tr></table></figure>

<p><strong>嗅探器它能够给我们监控动态更新集群的节点数量，避免了程序因节点过多或增加/减少节点造成的切换问题。</strong></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/elasticsearch/" rel="tag"># elasticsearch</a>
              <a href="/tags/elk/" rel="tag"># elk</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/05/25/elasticsearch%EF%BC%88%E5%85%AD%EF%BC%89%E5%89%8D%E7%BC%80%E3%80%81%E9%80%9A%E9%85%8D%E7%AC%A6%E3%80%81%E6%AD%A3%E5%88%99%E3%80%81%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2/" rel="prev" title="elasticsearch(六)-前缀、通配符、正则、模糊查询">
      <i class="fa fa-chevron-left"></i> elasticsearch(六)-前缀、通配符、正则、模糊查询
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/05/26/elasticsearch%EF%BC%88%E5%85%AB%EF%BC%89%E9%9B%86%E7%BE%A4/" rel="next" title="elasticsearch(八)-集群">
      elasticsearch(八)-集群 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#JAVA-API"><span class="nav-text">JAVA API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Transport-Client"><span class="nav-text">Transport Client</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#High-Level-REST-Client"><span class="nav-text">High Level REST Client</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建连接"><span class="nav-text">创建连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建索引"><span class="nav-text">创建索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查询索引"><span class="nav-text">查询索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#删除索引"><span class="nav-text">删除索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#插入数据"><span class="nav-text">插入数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#批量插入"><span class="nav-text">批量插入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查询数据"><span class="nav-text">查询数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#删除数据"><span class="nav-text">删除数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#批量查询"><span class="nav-text">批量查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查询更新"><span class="nav-text">查询更新</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分页查询"><span class="nav-text">分页查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Scroll查询"><span class="nav-text">Scroll查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#批量操作"><span class="nav-text">批量操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#搜索模板"><span class="nav-text">搜索模板</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#模糊查询"><span class="nav-text">模糊查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#多语句查询"><span class="nav-text">多语句查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Bool查询"><span class="nav-text">Bool查询</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sniffer-嗅探器"><span class="nav-text">Sniffer 嗅探器</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yrl"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">yrl</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">55</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yrl</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  
</body>
</html>
