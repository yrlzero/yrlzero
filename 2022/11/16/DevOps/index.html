<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yrlzero.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="一、DevOps介绍DevOps，字面意思是Development &amp;Operations的缩写，也就是开发&amp;运维。 虽然字面意思只涉及到了开发团队和运维团队，其实QA测试团队也是参与其中的。 强调的是高效组织团队之间如何通过自动化的工具协作和沟通来完成软件的生命周期管理，从而更快、更频繁地交付更稳定的软件。">
<meta property="og:type" content="article">
<meta property="og:title" content="DevOps-CICD">
<meta property="og:url" content="http://yrlzero.github.io/2022/11/16/DevOps/index.html">
<meta property="og:site_name" content="yrl&#39;s blog">
<meta property="og:description" content="一、DevOps介绍DevOps，字面意思是Development &amp;Operations的缩写，也就是开发&amp;运维。 虽然字面意思只涉及到了开发团队和运维团队，其实QA测试团队也是参与其中的。 强调的是高效组织团队之间如何通过自动化的工具协作和沟通来完成软件的生命周期管理，从而更快、更频繁地交付更稳定的软件。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/devops%E5%B7%A5%E5%85%B7.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/GitLab.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E5%88%9D%E5%A7%8B%E5%AF%86%E7%A0%81.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E7%99%BB%E5%BD%95%E6%88%90%E5%8A%9F%E5%90%8E%E8%B7%B3%E8%BD%AC%E9%A1%B5%E9%9D%A2.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E4%BF%AE%E6%94%B9%E5%AF%86%E7%A0%81.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/CI%E3%80%81CD.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/Jenkins%E9%A6%96%E9%A1%B5.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E7%99%BB%E5%BD%95%E5%B9%B6%E4%B8%8B%E8%BD%BD%E6%8F%92%E4%BB%B6.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E7%99%BB%E5%BD%95%E5%B9%B6%E4%B8%8B%E8%BD%BD%E6%8F%92%E4%BB%B62.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%8F%92%E4%BB%B61.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%8F%92%E4%BB%B62.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%8F%92%E4%BB%B63.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%88%AA%E5%9B%BE28.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%88%AA%E5%9B%BE29.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%88%AA%E5%9B%BE30.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/GitLab%E6%9F%A5%E7%9C%8B%E9%A1%B9%E7%9B%AE.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%96%B0%E5%BB%BA%E4%BB%BB%E5%8A%A1.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%9E%84%E5%BB%BA%E4%BB%BB%E5%8A%A1-1668584979544.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%BA%90%E7%A0%81%E7%AE%A1%E7%90%86.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E7%82%B9%E5%87%BB%E4%BB%BB%E5%8A%A1test%E4%B8%AD%E7%9A%84%E7%AB%8B%E5%8D%B3%E6%9E%84%E5%BB%BA.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%9F%A5%E7%9C%8B%E4%BB%BB%E5%8A%A1%E6%8B%89%E5%8F%96Git%E6%BA%90%E7%A0%81%E6%97%A5%E5%BF%97.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%BA%90%E7%A0%81%E5%AD%98%E6%94%BE%E4%BD%8D%E7%BD%AE-1668585165864.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%95%B0%E6%8D%AE%E5%8D%B7%E5%AD%98%E6%94%BE%E4%BD%8D%E7%BD%AE.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/jdk.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/maven.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E9%85%8D%E7%BD%AEMaven%E6%9E%84%E5%BB%BA%E4%BB%A3%E7%A0%81.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E9%85%8D%E7%BD%AEMaven%E6%9E%84%E5%BB%BA%E4%BB%A3%E7%A0%812-1668585555375.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%9E%84%E5%BB%BA%E6%BA%90%E7%A0%81.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%9E%84%E5%BB%BA%E6%BA%90%E7%A0%812.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E9%85%8D%E7%BD%AE%E6%9E%84%E5%BB%BA%E5%90%8E%E6%93%8D%E4%BD%9C.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E9%85%8D%E7%BD%AE%E6%9E%84%E5%BB%BA%E5%90%8E%E6%93%8D%E4%BD%9C2.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E9%85%8D%E7%BD%AE%E6%9E%84%E5%BB%BA%E5%90%8E%E6%93%8D%E4%BD%9C3.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E7%AB%8B%E5%8D%B3%E6%9E%84%E5%BB%BA.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E7%AB%8B%E5%8D%B3%E6%9E%84%E5%BB%BA2-1668585831545.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%9E%84%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E9%95%9C%E5%83%8F.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E5%8A%A0%E8%BD%BD%E8%87%AA%E5%AE%9A%E4%B9%89%E9%95%9C%E5%83%8F%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%9E%84%E5%BB%BA%E5%90%8E%E5%8F%91%E5%B8%83%E5%B9%B6%E6%89%A7%E8%A1%8C%E8%84%9A%E6%9C%AC%E5%91%BD%E4%BB%A4.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%9E%84%E5%BB%BA%E6%97%A5%E5%BF%97.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%9F%A5%E7%9C%8B%E7%9B%AE%E6%A0%87%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B9%B6%E6%B5%8B%E8%AF%95%E6%8E%A5%E5%8F%A3.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%9F%A5%E7%9C%8B%E7%9B%AE%E6%A0%87%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B9%B6%E6%B5%8B%E8%AF%95%E6%8E%A5%E5%8F%A32.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E5%9F%BA%E4%BA%8EGit%E6%A0%87%E7%AD%BE%E6%9E%84%E5%BB%BA.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E5%9F%BA%E4%BA%8EGit%E6%A0%87%E7%AD%BE%E6%9E%84%E5%BB%BA2.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%B7%BB%E5%8A%A0tag%E7%89%88%E6%9C%AC.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E5%88%87%E6%8D%A2%E6%8C%87%E5%AE%9A%E6%A0%87%E7%AD%BE%E5%B9%B6%E6%9E%84%E5%BB%BA%E9%A1%B9%E7%9B%AE.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E8%AE%BE%E7%BD%AEvm.max_map_count.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E8%AE%BE%E7%BD%AEvm.max_map_count2.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E5%AE%B9%E5%99%A8%E6%97%A5%E5%BF%97.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E7%99%BB%E5%BD%95.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E9%87%8D%E6%96%B0%E8%AE%BE%E7%BD%AE%E5%AF%86%E7%A0%81.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E5%AE%89%E8%A3%85%E4%B8%AD%E6%96%87%E6%8F%92%E4%BB%B6.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E9%87%8D%E5%90%AF%E6%8C%89%E9%92%AE.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E9%A6%96%E9%A1%B5%E6%95%88%E6%9E%9C.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%89%A7%E8%A1%8C%E4%BB%A3%E7%A0%81%E6%A3%80%E6%B5%8B.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E9%85%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BF%A1%E6%81%AF.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97%E4%BF%A1%E6%81%AF.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%A3%80%E6%B5%8B%E7%BB%93%E6%9E%9C.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E8%8E%B7%E5%8F%96%E4%BB%A4%E7%89%8C.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E9%85%8D%E7%BD%AESonar-scanner.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E9%85%8D%E7%BD%AE%E4%BB%BB%E5%8A%A1%E7%9A%84Sonar-scanner.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%9E%84%E5%BB%BA%E4%BB%BB%E5%8A%A1-1668587838774.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%9E%84%E5%BB%BA%E4%BB%BB%E5%8A%A12.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E9%85%8D%E7%BD%AEHarbor%E6%96%87%E4%BB%B6.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/harbor%E6%97%A5%E5%BF%97.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E7%99%BB%E5%BD%95Harbor.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/harbor%E9%A6%96%E9%A1%B5%E4%BF%A1%E6%81%AF.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/harbor%E6%9E%84%E5%BB%BA%E9%A1%B9%E7%9B%AE.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E8%BF%BD%E5%8A%A0%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E5%88%87%E6%8D%A2%E6%B5%8B%E8%AF%95%E7%94%A8%E6%88%B7.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E4%BF%AE%E6%94%B9%E9%95%9C%E5%83%8F%E5%90%8D%E7%A7%B0.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E4%BF%AE%E6%94%B9daemon.json%EF%BC%8C%E6%94%AF%E6%8C%81Docker%E4%BB%93%E5%BA%93.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%8E%A8%E9%80%81%E9%95%9C%E5%83%8F%E5%88%B0Harbor.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%8E%A8%E9%80%81%E9%95%9C%E5%83%8F%E5%88%B0Harbor2.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/harbor%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/harbor%E5%88%B6%E4%BD%9C%E8%87%AA%E5%AE%9A%E4%B9%89%E9%95%9C%E5%83%8F.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E8%AE%BE%E7%BD%AE%E6%9D%83%E9%99%90%E4%B8%BA%E5%8F%AF%E6%89%A7%E8%A1%8C.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%89%A7%E8%A1%8C%E8%84%9A%E6%9C%AC%E6%96%87%E4%BB%B6.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%9E%84%E5%BB%BAJenkins%E6%B5%81%E6%B0%B4%E7%BA%BF%E4%BB%BB%E5%8A%A1.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%9E%84%E5%BB%BA%E5%90%8E%E6%9F%A5%E7%9C%8B%E8%A7%86%E5%9B%BE.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E9%85%8D%E7%BD%AEGrovvy%E8%84%9A%E6%9C%AC.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%9F%A5%E7%9C%8B%E6%95%88%E6%9E%9C.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E7%94%9F%E6%88%90%E5%91%BD%E4%BB%A4%E4%BD%8D%E7%BD%AE.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E9%85%8D%E7%BD%AEpipeline.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E5%87%86%E5%A4%87Jenkinsfile%E6%96%87%E4%BB%B6.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%B5%8B%E8%AF%95%E6%95%88%E6%9E%9C.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/Git%E5%8F%82%E6%95%B0%E5%8C%96%E6%9E%84%E5%BB%BA.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E8%AF%AD%E6%B3%95%E7%94%9F%E6%88%90.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E8%AF%AD%E6%B3%95%E7%94%9F%E6%88%902.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E9%92%89%E9%92%89%E5%AE%89%E8%A3%85%E6%8F%92%E4%BB%B6.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E9%92%89%E9%92%89%E5%86%85%E9%83%A8%E5%88%9B%E5%BB%BA%E7%BE%A4%E7%BB%84%E5%B9%B6%E6%9E%84%E5%BB%BA%E6%9C%BA%E5%99%A8%E4%BA%BA.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E9%85%8D%E7%BD%AE%E9%92%89%E9%92%89%E9%80%9A%E7%9F%A5.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/kubernetes%E6%9E%B6%E6%9E%84.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E5%AE%89%E8%A3%85%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E8%8E%B7%E5%8F%96%E5%91%BD%E4%BB%A4.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%90%AD%E5%BB%BA%E6%88%90%E5%8A%9F%E6%95%88%E6%9E%9C.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/kuboard%E6%9F%A5%E7%9C%8B%E6%95%88%E6%9E%9C.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/kuboard%E9%A6%96%E9%A1%B5.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/kuboard%E9%A6%96%E9%A1%B5%E6%95%88%E6%9E%9C.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/Kuboard%E6%95%88%E6%9E%9C.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E5%9B%BE%E5%BD%A2%E5%8C%96%E9%A1%B5%E9%9D%A2%E4%BF%AE%E6%94%B9.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E5%9C%A8%E6%9C%8D%E5%8A%A1%E5%AE%B9%E5%99%A8%E5%86%85%E6%89%A7%E8%A1%8C.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%9F%A5%E7%9C%8BService%E6%95%88%E6%9E%9C.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/Ingress1.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/Ingress2.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/Ingress3.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E5%90%AF%E5%8A%A8%E6%97%B6%E9%97%AE%E9%A2%98.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E5%88%A0%E9%99%A4ingress%E7%9A%84%E6%A0%A1%E9%AA%8C%E4%BF%A1%E6%81%AF.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/jenkins-%E8%AE%BE%E7%BD%AEHarbor%E7%A7%81%E6%9C%8D%E5%9C%B0%E5%9D%80.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/Kuboard%E4%B8%8A%E8%AE%BE%E7%BD%AE%E7%A7%81%E6%9C%8D%E5%AF%86%E6%96%87%E4%BF%A1%E6%81%AF.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E5%A4%8D%E5%88%B6%E6%8C%87%E4%BB%A4%E7%9A%84%E4%BD%8D%E7%BD%AE%E6%B5%8B%E8%AF%95%E8%AE%A4%E8%AF%81.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/pipeline.yml%E9%85%8D%E7%BD%AE%E5%88%B0Gitlab.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E8%AE%BE%E7%BD%AE%E7%9B%AE%E6%A0%87%E6%9C%8D%E5%8A%A1%E5%99%A8.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E4%BC%A0%E9%80%92yml%E6%96%87%E4%BB%B6%E8%84%9A%E6%9C%AC.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E4%BC%A0%E9%80%92yml%E6%96%87%E4%BB%B6%E8%84%9A%E6%9C%AC2.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E8%BF%9C%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E6%97%A0%E9%9C%80%E5%AF%86%E7%A0%81.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E8%AE%BE%E7%BD%AEJenkinsfile.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%89%A7%E8%A1%8C%E6%B5%81%E6%B0%B4%E7%BA%BF.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%9E%84%E5%BB%BA%E8%A7%A6%E5%8F%91%E5%99%A8.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E8%AE%BE%E7%BD%AEGitlab%E7%9A%84Webhooks.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E5%85%B3%E9%97%ADJenkins%E7%9A%84Gitlab%E8%AE%A4%E8%AF%81.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E5%86%8D%E6%AC%A1%E6%B5%8B%E8%AF%95Gitlab.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B01.png">
<meta property="og:image" content="http://yrlzero.github.io/images/DevOps/%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B02.png">
<meta property="article:published_time" content="2022-11-16T07:00:22.468Z">
<meta property="article:modified_time" content="2022-11-16T14:17:25.688Z">
<meta property="article:author" content="yrl">
<meta property="article:tag" content="devops">
<meta property="article:tag" content="docker">
<meta property="article:tag" content="gitlab">
<meta property="article:tag" content="jenkins">
<meta property="article:tag" content="K8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yrlzero.github.io/images/DevOps/devops%E5%B7%A5%E5%85%B7.png">

<link rel="canonical" href="http://yrlzero.github.io/2022/11/16/DevOps/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>DevOps-CICD | yrl's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">yrl's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yrlzero.github.io/2022/11/16/DevOps/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="yrl">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yrl's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          DevOps-CICD
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-11-16 15:00:22 / 修改时间：22:17:25" itemprop="dateCreated datePublished" datetime="2022-11-16T15:00:22+08:00">2022-11-16</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/devops/" itemprop="url" rel="index"><span itemprop="name">devops</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/devops/cicd/" itemprop="url" rel="index"><span itemprop="name">cicd</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="一、DevOps介绍"><a href="#一、DevOps介绍" class="headerlink" title="一、DevOps介绍"></a>一、DevOps介绍</h1><p><strong>DevOps</strong>，字面意思是<strong>Development &amp;Operations</strong>的缩写，也就是开发&amp;运维。</p>
<p>虽然字面意思只涉及到了开发团队和运维团队，其实QA测试团队也是参与其中的。</p>
<p>强调的是高效组织团队之间如何通过自动化的工具协作和沟通来完成软件的生命周期管理，从而更快、更频繁地交付更稳定的软件。</p>
<img src="/images/DevOps/devops工具.png"  style="zoom:80%;" />

<a id="more"></a>

<p>如图所示，<strong>DevOps</strong>符号类似于一个无穷大的符号，代表一个不断提高效率并且持续不断工作的过程。</p>
<p><strong>DevOps</strong>的方式可以让公司能够更快地应对更新和市场发展变化，开发可以快速交付，部署也更加稳定。</p>
<p>核心就在于简化Dev和Ops团队之间的流程，使整体软件开发过程更快速。</p>
<p>整体的软件开发流程包括：</p>
<ul>
<li>PLAN：开发团队根据客户的目标制定开发计划</li>
<li>CODE：根据PLAN开始编码过程，需要将不同版本的代码存储在一个库中。</li>
<li>BUILD：编码完成后，需要将代码构建并且运行。</li>
<li>TEST：成功构建项目后，需要测试代码是否存在BUG或错误。</li>
<li>DEPLOY：代码经过手动测试和自动化测试后，认定代码已经准备好部署并且交给运维团队。</li>
<li>OPERATE：运维团队将代码部署到生产环境中。</li>
<li>MONITOR：项目部署上线后，需要持续的监控产品。</li>
<li>INTEGRATE：然后将监控阶段收到的反馈发送回PLAN阶段，整体反复的流程就是<strong>DevOps</strong>的核心，即持续集成、持续部署。</li>
</ul>
<p>为了保证整体流程可以高效的完成，各个阶段都有比较常见的工具，如下图：</p>
<h1 id="二、Code阶段工具"><a href="#二、Code阶段工具" class="headerlink" title="二、Code阶段工具"></a>二、Code阶段工具</h1><p>在code阶段，我们需要将不同版本的代码存储到一个仓库中，常见的版本控制工具就是SVN或者Git，这里我们采用Git作为版本控制工具，GitLab作为远程仓库。</p>
<h2 id="2-1-Git安装"><a href="#2-1-Git安装" class="headerlink" title="2.1 Git安装"></a>2.1 Git安装</h2><p><a href="https://git-scm.com/（傻瓜式安装）" target="_blank" rel="noopener">https://git-scm.com/（傻瓜式安装）</a></p>
<h2 id="2-2-GitLab安装"><a href="#2-2-GitLab安装" class="headerlink" title="2.2 GitLab安装"></a>2.2 GitLab安装</h2><p>单独准备服务器，采用Docker安装</p>
<ul>
<li><p>查看GitLab镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker search gitlab</span><br></pre></td></tr></table></figure>
</li>
<li><p>拉取GitLab镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull gitlab/gitlab-ce</span><br></pre></td></tr></table></figure>
</li>
<li><p>准备docker-compose.yml文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">'3.1'</span></span><br><span class="line">services:</span><br><span class="line">  gitlab:</span><br><span class="line">    image: <span class="string">'gitlab/gitlab-ce:latest'</span></span><br><span class="line">    container_name: gitlab</span><br><span class="line">    restart: always</span><br><span class="line">    environment:</span><br><span class="line">      GITLAB_OMNIBUS_CONFIG: |</span><br><span class="line">        external_url <span class="string">'http://192.168.11.11:8929'</span></span><br><span class="line">        gitlab_rails[<span class="string">'gitlab_shell_ssh_port'</span>] = 2224</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">'8929:8929'</span></span><br><span class="line">      - <span class="string">'2224:2224'</span></span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="string">'./config:/etc/gitlab'</span></span><br><span class="line">      - <span class="string">'./logs:/var/log/gitlab'</span></span><br><span class="line">      - <span class="string">'./data:/var/opt/gitlab'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问GitLab首页</p>
<img src="/images/DevOps/GitLab.png"  style="zoom:67%;" />
</li>
<li><p>查看root用户初始密码</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it gitlab cat /etc/gitlab/initial_root_password</span><br></pre></td></tr></table></figure>

<img src="/images/DevOps/初始密码.png"  style="zoom:50%;" />
</li>
<li><p>登录root用户</p>
</li>
</ul>
<img src="/images/DevOps/登录成功后跳转页面.png"  style="zoom:50%;" />

<ul>
<li><p>修改密码</p>
<img src="/images/DevOps/修改密码.png"  style="zoom:50%;" />

</li>
</ul>
<h1 id="三、Build阶段工具"><a href="#三、Build阶段工具" class="headerlink" title="三、Build阶段工具"></a>三、Build阶段工具</h1><p>构建Java项目的工具一般有两种选择，一个是Maven，一个是Gradle。</p>
<p>这里我们选择Maven作为项目的编译工具。</p>
<p>具体安装Maven流程不做阐述，但是需要确保配置好Maven仓库私服以及JDK编译版本。</p>
<h1 id="四、Operate阶段工具"><a href="#四、Operate阶段工具" class="headerlink" title="四、Operate阶段工具"></a>四、Operate阶段工具</h1><p>部署过程，会采用Docker进行部署，暂时只安装Docker即可，后续还需安装Kubenetes</p>
<h2 id="4-1-Docker安装"><a href="#4-1-Docker安装" class="headerlink" title="4.1 Docker安装"></a>4.1 Docker安装</h2><ul>
<li><p>准备测试环境&amp;生产环境</p>
</li>
<li><p>下载Docker依赖组件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install yum-utils device-mapper-persistent-data lvm2</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置下载Docker的镜像源为阿里云</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Docker服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install docker-ce</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装成功后，启动Docker并设置开机自启</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动Docker服务</span></span><br><span class="line">systemctl start docker</span><br><span class="line"><span class="comment"># 设置开机自动启动</span></span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试安装成功</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker version</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="4-2-Docker-Compose安装"><a href="#4-2-Docker-Compose安装" class="headerlink" title="4.2 Docker-Compose安装"></a>4.2 Docker-Compose安装</h2><ul>
<li><p>下载Docker/Compose：<a href="https://github.com/docker/compose" target="_blank" rel="noopener">https://github.com/docker/compose</a></p>
</li>
<li><p>将下载好的<a href="">docker-compose-Linux-x86_64</a>文件移动到Linux操作系统：……</p>
</li>
<li><p>设置<a href="">docker-compose-Linux-x86_64</a>文件权限，并移动到$PATH目录中</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置文件权限</span></span><br><span class="line">chmod a+x docker-compose-Linux-x86_64</span><br><span class="line"><span class="comment"># 移动到/usr/bin目录下，并重命名为docker-compose</span></span><br><span class="line">mv docker-compose-Linux-x86_64 /usr/bin/docker-compose</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试安装成功</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose version</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h1 id="五、Integrate工具"><a href="#五、Integrate工具" class="headerlink" title="五、Integrate工具"></a>五、Integrate工具</h1><p>持续集成、持续部署的工具很多，其中Jenkins是一个开源的持续集成平台。</p>
<p>Jenkins涉及到将编写完毕的代码发布到测试环境和生产环境的任务，并且还涉及到了构建项目等任务。</p>
<p>Jenkins需要大量的插件保证工作，安装成本较高，下面会基于Docker搭建Jenkins。</p>
<h2 id="5-1-Jenkins介绍"><a href="#5-1-Jenkins介绍" class="headerlink" title="5.1 Jenkins介绍"></a>5.1 Jenkins介绍</h2><p>Jenkins是一个开源软件项目，是基于Java开发的一种持续集成工具</p>
<p>Jenkins应用广泛，大多数互联网公司都采用Jenkins配合GitLab、Docker、K8s作为实现<strong>DevOps</strong>]的核心工具。</p>
<p>Jenkins最强大的就在于插件，Jenkins官方提供了大量的插件库，来自动化CI/CD过程中的各种琐碎功能。</p>
<p>Jenkins最主要的工作就是将GitLab上可以构建的工程代码拉取并且进行构建，再根据流程可以选择发布到测试环境或是生产环境。</p>
<p>一般是GitLab上的代码经过大量的测试后，确定发行版本，再发布到生产环境。</p>
<p>CI/CD可以理解为：</p>
<ul>
<li>CI过程即是通过Jenkins将代码拉取、构建、制作镜像交给测试人员测试。<ul>
<li>持续集成：让软件代码可以持续的集成到主干上，并自动构建和测试。</li>
</ul>
</li>
<li>CD过程即是通过Jenkins将打好标签的发行版本代码拉取、构建、制作镜像交给运维人员部署。<ul>
<li>持续交付：让经过持续集成的代码可以进行手动部署。</li>
<li>持续部署：让可以持续交付的代码随时随地的自动化部署。</li>
</ul>
</li>
</ul>
<p><img src="/images/DevOps/CI%E3%80%81CD.png" alt=""></p>
<h2 id="5-2-Jenkins安装"><a href="#5-2-Jenkins安装" class="headerlink" title="5.2 Jenkins安装"></a>5.2 Jenkins安装</h2><ul>
<li><p>拉取Jenkins镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull jenkins/jenkins</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写docker-compose.yml</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">"3.1"</span></span><br><span class="line">services:</span><br><span class="line">  jenkins:</span><br><span class="line">    image: jenkins/jenkins</span><br><span class="line">    container_name: jenkins</span><br><span class="line">    ports:</span><br><span class="line">      - 8080:8080</span><br><span class="line">      - 50000:50000</span><br><span class="line">    volumes:</span><br><span class="line">      - ./data/:/var/jenkins_home/</span><br></pre></td></tr></table></figure>
</li>
<li><p>首次启动会因为数据卷data目录没有权限导致启动失败，设置data目录写权限</p>
<p><code>chmod -R a+w data/</code></p>
</li>
<li><p>由于默认下载地址下载速度较慢，需要设置下载地址为国内镜像站</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改数据卷中的hudson.model.UpdateCenter.xml文件</span></span><br><span class="line">&lt;?xml version=<span class="string">'1.1'</span> encoding=<span class="string">'UTF-8'</span>?&gt;</span><br><span class="line">&lt;sites&gt;</span><br><span class="line">  &lt;site&gt;</span><br><span class="line">    &lt;id&gt;default&lt;/id&gt;</span><br><span class="line">    &lt;url&gt;https://updates.jenkins.io/update-center.json&lt;/url&gt;</span><br><span class="line">  &lt;/site&gt;</span><br><span class="line">&lt;/sites&gt;</span><br><span class="line"><span class="comment"># 将下载地址替换为http://mirror.esuni.jp/jenkins/updates/update-center.json</span></span><br><span class="line">&lt;?xml version=<span class="string">'1.1'</span> encoding=<span class="string">'UTF-8'</span>?&gt;</span><br><span class="line">&lt;sites&gt;</span><br><span class="line">  &lt;site&gt;</span><br><span class="line">    &lt;id&gt;default&lt;/id&gt;</span><br><span class="line">    &lt;url&gt;http://mirror.esuni.jp/jenkins/updates/update-center.json&lt;/url&gt;</span><br><span class="line">  &lt;/site&gt;</span><br><span class="line">&lt;/sites&gt;</span><br><span class="line"><span class="comment"># 清华大学的插件源也可以https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>再次重启Jenkins容器，访问Jenkins</p>
<img src="/images/DevOps/Jenkins首页.png"  style="zoom:67%;" />
</li>
<li><p>查看密码登录Jenkins，并登录下载插件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it jenkins cat /var/jenkins_home/secrets/initialAdminPassword</span><br></pre></td></tr></table></figure>

<img src="/images/DevOps/登录并下载插件.png"  style="zoom:67%;" />

</li>
</ul>
<img src="/images/DevOps/登录并下载插件2.png"  style="zoom:67%;" />

<ul>
<li>选择需要安装的插件</li>
</ul>
<p><img src="/images/DevOps/%E6%8F%92%E4%BB%B61.png" alt=""></p>
<p><img src="/images/DevOps/%E6%8F%92%E4%BB%B62.png" alt=""></p>
<p><img src="/images/DevOps/%E6%8F%92%E4%BB%B63.png" alt=""></p>
<ul>
<li>下载完毕设置信息进入首页（可能会出现下载失败的插件）</li>
</ul>
<p><img src="/images/DevOps/%E6%88%AA%E5%9B%BE28.png" alt=""></p>
<p><img src="/images/DevOps/%E6%88%AA%E5%9B%BE29.png" alt=""></p>
<p><img src="/images/DevOps/%E6%88%AA%E5%9B%BE30.png" alt=""></p>
<h2 id="5-3-Jenkins入门配置"><a href="#5-3-Jenkins入门配置" class="headerlink" title="5.3 Jenkins入门配置"></a>5.3 Jenkins入门配置</h2><p>由于Jenkins需要从Git拉取代码、需要本地构建、甚至需要直接发布自定义镜像到Docker仓库，所以Jenkins需要配置大量内容。</p>
<h3 id="5-3-1-构建任务"><a href="#5-3-1-构建任务" class="headerlink" title="5.3.1 构建任务"></a>5.3.1 构建任务</h3><p>准备好GitLab仓库中的项目，并且通过Jenkins配置项目的实现当前项目的DevOps基本流程。</p>
<ul>
<li><p>构建Maven工程发布到GitLab（Gitee、Github均可）</p>
<p><img src="/images/DevOps/GitLab%E6%9F%A5%E7%9C%8B%E9%A1%B9%E7%9B%AE.png" alt=""></p>
</li>
<li><p>Jenkins点击左侧导航新建任务</p>
<p><img src="/images/DevOps/%E6%96%B0%E5%BB%BA%E4%BB%BB%E5%8A%A1.png" alt=""></p>
</li>
<li><p>选择自由风格构建任务</p>
<p><img src="/images/DevOps/%E6%9E%84%E5%BB%BA%E4%BB%BB%E5%8A%A1-1668584979544.png" alt=""></p>
</li>
</ul>
<h3 id="5-3-2-配置源码拉取地址"><a href="#5-3-2-配置源码拉取地址" class="headerlink" title="5.3.2 配置源码拉取地址"></a>5.3.2 配置源码拉取地址</h3><p>Jenkins需要将Git上存放的源码存储到Jenkins服务所在磁盘的本地</p>
<ul>
<li><p>配置任务源码拉取的地址</p>
<p><img src="/images/DevOps/%E6%BA%90%E7%A0%81%E7%AE%A1%E7%90%86.png" alt=""></p>
</li>
<li><p>Jenkins立即构建</p>
<p><img src="/images/DevOps/%E7%82%B9%E5%87%BB%E4%BB%BB%E5%8A%A1test%E4%B8%AD%E7%9A%84%E7%AB%8B%E5%8D%B3%E6%9E%84%E5%BB%BA.png" alt=""></p>
</li>
<li><p>查看构建工程的日志，点击上述③的任务条即可</p>
<p><img src="/images/DevOps/%E6%9F%A5%E7%9C%8B%E4%BB%BB%E5%8A%A1%E6%8B%89%E5%8F%96Git%E6%BA%90%E7%A0%81%E6%97%A5%E5%BF%97.png" alt=""></p>
<p>可以看到源码已经拉取带Jenkins本地，可以根据第三行日志信息，查看Jenkins本地拉取到的源码。</p>
</li>
<li><p>查看Jenkins容器中<a href="">/var/jenkins_home/workspace/test</a>的源码</p>
<p><img src="/images/DevOps/%E6%BA%90%E7%A0%81%E5%AD%98%E6%94%BE%E4%BD%8D%E7%BD%AE-1668585165864.png" alt=""></p>
</li>
</ul>
<h3 id="5-3-3-配置Maven构建代码"><a href="#5-3-3-配置Maven构建代码" class="headerlink" title="5.3.3 配置Maven构建代码"></a>5.3.3 配置Maven构建代码</h3><p>代码拉取到Jenkins本地后，需要在Jenkins中对代码进行构建，这里需要Maven的环境，而Maven需要Java的环境，接下来需要在Jenkins中安装JDK和Maven，并且配置到Jenkins服务。</p>
<ul>
<li><p>准备JDK、Maven压缩包通过数据卷映射到Jenkins容器内部</p>
<p><img src="/images/DevOps/%E6%95%B0%E6%8D%AE%E5%8D%B7%E5%AD%98%E6%94%BE%E4%BD%8D%E7%BD%AE.png" alt=""></p>
</li>
<li><p>解压压缩包，并配置Maven的settings.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 阿里云镜像地址 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>          </span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- JDK1.8编译插件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>jdk-1.8<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jdk</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">jdk</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.compilerVersion</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.compilerVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span>        </span><br><span class="line"><span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Jenkins配置JDK&amp;Maven并保存</p>
<p><img src="/images/DevOps/jdk.png" alt=""></p>
</li>
</ul>
<p><img src="/images/DevOps/maven.png" alt=""></p>
<ul>
<li><p>配置Jenkins任务构建代码</p>
<p><img src="/images/DevOps/%E9%85%8D%E7%BD%AEMaven%E6%9E%84%E5%BB%BA%E4%BB%A3%E7%A0%81.png" alt=""></p>
<p><img src="/images/DevOps/%E9%85%8D%E7%BD%AEMaven%E6%9E%84%E5%BB%BA%E4%BB%A3%E7%A0%812-1668585555375.png" alt=""></p>
</li>
<li><p>立即构建测试，查看target下的jar包</p>
<p><img src="/images/DevOps/%E6%9E%84%E5%BB%BA%E6%BA%90%E7%A0%81.png" alt=""></p>
</li>
</ul>
<p><img src="/images/DevOps/%E6%9E%84%E5%BB%BA%E6%BA%90%E7%A0%812.png" alt=""></p>
<h3 id="5-3-4-配置Publish发布-amp-远程操作"><a href="#5-3-4-配置Publish发布-amp-远程操作" class="headerlink" title="5.3.4 配置Publish发布&amp;远程操作"></a>5.3.4 配置Publish发布&amp;远程操作</h3><p>jar包构建好之后，就可以根据情况发布到测试或生产环境，这里需要用到之前下载好的插件Publish Over SSH。</p>
<ul>
<li><p>配置Publish Over SSH连接测试、生产环境</p>
<p>![](/images/DevOps/Publish Over SSH配置.png)</p>
</li>
<li><p>配置任务的构建后操作，发布jar包到目标服务</p>
<p><img src="/images/DevOps/%E9%85%8D%E7%BD%AE%E6%9E%84%E5%BB%BA%E5%90%8E%E6%93%8D%E4%BD%9C.png" alt="配置构建后操作"></p>
<p><img src="/images/DevOps/%E9%85%8D%E7%BD%AE%E6%9E%84%E5%BB%BA%E5%90%8E%E6%93%8D%E4%BD%9C2.png" alt=""></p>
<p><img src="/images/DevOps/%E9%85%8D%E7%BD%AE%E6%9E%84%E5%BB%BA%E5%90%8E%E6%93%8D%E4%BD%9C3.png" alt=""></p>
</li>
<li><p>立即构建任务，并去目标服务查看</p>
<img src="/images/DevOps/立即构建.png"  style="zoom:67%;" />

<img src="/images/DevOps/立即构建2-1668585831545.png"  style="zoom:67%;" />

</li>
</ul>
<h1 id="六、CI、CD入门操作"><a href="#六、CI、CD入门操作" class="headerlink" title="六、CI、CD入门操作"></a>六、CI、CD入门操作</h1><p>基于Jenkins拉取GitLab的SpringBoot代码进行构建发布到测试环境实现持续集成</p>
<p>基于Jenkins拉取GitLab指定发行版本的SpringBoot代码进行构建发布到生产环境实现CD实现持续部署</p>
<h2 id="6-1-持续集成"><a href="#6-1-持续集成" class="headerlink" title="6.1 持续集成"></a>6.1 持续集成</h2><p>为了让程序代码可以自动推送到测试环境基于Docker服务运行，需要添加Docker配置和脚本文件让程序可以在集成到主干的同时运行起来。</p>
<ul>
<li><p>添加Dockerfile文件</p>
<p><img src="/images/DevOps/%E6%9E%84%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E9%95%9C%E5%83%8F.png" alt=""></p>
</li>
<li><p>添加docker-compose.yml文件</p>
<p><img src="/images/DevOps/%E5%8A%A0%E8%BD%BD%E8%87%AA%E5%AE%9A%E4%B9%89%E9%95%9C%E5%83%8F%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8.png" alt=""></p>
</li>
<li><p>追加Jenkins构建后操作脚本命令</p>
<p><img src="/images/DevOps/%E6%9E%84%E5%BB%BA%E5%90%8E%E5%8F%91%E5%B8%83%E5%B9%B6%E6%89%A7%E8%A1%8C%E8%84%9A%E6%9C%AC%E5%91%BD%E4%BB%A4.png" alt=""></p>
</li>
<li><p>发布到GitLab后由Jenkins立即构建并托送到目标服务器</p>
<p><img src="/images/DevOps/%E6%9E%84%E5%BB%BA%E6%97%A5%E5%BF%97.png" alt=""></p>
</li>
<li><p>测试部署到目标服务器程序</p>
<p><img src="/images/DevOps/%E6%9F%A5%E7%9C%8B%E7%9B%AE%E6%A0%87%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B9%B6%E6%B5%8B%E8%AF%95%E6%8E%A5%E5%8F%A3.png" alt=""></p>
<p><img src="/images/DevOps/%E6%9F%A5%E7%9C%8B%E7%9B%AE%E6%A0%87%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B9%B6%E6%B5%8B%E8%AF%95%E6%8E%A5%E5%8F%A32.png" alt="查看目标服务器并测试接口2"></p>
</li>
</ul>
<h2 id="6-2-持续交付、部署"><a href="#6-2-持续交付、部署" class="headerlink" title="6.2 持续交付、部署"></a>6.2 持续交付、部署</h2><p>程序代码在经过多次集成操作到达最终可以交付，持续交付整体流程和持续集成类似，不过需要选取指定的发行版本</p>
<ul>
<li><p>下载Git Parameter插件</p>
<p>![](/images/DevOps/下载Git Parameter.png)</p>
</li>
<li><p>设置项目参数化构建</p>
<p><img src="/images/DevOps/%E5%9F%BA%E4%BA%8EGit%E6%A0%87%E7%AD%BE%E6%9E%84%E5%BB%BA.png" alt=""></p>
<p><img src="/images/DevOps/%E5%9F%BA%E4%BA%8EGit%E6%A0%87%E7%AD%BE%E6%9E%84%E5%BB%BA2.png" alt=""></p>
</li>
<li><p>给项目添加tag版本</p>
<p><img src="/images/DevOps/%E6%B7%BB%E5%8A%A0tag%E7%89%88%E6%9C%AC.png" alt=""></p>
</li>
<li><p>任务构建时，采用Shell方式构建，拉取指定tag版本代码</p>
<p><img src="/images/DevOps/%E5%88%87%E6%8D%A2%E6%8C%87%E5%AE%9A%E6%A0%87%E7%AD%BE%E5%B9%B6%E6%9E%84%E5%BB%BA%E9%A1%B9%E7%9B%AE.png" alt=""></p>
</li>
</ul>
<h1 id="七、集成Sonar-Qube"><a href="#七、集成Sonar-Qube" class="headerlink" title="七、集成Sonar Qube"></a>七、集成Sonar Qube</h1><h2 id="7-1-Sonar-Qube介绍"><a href="#7-1-Sonar-Qube介绍" class="headerlink" title="7.1 Sonar Qube介绍"></a>7.1 Sonar Qube介绍</h2><p>Sonar Qube是一个开源的代码分析平台，支持Java、Python、PHP、JavaScript、CSS等25种以上的语言，可以检测出重复代码、代码漏洞、代码规范和安全性漏洞的问题。</p>
<p>Sonar Qube可以与多种软件整合进行代码扫描，比如Maven，Gradle，Git，Jenkins等，并且会将代码检测结果推送回Sonar Qube并且在系统提供的UI界面上显示出来</p>
<p>![](/images/DevOps/Sonar Qube的UI界面.png)</p>
<h2 id="7-2-Sonar-Qube环境搭建"><a href="#7-2-Sonar-Qube环境搭建" class="headerlink" title="7.2 Sonar Qube环境搭建"></a>7.2 Sonar Qube环境搭建</h2><h3 id="7-2-1-Sonar-Qube安装"><a href="#7-2-1-Sonar-Qube安装" class="headerlink" title="7.2.1 Sonar Qube安装"></a>7.2.1 Sonar Qube安装</h3><p>onar Qube在7.9版本中已经放弃了对MySQL的支持，并且建议在商业环境中采用PostgreSQL，那么安装Sonar Qube时需要依赖PostgreSQL。</p>
<p>并且这里会安装Sonar Qube的长期支持版本8.9</p>
<ul>
<li><p>拉取镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull postgres</span><br><span class="line">docker pull sonarqube:8.9.3-community</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写docker-compoe.yml</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">"3.1"</span></span><br><span class="line">services:</span><br><span class="line">  db:</span><br><span class="line">    image: postgres</span><br><span class="line">    container_name: db</span><br><span class="line">    ports:</span><br><span class="line">      - 5432:5432</span><br><span class="line">    networks:</span><br><span class="line">      - sonarnet</span><br><span class="line">    environment:</span><br><span class="line">      POSTGRES_USER: sonar</span><br><span class="line">      POSTGRES_PASSWORD: sonar</span><br><span class="line">  sonarqube:</span><br><span class="line">    image: sonarqube:8.9.3-community</span><br><span class="line">    container_name: sonarqube</span><br><span class="line">    depends_on:</span><br><span class="line">      - db</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">"9000:9000"</span></span><br><span class="line">    networks:</span><br><span class="line">      - sonarnet</span><br><span class="line">    environment:</span><br><span class="line">      SONAR_JDBC_URL: jdbc:postgresql://db:5432/sonar</span><br><span class="line">      SONAR_JDBC_USERNAME: sonar</span><br><span class="line">      SONAR_JDBC_PASSWORD: sonar</span><br><span class="line">networks:</span><br><span class="line">  sonarnet:</span><br><span class="line">    driver: bridge</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动失败，需要设置sysctl.conf文件信息</p>
<p><img src="/images/DevOps/%E8%AE%BE%E7%BD%AEvm.max_map_count.png" alt=""></p>
<p><img src="/images/DevOps/%E8%AE%BE%E7%BD%AEvm.max_map_count2.png" alt=""></p>
<p>并执行命令刷新</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>
</li>
<li><p>重新启动需要一定时间启动，可以可以查看容器日志，看到如下内容代表启动成功</p>
<p><img src="/images/DevOps/%E5%AE%B9%E5%99%A8%E6%97%A5%E5%BF%97.png" alt=""></p>
</li>
<li><p>访问Sonar Qube首页</p>
<p><img src="/images/DevOps/%E7%99%BB%E5%BD%95.png" alt=""></p>
</li>
<li><p>还需要重新设置一次密码</p>
<p><img src="/images/DevOps/%E9%87%8D%E6%96%B0%E8%AE%BE%E7%BD%AE%E5%AF%86%E7%A0%81.png" alt=""></p>
</li>
<li><p>Sonar Qube首页</p>
<p>![](/images/DevOps/Sonar Qube首页.png)</p>
</li>
</ul>
<h3 id="7-2-2-安装中文插件"><a href="#7-2-2-安装中文插件" class="headerlink" title="7.2.2 安装中文插件"></a>7.2.2 安装中文插件</h3><p>​    <img src="/images/DevOps/%E5%AE%89%E8%A3%85%E4%B8%AD%E6%96%87%E6%8F%92%E4%BB%B6.png" alt=""></p>
<p>安装成功后需要重启，安装失败重新点击install重装即可。</p>
<p>安装成功后，会查看到重启按钮，点击即可</p>
<p><img src="/images/DevOps/%E9%87%8D%E5%90%AF%E6%8C%89%E9%92%AE.png" alt=""></p>
<p>重启后查看效果</p>
<p><img src="/images/DevOps/%E9%A6%96%E9%A1%B5%E6%95%88%E6%9E%9C.png" alt=""></p>
<h2 id="7-3-Sonar-Qube基本使用"><a href="#7-3-Sonar-Qube基本使用" class="headerlink" title="7.3 Sonar Qube基本使用"></a>7.3 Sonar Qube基本使用</h2><p>Sonar Qube的使用方式很多，Maven可以整合，也可以采用sonar-scanner的方式，再查看Sonar Qube的检测效果</p>
<h3 id="7-3-1-Maven实现代码检测"><a href="#7-3-1-Maven实现代码检测" class="headerlink" title="7.3.1 Maven实现代码检测"></a>7.3.1 Maven实现代码检测</h3><ul>
<li><p>修改Maven的settings.xml文件配置Sonar Qube信息</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>sonar<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sonar.login</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">sonar.login</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sonar.password</span>&gt;</span>123456789<span class="tag">&lt;/<span class="name">sonar.password</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sonar.host.url</span>&gt;</span>http://192.168.11.11:9000<span class="tag">&lt;/<span class="name">sonar.host.url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在代码位置执行命令：mvn sonar:sonar</p>
<p><img src="/images/DevOps/%E6%89%A7%E8%A1%8C%E4%BB%A3%E7%A0%81%E6%A3%80%E6%B5%8B.png" alt=""></p>
</li>
<li><p>查看Sonar Qube界面检测结果</p>
<p>![](/images/DevOps/Sonar Qube检测结果.png)</p>
</li>
</ul>
<h3 id="7-3-2-Sonar-scanner实现代码检测"><a href="#7-3-2-Sonar-scanner实现代码检测" class="headerlink" title="7.3.2 Sonar-scanner实现代码检测"></a>7.3.2 Sonar-scanner实现代码检测</h3><ul>
<li><p>下载Sonar-scanner：<a href="https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/" target="_blank" rel="noopener">https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/</a></p>
<p>下载4.6.x版本即可，要求Linux版本</p>
</li>
<li><p>解压并配置sonar服务端信息</p>
<ul>
<li><p>由于是zip压缩包，需要安装unzip解压插件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install unzip</span><br></pre></td></tr></table></figure>
</li>
<li><p>解压压缩包</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip sonar-scanner-cli/sonar-scanner-cli-4.6.0.2311-linux.zip</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置sonarQube服务端地址，修改conf下的sonar-scanner.properties</p>
<p><img src="/images/DevOps/%E9%85%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BF%A1%E6%81%AF.png" alt=""></p>
</li>
</ul>
</li>
<li><p>执行命令检测代码</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在项目所在目录执行以下命令</span></span><br><span class="line">~/sonar-scanner/bin/sonar-scanner -Dsonar.sources=./ -Dsonar.projectname=demo -Dsonar.projectKey=java -Dsonar.java.binaries=target/</span><br></pre></td></tr></table></figure>

<p><img src="/images/DevOps/%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97%E4%BF%A1%E6%81%AF.png" alt=""></p>
</li>
<li><p>查看SonarQube界面检测结果</p>
<p><img src="/images/DevOps/%E6%A3%80%E6%B5%8B%E7%BB%93%E6%9E%9C.png" alt=""></p>
</li>
</ul>
<h2 id="7-4-Jenkins集成Sonar-Qube"><a href="#7-4-Jenkins集成Sonar-Qube" class="headerlink" title="7.4 Jenkins集成Sonar Qube"></a>7.4 Jenkins集成Sonar Qube</h2><p>Jenkins继承Sonar Qube实现代码扫描需要先下载整合插件</p>
<h3 id="7-4-1-Jenkins安装插件"><a href="#7-4-1-Jenkins安装插件" class="headerlink" title="7.4.1 Jenkins安装插件"></a>7.4.1 Jenkins安装插件</h3><p>![](/images/DevOps/下载Sonar Qube插件.png)</p>
<p>![](/images/DevOps/下载Sonar Qube插件2.png)</p>
<p>![](/images/DevOps/下载Sonar Qube插件3.png)</p>
<h3 id="7-4-2-Jenkins配置Sonar-Qube"><a href="#7-4-2-Jenkins配置Sonar-Qube" class="headerlink" title="7.4.2 Jenkins配置Sonar Qube"></a>7.4.2 Jenkins配置Sonar Qube</h3><ul>
<li><p>开启Sonar Qube权限验证</p>
<p>![](/images/DevOps/开启Sonar Qube权限校验.png)</p>
</li>
<li><p>获取Sonar Qube的令牌</p>
<p><img src="/images/DevOps/%E8%8E%B7%E5%8F%96%E4%BB%A4%E7%89%8C.png" alt=""></p>
</li>
<li><p>配置Jenkins的Sonar Qube信息</p>
<p>![](/images/DevOps/配置Jenkins的Sonar Qube信息1.png)</p>
<p>![](/images/DevOps/配置Jenkins的Sonar Qube信息2.png)</p>
<p>![](/images/DevOps/配置Jenkins的Sonar Qube信息3.png)</p>
</li>
</ul>
<h3 id="7-4-3-配置Sonar-scanner"><a href="#7-4-3-配置Sonar-scanner" class="headerlink" title="7.4.3 配置Sonar-scanner"></a>7.4.3 配置Sonar-scanner</h3><ul>
<li><p>将Sonar-scaner添加到Jenkins数据卷中并配置全局配置</p>
<p><img src="/images/DevOps/%E9%85%8D%E7%BD%AESonar-scanner.png" alt=""></p>
</li>
<li><p>配置任务的Sonar-scanner</p>
<p><img src="/images/DevOps/%E9%85%8D%E7%BD%AE%E4%BB%BB%E5%8A%A1%E7%9A%84Sonar-scanner.png" alt=""></p>
</li>
</ul>
<h3 id="7-4-4-构建任务"><a href="#7-4-4-构建任务" class="headerlink" title="7.4.4 构建任务"></a>7.4.4 构建任务</h3><p>​    <img src="/images/DevOps/%E6%9E%84%E5%BB%BA%E4%BB%BB%E5%8A%A1-1668587838774.png" alt=""></p>
<p>​    <img src="/images/DevOps/%E6%9E%84%E5%BB%BA%E4%BB%BB%E5%8A%A12.png" alt=""></p>
<h1 id="八、集成Harbor"><a href="#八、集成Harbor" class="headerlink" title="八、集成Harbor"></a>八、集成Harbor</h1><h2 id="8-1-Harbor介绍"><a href="#8-1-Harbor介绍" class="headerlink" title="8.1 Harbor介绍"></a>8.1 Harbor介绍</h2><p>前面在部署项目时，我们主要采用Jenkins推送jar包到指定服务器，再通过脚本命令让目标服务器对当前jar进行部署，这种方式在项目较多时，每个目标服务器都需要将jar包制作成自定义镜像再通过docker进行启动，重复操作比较多，会降低项目部署时间。</p>
<p>我们可以通过Harbor作为私有的Docker镜像仓库。让Jenkins统一将项目打包并制作成Docker镜像发布到Harbor仓库中，只需要通知目标服务，让目标服务统一去Harbor仓库上拉取镜像并在本地部署即可。</p>
<p>Docker官方提供了Registry镜像仓库，但是Registry的功能相对简陋。Harbor是VMware公司提供的一款镜像仓库，提供了权限控制、分布式发布、强大的安全扫描与审查机制等功能</p>
<h2 id="8-2-Harbor安装"><a href="#8-2-Harbor安装" class="headerlink" title="8.2 Harbor安装"></a>8.2 Harbor安装</h2><p>这里采用原生的方式安装Harbor。</p>
<ul>
<li><p>下载Harbor安装包：<a href="https://github.com/goharbor/harbor/releases/download/v2.3.4/harbor-offline-installer-v2.3.4.tgz" target="_blank" rel="noopener">https://github.com/goharbor/harbor/releases/download/v2.3.4/harbor-offline-installer-v2.3.4.tgz</a></p>
</li>
<li><p>拖拽到Linux并解压：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf harbor-offline-installer-v2.3.4.tgz -C /usr/<span class="built_in">local</span>/</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改Harbor配置文件：</p>
<ul>
<li><p>首先复制一份harbor.yml配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp harbor.yml.tmpl harbor.yml</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑harbor.yml配置文件</p>
<p><img src="/images/DevOps/%E9%85%8D%E7%BD%AEHarbor%E6%96%87%E4%BB%B6.png" alt=""></p>
</li>
</ul>
</li>
<li><p>启动Harbor</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./install.sh</span><br></pre></td></tr></table></figure>

<p><img src="/images/DevOps/harbor%E6%97%A5%E5%BF%97.png" alt=""></p>
</li>
<li><p>登录Harbor</p>
<p><img src="/images/DevOps/%E7%99%BB%E5%BD%95Harbor.png" alt=""></p>
</li>
<li><p>首页信息</p>
<p><img src="/images/DevOps/harbor%E9%A6%96%E9%A1%B5%E4%BF%A1%E6%81%AF.png" alt=""></p>
</li>
</ul>
<h2 id="8-3-Harbor使用方式"><a href="#8-3-Harbor使用方式" class="headerlink" title="8.3 Harbor使用方式"></a>8.3 Harbor使用方式</h2><p>Harbor作为镜像仓库，主要的交互方式就是将镜像上传到Harbor上，以及从Harbor上下载指定镜像</p>
<p>在传输镜像前，可以先使用Harbor提供的权限管理，将项目设置为私有项目，并对不同用户设置不同角色，从而更方便管理镜像。</p>
<h3 id="8-3-1-添加用户构建项目"><a href="#8-3-1-添加用户构建项目" class="headerlink" title="8.3.1 添加用户构建项目"></a>8.3.1 添加用户构建项目</h3><ul>
<li>创建用户</li>
</ul>
<p><img src="/images/DevOps/%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7.png" alt=""></p>
<ul>
<li><p>构建项目（设置为私有）</p>
<p><img src="/images/DevOps/harbor%E6%9E%84%E5%BB%BA%E9%A1%B9%E7%9B%AE.png" alt=""></p>
</li>
<li><p>给项目追加用户</p>
<p><img src="/images/DevOps/%E8%BF%BD%E5%8A%A0%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86.png" alt=""></p>
</li>
<li><p>切换测试用户</p>
<p><img src="/images/DevOps/%E5%88%87%E6%8D%A2%E6%B5%8B%E8%AF%95%E7%94%A8%E6%88%B7.png" alt=""></p>
</li>
</ul>
<h3 id="8-3-2-发布镜像到Harbor"><a href="#8-3-2-发布镜像到Harbor" class="headerlink" title="8.3.2 发布镜像到Harbor"></a>8.3.2 发布镜像到Harbor</h3><ul>
<li><p>修改镜像名称</p>
<p>名称要求：[harbor地址/项目名/镜像名:版本](</p>
<p><img src="/images/DevOps/%E4%BF%AE%E6%94%B9%E9%95%9C%E5%83%8F%E5%90%8D%E7%A7%B0.png" alt=""></p>
</li>
<li><p>修改daemon.json，支持Docker仓库，并重启Docker</p>
<p><img src="/images/DevOps/%E4%BF%AE%E6%94%B9daemon.json%EF%BC%8C%E6%94%AF%E6%8C%81Docker%E4%BB%93%E5%BA%93.png" alt="修改daemon.json，支持Docker仓库"></p>
</li>
<li><p>设置登录仓库信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login -u 用户名 -p 密码 Harbor地址</span><br></pre></td></tr></table></figure>
</li>
<li><p>推送镜像到Harbor</p>
<p><img src="/images/DevOps/%E6%8E%A8%E9%80%81%E9%95%9C%E5%83%8F%E5%88%B0Harbor.png" alt=""></p>
<p><img src="/images/DevOps/%E6%8E%A8%E9%80%81%E9%95%9C%E5%83%8F%E5%88%B0Harbor2.png" alt=""></p>
</li>
</ul>
<h3 id="8-3-3-从Harbor拉取镜像"><a href="#8-3-3-从Harbor拉取镜像" class="headerlink" title="8.3.3 从Harbor拉取镜像"></a>8.3.3 从Harbor拉取镜像</h3><p>跟传统方式一样，不过需要先配置<a href="">/etc/docker/daemon.json</a>文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        <span class="string">"registry-mirrors"</span>: [<span class="string">"https://pee6w651.mirror.aliyuncs.com"</span>],</span><br><span class="line">        <span class="string">"insecure-registries"</span>: [<span class="string">"192.168.11.11:80"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/DevOps/harbor%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F.png" alt=""></p>
<h3 id="8-3-4-Jenkins容器使用宿主机Docker"><a href="#8-3-4-Jenkins容器使用宿主机Docker" class="headerlink" title="8.3.4 Jenkins容器使用宿主机Docker"></a>8.3.4 Jenkins容器使用宿主机Docker</h3><p>构建镜像和发布镜像到harbor都需要使用到docker命令。而在Jenkins容器内部安装Docker官方推荐直接采用宿主机带的Docker即可。</p>
<p>设置Jenkins容器使用宿主机Docker</p>
<ul>
<li><p>设置宿主机docker.sock权限：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chown root:root /var/run/docker.sock</span><br><span class="line">sudo chmod o+rw /var/run/docker.sock</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加数据卷</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">"3.1"</span></span><br><span class="line">services:</span><br><span class="line">  jenkins:</span><br><span class="line">    image: jenkins/jenkins</span><br><span class="line">    container_name: jenkins</span><br><span class="line">    ports:</span><br><span class="line">      - 8080:8080</span><br><span class="line">      - 50000:50000</span><br><span class="line">    volumes:</span><br><span class="line">      - ./data/:/var/jenkins_home/</span><br><span class="line">      - /usr/bin/docker:/usr/bin/docker</span><br><span class="line">      - /var/run/docker.sock:/var/run/docker.sock</span><br><span class="line">      - /etc/docker/daemon.json:/etc/docker/daemon.json</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="8-3-5-添加构建操作"><a href="#8-3-5-添加构建操作" class="headerlink" title="8.3.5 添加构建操作"></a>8.3.5 添加构建操作</h3><p><img src="/images/DevOps/harbor%E5%88%B6%E4%BD%9C%E8%87%AA%E5%AE%9A%E4%B9%89%E9%95%9C%E5%83%8F.png" alt="harbor制作自定义镜像"></p>
<h3 id="8-3-6-编写部署脚本"><a href="#8-3-6-编写部署脚本" class="headerlink" title="8.3.6 编写部署脚本"></a>8.3.6 编写部署脚本</h3><p>部署项目需要通过Publish Over SSH插件，让目标服务器执行命令。为了方便一次性实现拉取镜像和启动的命令，推荐采用脚本文件的方式。</p>
<p>添加脚本文件到目标服务器，再通过Publish Over SSH插件让目标服务器执行脚本即可。</p>
<ul>
<li><p>编写脚本文件，添加到目标服务器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">harbor_url=<span class="variable">$1</span></span><br><span class="line">harbor_project_name=<span class="variable">$2</span></span><br><span class="line">project_name=<span class="variable">$3</span></span><br><span class="line">tag=<span class="variable">$4</span></span><br><span class="line">port=<span class="variable">$5</span></span><br><span class="line"></span><br><span class="line">imageName=<span class="variable">$harbor_url</span>/<span class="variable">$harbor_project_name</span>/<span class="variable">$project_name</span>:<span class="variable">$tag</span></span><br><span class="line"></span><br><span class="line">containerId=`docker ps -a | grep <span class="variable">$&#123;project_name&#125;</span> | awk <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$containerId</span>"</span> != <span class="string">""</span> ] ; <span class="keyword">then</span></span><br><span class="line">    docker stop <span class="variable">$containerId</span></span><br><span class="line">    docker rm <span class="variable">$containerId</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Delete Container Success"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">imageId=`docker /images | grep <span class="variable">$&#123;project_name&#125;</span> | awk <span class="string">'&#123;print $3&#125;'</span>`</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$imageId</span>"</span> != <span class="string">""</span> ] ; <span class="keyword">then</span></span><br><span class="line">    docker rmi -f <span class="variable">$imageId</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Delete Image Success"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">docker login -u DevOps -p P@ssw0rd <span class="variable">$harbor_url</span></span><br><span class="line"></span><br><span class="line">docker pull <span class="variable">$imageName</span></span><br><span class="line"></span><br><span class="line">docker run -d -p <span class="variable">$port</span>:<span class="variable">$port</span> --name <span class="variable">$project_name</span> <span class="variable">$imageName</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Start Container Success"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$project_name</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>if [ “$imageId” != “” ] ; then</p>
<p>docker rmi -f $imageId<br>echo “Delete Image Success”<br>fi</p>
<p>可以修改为</p>
<p>if [ [ “$tag” =~ “$imageId” ]] ; then<br>docker rmi -f $imageId<br>echo “Delete Image Success”<br>fi</p>
<p>因为$imageId可以能有多个，$tag包含在$imageId中就进入</p>
</blockquote>
</li>
</ul>
<p>并设置权限为可执行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod a+x deploy.sh</span><br></pre></td></tr></table></figure>

<p><img src="/images/DevOps/%E8%AE%BE%E7%BD%AE%E6%9D%83%E9%99%90%E4%B8%BA%E5%8F%AF%E6%89%A7%E8%A1%8C.png" alt=""></p>
<h3 id="8-3-7-配置构建后操作"><a href="#8-3-7-配置构建后操作" class="headerlink" title="8.3.7 配置构建后操作"></a>8.3.7 配置构建后操作</h3><p><img src="/images/DevOps/%E6%89%A7%E8%A1%8C%E8%84%9A%E6%9C%AC%E6%96%87%E4%BB%B6.png" alt=""></p>
<h1 id="九、Jenkins流水线"><a href="#九、Jenkins流水线" class="headerlink" title="九、Jenkins流水线"></a>九、Jenkins流水线</h1><h2 id="9-1-Jenkins流水线任务介绍"><a href="#9-1-Jenkins流水线任务介绍" class="headerlink" title="9.1 Jenkins流水线任务介绍"></a>9.1 Jenkins流水线任务介绍</h2><p>之前采用Jenkins的自由风格构建的项目，每个步骤流程都要通过不同的方式设置，并且构建过程中整体流程是不可见的，无法确认每个流程花费的时间，并且问题不方便定位问题。</p>
<p>Jenkins的Pipeline可以让项目的发布整体流程可视化，明确执行的阶段，可以快速的定位问题。并且整个项目的生命周期可以通过一个Jenkinsfile文件管理，而且Jenkinsfile文件是可以放在项目中维护。</p>
<p>所以Pipeline相对自由风格或者其他的项目风格更容易操作。</p>
<h2 id="9-2-Jenkins流水线任务"><a href="#9-2-Jenkins流水线任务" class="headerlink" title="9.2 Jenkins流水线任务"></a>9.2 Jenkins流水线任务</h2><h3 id="9-2-1-构建Jenkins流水线任务"><a href="#9-2-1-构建Jenkins流水线任务" class="headerlink" title="9.2.1 构建Jenkins流水线任务"></a>9.2.1 构建Jenkins流水线任务</h3><ul>
<li><p>构建任务</p>
<p><img src="/images/DevOps/%E6%9E%84%E5%BB%BAJenkins%E6%B5%81%E6%B0%B4%E7%BA%BF%E4%BB%BB%E5%8A%A1.png" alt=""></p>
</li>
<li><p>生成Groovy脚本</p>
<p>![](/images/DevOps/Hello World脚本生成.png)</p>
</li>
<li><p>构建后查看视图</p>
<p><img src="/images/DevOps/%E6%9E%84%E5%BB%BA%E5%90%8E%E6%9F%A5%E7%9C%8B%E8%A7%86%E5%9B%BE.png" alt=""></p>
</li>
</ul>
<h3 id="9-2-2-Groovy脚本"><a href="#9-2-2-Groovy脚本" class="headerlink" title="9.2.2 Groovy脚本"></a>9.2.2 Groovy脚本</h3><ul>
<li><p>Groovy脚本基础语法</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 所有脚本命令包含在pipeline&#123;&#125;中</span></span><br><span class="line">pipeline &#123;  </span><br><span class="line">	<span class="comment">// 指定任务在哪个节点执行（Jenkins支持分布式）</span></span><br><span class="line">    agent any</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 配置全局环境，指定变量名=变量值信息</span></span><br><span class="line">    environment&#123;</span><br><span class="line">    	host = <span class="string">'192.168.11.11'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存放所有任务的合集</span></span><br><span class="line">    stages &#123;</span><br><span class="line">    	<span class="comment">// 单个任务</span></span><br><span class="line">        stage(<span class="string">'任务1'</span>) &#123;</span><br><span class="line">        	<span class="comment">// 实现任务的具体流程</span></span><br><span class="line">            steps &#123;</span><br><span class="line">                echo <span class="string">'do something'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// 单个任务</span></span><br><span class="line">        stage(<span class="string">'任务2'</span>) &#123;</span><br><span class="line">        	<span class="comment">// 实现任务的具体流程</span></span><br><span class="line">            steps &#123;</span><br><span class="line">                echo <span class="string">'do something'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ……</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写例子测试</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line"></span><br><span class="line">    // 存放所有任务的合集</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">'拉取Git代码'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">'拉取Git代码'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">'检测代码质量'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">'检测代码质量'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">'构建代码'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">'构建代码'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">'制作自定义镜像并发布Harbor'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">'制作自定义镜像并发布Harbor'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">'基于Harbor部署工程'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">'基于Harbor部署工程'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/DevOps/%E9%85%8D%E7%BD%AEGrovvy%E8%84%9A%E6%9C%AC.png" alt=""></p>
<ul>
<li><p>查看效果</p>
<p><img src="/images/DevOps/%E6%9F%A5%E7%9C%8B%E6%95%88%E6%9E%9C.png" alt=""></p>
</li>
</ul>
<p>Ps：涉及到特定脚本，Jenkins给予了充足的提示，可以自动生成命令</p>
<p><img src="/images/DevOps/%E7%94%9F%E6%88%90%E5%91%BD%E4%BB%A4%E4%BD%8D%E7%BD%AE.png" alt=""></p>
<h3 id="9-2-3-Jenkinsfile实现"><a href="#9-2-3-Jenkinsfile实现" class="headerlink" title="9.2.3 Jenkinsfile实现"></a>9.2.3 Jenkinsfile实现</h3><p>Jenkinsfile方式需要将脚本内容编写到项目中的Jenkinsfile文件中，每次构建会自动拉取项目并且获取项目中Jenkinsfile文件对项目进行构建</p>
<ul>
<li><p>配置pipeline</p>
<p><img src="/images/DevOps/%E9%85%8D%E7%BD%AEpipeline.png" alt=""></p>
</li>
<li><p>准备Jenkinsfile</p>
<p><img src="/images/DevOps/%E5%87%86%E5%A4%87Jenkinsfile%E6%96%87%E4%BB%B6.png" alt=""></p>
</li>
<li><p>测试效果</p>
<p><img src="/images/DevOps/%E6%B5%8B%E8%AF%95%E6%95%88%E6%9E%9C.png" alt=""></p>
</li>
</ul>
<h2 id="9-3-Jenkins流水线任务实现"><a href="#9-3-Jenkins流水线任务实现" class="headerlink" title="9.3 Jenkins流水线任务实现"></a>9.3 Jenkins流水线任务实现</h2><h3 id="9-3-1-参数化构建"><a href="#9-3-1-参数化构建" class="headerlink" title="9.3.1 参数化构建"></a>9.3.1 参数化构建</h3><p>添加参数化构建，方便选择不的项目版本</p>
<p><img src="/images/DevOps/Git%E5%8F%82%E6%95%B0%E5%8C%96%E6%9E%84%E5%BB%BA.png" alt=""></p>
<h3 id="9-3-2-拉取Git代码"><a href="#9-3-2-拉取Git代码" class="headerlink" title="9.3.2 拉取Git代码"></a>9.3.2 拉取Git代码</h3><p>通过流水线语法生成Checkout代码的脚本</p>
<p><img src="/images/DevOps/%E8%AF%AD%E6%B3%95%E7%94%9F%E6%88%90.png" alt=""></p>
<p><img src="/images/DevOps/%E8%AF%AD%E6%B3%95%E7%94%9F%E6%88%902.png" alt=""></p>
<p>将*/master更改为标签${tag}</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    stages &#123;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">'拉取Git代码'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                checkout([<span class="variable">$class</span>: <span class="string">'GitSCM'</span>, branches: [[name: <span class="string">'$&#123;tag&#125;'</span>]], extensions: [], userRemoteConfigs: [[url: <span class="string">'http://49.233.115.171:8929/root/test.git'</span>]]])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-3-3-构建代码"><a href="#9-3-3-构建代码" class="headerlink" title="9.3.3 构建代码"></a>9.3.3 构建代码</h3><p>通过脚本执行mvn的构建命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">'拉取Git代码'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                checkout([<span class="variable">$class</span>: <span class="string">'GitSCM'</span>, branches: [[name: <span class="string">'$&#123;tag&#125;'</span>]], extensions: [], userRemoteConfigs: [[url: <span class="string">'http://49.233.115.171:8929/root/test.git'</span>]]])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">'构建代码'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">'/var/jenkins_home/maven/bin/mvn clean package -DskipTests'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-3-4-代码质量检测"><a href="#9-3-4-代码质量检测" class="headerlink" title="9.3.4 代码质量检测"></a>9.3.4 代码质量检测</h3><p>通过脚本执行sonar-scanner命令即可</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">'拉取Git代码'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                checkout([<span class="variable">$class</span>: <span class="string">'GitSCM'</span>, branches: [[name: <span class="string">'$&#123;tag&#125;'</span>]], extensions: [], userRemoteConfigs: [[url: <span class="string">'http://49.233.115.171:8929/root/test.git'</span>]]])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">'构建代码'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">'/var/jenkins_home/maven/bin/mvn clean package -DskipTests'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">'检测代码质量'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">'/var/jenkins_home/sonar-scanner/bin/sonar-scanner -Dsonar.sources=./ -Dsonar.projectname=$&#123;JOB_NAME&#125; -Dsonar.projectKey=$&#123;JOB_NAME&#125; -Dsonar.java.binaries=target/ -Dsonar.login=31388be45653876c1f51ec02f0d478e2d9d0e1fa'</span> </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-3-5-制作自定义镜像并发布"><a href="#9-3-5-制作自定义镜像并发布" class="headerlink" title="9.3.5 制作自定义镜像并发布"></a>9.3.5 制作自定义镜像并发布</h3><ul>
<li><p>生成自定义镜像脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    environment&#123;</span><br><span class="line">        harborHost = <span class="string">'192.168.11.11:80'</span></span><br><span class="line">        harborRepo = <span class="string">'repository'</span></span><br><span class="line">        harborUser = <span class="string">'DevOps'</span></span><br><span class="line">        harborPasswd = <span class="string">'P@ssw0rd'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 存放所有任务的合集</span><br><span class="line">    stages &#123;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">'拉取Git代码'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                checkout([<span class="variable">$class</span>: <span class="string">'GitSCM'</span>, branches: [[name: <span class="string">'$&#123;tag&#125;'</span>]], extensions: [], userRemoteConfigs: [[url: <span class="string">'http://49.233.115.171:8929/root/test.git'</span>]]])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">'构建代码'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">'/var/jenkins_home/maven/bin/mvn clean package -DskipTests'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">'检测代码质量'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">'/var/jenkins_home/sonar-scanner/bin/sonar-scanner -Dsonar.sources=./ -Dsonar.projectname=$&#123;JOB_NAME&#125; -Dsonar.projectKey=$&#123;JOB_NAME&#125; -Dsonar.java.binaries=target/ -Dsonar.login=31388be45653876c1f51ec02f0d478e2d9d0e1fa'</span> </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">'制作自定义镜像并发布Harbor'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">''</span><span class="string">'cp ./target/*.jar ./docker/</span></span><br><span class="line"><span class="string">                cd ./docker</span></span><br><span class="line"><span class="string">                docker build -t $&#123;JOB_NAME&#125;:$&#123;tag&#125; ./'</span><span class="string">''</span></span><br><span class="line"></span><br><span class="line">                sh <span class="string">''</span><span class="string">'docker login -u $&#123;harborUser&#125; -p $&#123;harborPasswd&#125; $&#123;harborHost&#125;</span></span><br><span class="line"><span class="string">                docker tag $&#123;JOB_NAME&#125;:$&#123;tag&#125; $&#123;harborHost&#125;/$&#123;harborRepo&#125;/$&#123;JOB_NAME&#125;:$&#123;tag&#125;</span></span><br><span class="line"><span class="string">                docker push $&#123;harborHost&#125;/$&#123;harborRepo&#125;/$&#123;JOB_NAME&#125;:$&#123;tag&#125;'</span><span class="string">''</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成Publish Over SSH脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    environment&#123;</span><br><span class="line">        harborHost = <span class="string">'192.168.11.11:80'</span></span><br><span class="line">        harborRepo = <span class="string">'repository'</span></span><br><span class="line">        harborUser = <span class="string">'DevOps'</span></span><br><span class="line">        harborPasswd = <span class="string">'P@ssw0rd'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 存放所有任务的合集</span><br><span class="line">    stages &#123;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">'拉取Git代码'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                checkout([<span class="variable">$class</span>: <span class="string">'GitSCM'</span>, branches: [[name: <span class="string">'$&#123;tag&#125;'</span>]], extensions: [], userRemoteConfigs: [[url: <span class="string">'http://49.233.115.171:8929/root/test.git'</span>]]])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">'构建代码'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">'/var/jenkins_home/maven/bin/mvn clean package -DskipTests'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;docker</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">'检测代码质量'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">'/var/jenkins_home/sonar-scanner/bin/sonar-scanner -Dsonar.sources=./ -Dsonar.projectname=$&#123;JOB_NAME&#125; -Dsonar.projectKey=$&#123;JOB_NAME&#125; -Dsonar.java.binaries=target/ -Dsonar.login=7d66af4b39cfe4f52ac0a915d4c9d5c513207098'</span> </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">'制作自定义镜像并发布Harbor'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">''</span><span class="string">'cp ./target/*.jar ./docker/</span></span><br><span class="line"><span class="string">                cd ./docker</span></span><br><span class="line"><span class="string">                docker build -t $&#123;JOB_NAME&#125;:$&#123;tag&#125; ./'</span><span class="string">''</span></span><br><span class="line"></span><br><span class="line">                sh <span class="string">''</span><span class="string">'docker login -u $&#123;harborUser&#125; -p $&#123;harborPasswd&#125; $&#123;harborHost&#125;</span></span><br><span class="line"><span class="string">                docker tag $&#123;JOB_NAME&#125;:$&#123;tag&#125; $&#123;harborHost&#125;/$&#123;harborRepo&#125;/$&#123;JOB_NAME&#125;:$&#123;tag&#125;</span></span><br><span class="line"><span class="string">                docker push $&#123;harborHost&#125;/$&#123;harborRepo&#125;/$&#123;JOB_NAME&#125;:$&#123;tag&#125;'</span><span class="string">''</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        stage(<span class="string">'目标服务器拉取镜像并运行'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sshPublisher(publishers: [sshPublisherDesc(configName: <span class="string">'testEnvironment'</span>, transfers: [sshTransfer(cleanRemote: <span class="literal">false</span>, excludes: <span class="string">''</span>, execCommand: <span class="string">"/usr/bin/deploy.sh <span class="variable">$harborHost</span> <span class="variable">$harborRepo</span> <span class="variable">$JOB_NAME</span> <span class="variable">$tag</span> <span class="variable">$port</span> "</span>, execTimeout: 120000, flatten: <span class="literal">false</span>, makeEmptyDirs: <span class="literal">false</span>, noDefaultExcludes: <span class="literal">false</span>, patternSeparator: <span class="string">'[, ]+'</span>, remoteDirectory: <span class="string">''</span>, remoteDirectorySDF: <span class="literal">false</span>, removePrefix: <span class="string">''</span>, sourceFiles: <span class="string">''</span>)], usePromotionTimestamp: <span class="literal">false</span>, useWorkspaceInPromotion: <span class="literal">false</span>, verbose: <span class="literal">false</span>)])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>由于采用变量，记得使用双引号</p>
</blockquote>
</li>
</ul>
<h2 id="9-4-Jenkins流水线整合钉钉"><a href="#9-4-Jenkins流水线整合钉钉" class="headerlink" title="9.4 Jenkins流水线整合钉钉"></a>9.4 Jenkins流水线整合钉钉</h2><p>在程序部署成功后，可以通过钉钉的机器人及时向群众发送部署的最终结果通知</p>
<ul>
<li><p>安装插件</p>
<p><img src="/images/DevOps/%E9%92%89%E9%92%89%E5%AE%89%E8%A3%85%E6%8F%92%E4%BB%B6.png" alt=""></p>
</li>
<li><p>钉钉内部创建群组并构建机器人</p>
<p><img src="/images/DevOps/%E9%92%89%E9%92%89%E5%86%85%E9%83%A8%E5%88%9B%E5%BB%BA%E7%BE%A4%E7%BB%84%E5%B9%B6%E6%9E%84%E5%BB%BA%E6%9C%BA%E5%99%A8%E4%BA%BA.png" alt=""></p>
</li>
</ul>
<p>最终或获取到Webhook信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxxxxxxxx</span><br></pre></td></tr></table></figure>

<ul>
<li><p>系统配置添加钉钉通知</p>
<p><img src="/images/DevOps/%E9%85%8D%E7%BD%AE%E9%92%89%E9%92%89%E9%80%9A%E7%9F%A5.png" alt=""></p>
</li>
<li><p>任务中追加流水线配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line"></span><br><span class="line">    environment &#123;</span><br><span class="line">        sonarLogin = <span class="string">'2bab7bf7d5af25e2c2ca2f178af2c3c55c64d5d8'</span></span><br><span class="line">        harborUser = <span class="string">'admin'</span></span><br><span class="line">        harborPassword = <span class="string">'Harbor12345'</span></span><br><span class="line">        harborHost = <span class="string">'192.168.11.12:8888'</span></span><br><span class="line">        harborRepo = <span class="string">'repository'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">'拉取Git代码'</span>)&#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                checkout([<span class="variable">$class</span>: <span class="string">'GitSCM'</span>, branches: [[name: <span class="string">'$tag'</span>]], extensions: [], userRemoteConfigs: [[url: <span class="string">'http://49.233.115.171:8929/root/lsx.git'</span>]]])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">'Maven构建代码'</span>)&#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">'/var/jenkins_home/maven/bin/mvn clean package -DskipTests'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">'SonarQube检测代码'</span>)&#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">'/var/jenkins_home/sonar-scanner/bin/sonar-scanner -Dsonar.sources=./ -Dsonar.projectname=$&#123;JOB_NAME&#125; -Dsonar.projectKey=$&#123;JOB_NAME&#125; -Dsonar.java.binaries=target/ -Dsonar.login=$&#123;sonarLogin&#125;'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">'制作自定义镜像'</span>)&#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">''</span><span class="string">'cd docker</span></span><br><span class="line"><span class="string">                mv ../target/*.jar ./</span></span><br><span class="line"><span class="string">                docker build -t $&#123;JOB_NAME&#125;:$tag .</span></span><br><span class="line"><span class="string">                '</span><span class="string">''</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">'推送自定义镜像'</span>)&#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">''</span><span class="string">'docker login -u $&#123;harborUser&#125; -p $&#123;harborPassword&#125; $&#123;harborHost&#125;</span></span><br><span class="line"><span class="string">                docker tag $&#123;JOB_NAME&#125;:$tag $&#123;harborHost&#125;/$&#123;harborRepo&#125;/$&#123;JOB_NAME&#125;:$tag</span></span><br><span class="line"><span class="string">                docker push $&#123;harborHost&#125;/$&#123;harborRepo&#125;/$&#123;JOB_NAME&#125;:$tag'</span><span class="string">''</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">'通知目标服务器'</span>)&#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sshPublisher(publishers: [sshPublisherDesc(configName: <span class="string">'centos-docker'</span>, transfers: [sshTransfer(cleanRemote: <span class="literal">false</span>, excludes: <span class="string">''</span>, execCommand: <span class="string">"/usr/bin/deploy.sh <span class="variable">$harborHost</span> <span class="variable">$harborRepo</span> <span class="variable">$JOB_NAME</span> <span class="variable">$tag</span> <span class="variable">$port</span>"</span>, execTimeout: 120000, flatten: <span class="literal">false</span>, makeEmptyDirs: <span class="literal">false</span>, noDefaultExcludes: <span class="literal">false</span>, patternSeparator: <span class="string">'[, ]+'</span>, remoteDirectory: <span class="string">''</span>, remoteDirectorySDF: <span class="literal">false</span>, removePrefix: <span class="string">''</span>, sourceFiles: <span class="string">''</span>)], usePromotionTimestamp: <span class="literal">false</span>, useWorkspaceInPromotion: <span class="literal">false</span>, verbose: <span class="literal">false</span>)])</span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    post &#123;</span><br><span class="line">        success &#123;</span><br><span class="line">            dingtalk (</span><br><span class="line">                robot: <span class="string">'Jenkins-DingDing'</span>,</span><br><span class="line">                <span class="built_in">type</span>:<span class="string">'MARKDOWN'</span>,</span><br><span class="line">                title: <span class="string">"success: <span class="variable">$&#123;JOB_NAME&#125;</span>"</span>,</span><br><span class="line">                text: [<span class="string">"- 成功构建:<span class="variable">$&#123;JOB_NAME&#125;</span>项目!\n- 版本:<span class="variable">$&#123;tag&#125;</span>\n- 持续时间:<span class="variable">$&#123;currentBuild.durationString&#125;</span>\n- 任务:#<span class="variable">$&#123;JOB_NAME&#125;</span>"</span>]</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">        failure &#123;</span><br><span class="line">            dingtalk (</span><br><span class="line">                robot: <span class="string">'Jenkins-DingDing'</span>,</span><br><span class="line">                <span class="built_in">type</span>:<span class="string">'MARKDOWN'</span>,</span><br><span class="line">                title: <span class="string">"fail: <span class="variable">$&#123;JOB_NAME&#125;</span>"</span>,</span><br><span class="line">                text: [<span class="string">"- 失败构建:<span class="variable">$&#123;JOB_NAME&#125;</span>项目!\n- 版本:<span class="variable">$&#123;tag&#125;</span>\n- 持续时间:<span class="variable">$&#123;currentBuild.durationString&#125;</span>\n- 任务:#<span class="variable">$&#123;JOB_NAME&#125;</span>"</span>]</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="十、Kubernetes编排工具"><a href="#十、Kubernetes编排工具" class="headerlink" title="十、Kubernetes编排工具"></a>十、Kubernetes编排工具</h1><h2 id="10-1-Kubernetes介绍"><a href="#10-1-Kubernetes介绍" class="headerlink" title="10.1 Kubernetes介绍"></a>10.1 Kubernetes介绍</h2><p>Kubernetes是一个开源的，用于管理云平台中多个主机上的容器化的应用，Kubernetes的目标是让部署容器化的应用简单并且高效（powerful），Kubernetes提供了应用部署，规划，更新，维护的一种机制。</p>
<p>Kubernetes一个核心的特点就是能够自主的管理容器来保证云平台中的容器按照用户的期望状态运行着，管理员可以加载一个微型服务，让规划器来找到合适的位置，同时，Kubernetes也系统提升工具以及人性化方面，让用户能够方便的部署自己的应用。</p>
<p>Kubernetes主要能帮助我们完成：</p>
<ul>
<li><p>服务发现和负载均衡</p>
<p>Kubernetes 可以使用 DNS 名称或自己的 IP 地址公开容器，如果进入容器的流量很大， Kubernetes 可以负载均衡并分配网络流量，从而使部署稳定。</p>
</li>
<li><p>存储编排</p>
<p>Kubernetes 允许你自动挂载你选择的存储系统，比如本地存储，类似Docker的数据卷。</p>
</li>
<li><p>自动部署和回滚</p>
<p>你可以使用 Kubernetes 描述已部署容器的所需状态，它可以以受控的速率将实际状态 更改为期望状态。Kubernetes 会自动帮你根据情况部署创建新容器，并删除现有容器给新容器提供资源。</p>
</li>
<li><p>自动完成装箱计算</p>
<p>Kubernetes 允许你设置每个容器的资源，比如CPU和内存。</p>
</li>
<li><p>自我修复</p>
<p>Kubernetes 重新启动失败的容器、替换容器、杀死不响应用户定义的容器，并运行状况检查的容器。</p>
</li>
<li><p>秘钥与配置管理</p>
<p>Kubernetes 允许你存储和管理敏感信息，例如密码、OAuth 令牌和 ssh 密钥。你可以在不重建容器镜像的情况下部署和更新密钥和应用程序配置，也无需在堆栈配置中暴露密钥。</p>
</li>
</ul>
<h2 id="10-2-Kubernetes架构"><a href="#10-2-Kubernetes架构" class="headerlink" title="10.2 Kubernetes架构"></a>10.2 Kubernetes架构</h2><p>Kubernetes 搭建需要至少两个节点，一个Master负责管理，一个Slave搭建在工作服务器上负责分配。</p>
<p><img src="/images/DevOps/kubernetes%E6%9E%B6%E6%9E%84.png" alt=""></p>
<p>从图中可以看到各个组件的基本功能：</p>
<ul>
<li>API Server：作为K8s通讯的核心组件，K8s内部交互以及接收发送指令的组件。</li>
<li>controller-manager：作为K8s的核心组件，主要做资源调度，根据集群情况分配资源</li>
<li>etcd：一个key-value的数据库，存储存储集群的状态信息</li>
<li>scheduler：负责调度每个工作节点</li>
<li>cloud-controller-manager：负责调度其他云服务产品</li>
<li>kubelet：管理Pods上面的容器。</li>
<li>kube-proxy：负责处理其他Slave或客户端的请求。</li>
<li>Pod：可以理解为就是运行的容器</li>
</ul>
<h2 id="10-3-Kubernetes安装"><a href="#10-3-Kubernetes安装" class="headerlink" title="10.3 Kubernetes安装"></a>10.3 Kubernetes安装</h2><p>这里会采用<a href="https://kuboard.cn/提供的方式安装K8s，安装单Master节点" target="_blank" rel="noopener">https://kuboard.cn/提供的方式安装K8s，安装单Master节点</a></p>
<ul>
<li>要求使用Centos7.8版本：<a href="https://vault.centos.org/7.8.2003/isos/x86_64/CentOS-7-x86_64-Minimal-2003.iso" target="_blank" rel="noopener">https://vault.centos.org/7.8.2003/isos/x86_64/CentOS-7-x86_64-Minimal-2003.iso</a></li>
<li>至少2台 <strong>2核4G</strong> 的服务器</li>
</ul>
<p>安装流程</p>
<p><img src="/images/DevOps/%E5%AE%89%E8%A3%85%E6%B5%81%E7%A8%8B.png" alt=""></p>
<p>准备好服务器后开始安装</p>
<ul>
<li><p>重新设置hostname，不允许为localhost</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改 hostname，名字不允许使用下划线、小数点、大写字母，不能叫master</span></span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname your-new-host-name</span><br><span class="line"><span class="comment"># 查看修改结果</span></span><br><span class="line">hostnamectl status</span><br><span class="line"><span class="comment"># 设置 hostname 解析</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"127.0.0.1   <span class="variable">$(hostname)</span>"</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>
</li>
<li><p>要求2台服务之间可以相互通讯</p>
</li>
<li><p>安装软件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 阿里云 docker hub 镜像</span></span><br><span class="line"><span class="built_in">export</span> REGISTRY_MIRROR=https://registry.cn-hangzhou.aliyuncs.com</span><br><span class="line">curl -sSL https://kuboard.cn/install-script/v1.19.x/install_kubelet.sh | sh -s 1.19.5</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>首先初始化Master节点</p>
<blockquote>
<p>关于初始化时用到的环境变量</p>
<ul>
<li><strong>APISERVER_NAME</strong> 不能是 master 的 hostname</li>
<li><strong>APISERVER_NAME</strong> 必须全为小写字母、数字、小数点，不能包含减号</li>
<li><strong>POD_SUBNET</strong> 所使用的网段不能与 <strong><em>master节点/worker节点</em></strong> 所在的网段重叠。该字段的取值为一个 <a href="https://kuboard.cn/glossary/cidr.html" target="_blank" rel="noopener">CIDR</a> 值，如果您对 CIDR 这个概念还不熟悉，请仍然执行 export POD_SUBNET=10.100.0.0/16 命令，不做修改</li>
</ul>
</blockquote>
<ul>
<li><p>设置ip，域名，网段并执行初始化操作</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在 master 节点执行</span></span><br><span class="line"><span class="comment"># 替换 x.x.x.x 为 master 节点实际 IP（请使用内网 IP）</span></span><br><span class="line"><span class="comment"># export 命令只在当前 shell 会话中有效，开启新的 shell 窗口后，如果要继续安装过程，请重新执行此处的 export 命令</span></span><br><span class="line"><span class="built_in">export</span> MASTER_IP=192.168.11.32</span><br><span class="line"><span class="comment"># 替换 apiserver.demo 为 您想要的 dnsName</span></span><br><span class="line"><span class="built_in">export</span> APISERVER_NAME=apiserver.demo</span><br><span class="line"><span class="comment"># Kubernetes 容器组所在的网段，该网段安装完成后，由 kubernetes 创建，事先并不存在于您的物理网络中</span></span><br><span class="line"><span class="built_in">export</span> POD_SUBNET=10.100.0.1/16</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;MASTER_IP&#125;</span>    <span class="variable">$&#123;APISERVER_NAME&#125;</span>"</span> &gt;&gt; /etc/hosts</span><br><span class="line">curl -sSL https://kuboard.cn/install-script/v1.19.x/init_master.sh | sh -s 1.19.5</span><br></pre></td></tr></table></figure>
</li>
<li><p>检查Master启动状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在 master 节点执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行如下命令，等待 3-10 分钟，直到所有的容器组处于 Running 状态</span></span><br><span class="line">watch kubectl get pod -n kube-system -o wide</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 master 节点初始化结果</span></span><br><span class="line">kubectl get nodes -o wide</span><br></pre></td></tr></table></figure>

<p>如果出现NotReady的情况执行（最新版本的BUG，1.19一般没有）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">docker pull quay.io/coreos/flannel:v0.10.0-amd64 </span><br><span class="line">mkdir -p /etc/cni/net.d/</span><br><span class="line">cat &lt;&lt;EOF&gt; /etc/cni/net.d/10-flannel.conf</span><br><span class="line">&#123;<span class="string">"name"</span>:<span class="string">"cbr0"</span>,<span class="string">"type"</span>:<span class="string">"flannel"</span>,<span class="string">"delegate"</span>: &#123;<span class="string">"isDefaultGateway"</span>: <span class="literal">true</span>&#125;&#125;</span><br><span class="line">EOF</span><br><span class="line">mkdir /usr/share/oci-umount/oci-umount.d -p</span><br><span class="line">mkdir /run/flannel/</span><br><span class="line">cat &lt;&lt;EOF&gt; /run/flannel/subnet.env</span><br><span class="line">FLANNEL_NETWORK=172.100.0.0/16</span><br><span class="line">FLANNEL_SUBNET=172.100.1.0/24</span><br><span class="line">FLANNEL_MTU=1450</span><br><span class="line">FLANNEL_IPMASQ=<span class="literal">true</span></span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/v0.9.1/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure>

<p>安装网络服务插件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> POD_SUBNET=10.100.0.0/16</span><br><span class="line">kubectl apply -f https://kuboard.cn/install-script/v1.22.x/calico-operator.yaml</span><br><span class="line">wget https://kuboard.cn/install-script/v1.22.x/calico-custom-resources.yaml</span><br><span class="line">sed -i <span class="string">"s#192.168.0.0/16#<span class="variable">$&#123;POD_SUBNET&#125;</span>#"</span> calico-custom-resources.yaml</span><br><span class="line">kubectl apply -f calico-custom-resources.yaml</span><br></pre></td></tr></table></figure>


</li>
</ul>
<p>初始化worker节点</p>
<ul>
<li><p>获取Join命令参数，在Master节点执行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在 master 节点执行</span></span><br><span class="line">kubeadm token create --<span class="built_in">print</span>-join-command</span><br></pre></td></tr></table></figure>

<p><img src="/images/DevOps/%E8%8E%B7%E5%8F%96%E5%91%BD%E4%BB%A4.png" alt=""></p>
</li>
<li><p>在worker节点初始化</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在 worker 节点执行</span></span><br><span class="line"><span class="comment"># 替换 x.x.x.x 为 master 节点的内网 IP</span></span><br><span class="line"><span class="built_in">export</span> MASTER_IP=192.168.11.32</span><br><span class="line"><span class="comment"># 替换 apiserver.demo 为初始化 master 节点时所使用的 APISERVER_NAME</span></span><br><span class="line"><span class="built_in">export</span> APISERVER_NAME=apiserver.demo</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;MASTER_IP&#125;</span>    <span class="variable">$&#123;APISERVER_NAME&#125;</span>"</span> &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 替换为 master 节点上 kubeadm token create 命令的输出</span></span><br><span class="line">kubeadm join apiserver.demo:6443 --token vwfilu.3nhndohc5gn1jv9k     --discovery-token-ca-cert-hash sha256:22ff15cabfe87ab48a7db39b3bbf986fee92ec92eb8efc7fe9b0abe2175ff0c2</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>检查最终运行效果</p>
<ul>
<li><p>在 master 节点上执行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在 master 节点执行</span></span><br><span class="line">kubectl get nodes -o wide</span><br></pre></td></tr></table></figure>

<p>如果出现NotReady的情况执行（最新版本的BUG，1.19一般没有）</p>
<blockquote>
<p>docker pull quay.io/coreos/flannel:v0.10.0-amd64<br>mkdir -p /etc/cni/net.d/<br>cat &lt;<EOF> /etc/cni/net.d/10-flannel.conf<br>{“name”:”cbr0”,”type”:”flannel”,”delegate”: {“isDefaultGateway”: true}}<br>EOF<br>mkdir /usr/share/oci-umount/oci-umount.d -p<br>mkdir /run/flannel/<br>cat &lt;<EOF> /run/flannel/subnet.env<br>FLANNEL_NETWORK=172.100.0.0/16<br>FLANNEL_SUBNET=172.100.1.0/24<br>FLANNEL_MTU=1450<br>FLANNEL_IPMASQ=true<br>EOF<br>kubectl apply -f <a href="https://raw.githubusercontent.com/coreos/flannel/v0.9.1/Documentation/kube-flannel.yml" target="_blank" rel="noopener">https://raw.githubusercontent.com/coreos/flannel/v0.9.1/Documentation/kube-flannel.yml</a></p>
</blockquote>
</li>
<li><p>输出结果如下所示：</p>
<p><img src="/images/DevOps/%E6%90%AD%E5%BB%BA%E6%88%90%E5%8A%9F%E6%95%88%E6%9E%9C.png" alt=""></p>
</li>
</ul>
<p>安装Kuboard管理K8s集群</p>
<ul>
<li><p>安装Kuboard</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://addons.kuboard.cn/kuboard/kuboard-v3.yaml</span><br><span class="line"><span class="comment"># 您也可以使用下面的指令，唯一的区别是，该指令使用华为云的镜像仓库替代 docker hub 分发 Kuboard 所需要的镜像</span></span><br><span class="line"><span class="comment"># kubectl apply -f https://addons.kuboard.cn/kuboard/kuboard-v3-swr.yaml</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查看启动情况</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch kubectl get pods -n kuboard</span><br></pre></td></tr></table></figure>

<p><img src="/images/DevOps/kuboard%E6%9F%A5%E7%9C%8B%E6%95%88%E6%9E%9C.png" alt=""></p>
</li>
<li><p>在浏览器中打开链接 <a href="http://your-node-ip-address:30080" target="_blank" rel="noopener">http://your-node-ip-address:30080</a></p>
<p><img src="/images/DevOps/kuboard%E9%A6%96%E9%A1%B5.png" alt=""></p>
</li>
<li><p>输入初始用户名和密码，并登录</p>
<ul>
<li>用户名： <code>admin</code></li>
<li>密码： <code>Kuboard123</code></li>
</ul>
<p><img src="/images/DevOps/kuboard%E9%A6%96%E9%A1%B5%E6%95%88%E6%9E%9C.png" alt=""></p>
</li>
</ul>
<h2 id="10-4-Kubernetes操作"><a href="#10-4-Kubernetes操作" class="headerlink" title="10.4 Kubernetes操作"></a>10.4 Kubernetes操作</h2><p>首先我们要了解Kubernetes在运行我们的资源时，关联到了哪些内容</p>
<ul>
<li><p>资源的构建方式：</p>
<ul>
<li>采用kubectl的命令方式</li>
<li>yaml文件方式</li>
</ul>
</li>
</ul>
<h3 id="10-4-1-Namespace"><a href="#10-4-1-Namespace" class="headerlink" title="10.4.1 Namespace"></a>10.4.1 Namespace</h3><ul>
<li><p>命名空间：主要是为了对Kubernetes中运行的资源进行过隔离， 但是网络是互通的，类似Docker的容器，可以将多个资源配置到一个NameSpace中。而NameSpace可以对不同环境进行资源隔离，默认情况下Kubernetes提供了default命名空间，在构建资源时，如果不指定资源，默认采用default资源。<br>命令方式：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看现有的全部命名空间</span></span><br><span class="line">kubectl get ns</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建命名空间</span></span><br><span class="line">kubectl create ns 命名空间名称</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除现有命名空间， 并且会删除空间下的全部资源</span></span><br><span class="line">kubectl delete ns 命名空间名称</span><br></pre></td></tr></table></figure>

<p>yaml文件方式：（构建资源时，设置命名空间）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="built_in">test</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="10-4-2-Pod"><a href="#10-4-2-Pod" class="headerlink" title="10.4.2 Pod"></a>10.4.2 Pod</h3><ul>
<li><p>Pod：Kubernetes运行的一组容器，Pod是Kubernetes的最小单位，但是对于Docker而然，Pod中会运行多个Docker容器</p>
<ul>
<li><p>命令方式：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有运行的pod</span></span><br><span class="line">kubectl get pods -A</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看指定Namespace下的Pod</span></span><br><span class="line">kubectl get pod [-n 命名空间]  <span class="comment">#（默认default）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建Pod</span></span><br><span class="line">kubectl run pod名称 --image=镜像名称</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Pod详细信息</span></span><br><span class="line">kubectl describe pod pod名称</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除pod</span></span><br><span class="line">kubectl delete pod pod名称 [-n 命名空间]  <span class="comment">#（默认default）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod输出的日志</span></span><br><span class="line">kubectl logs -f pod名称</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进去pod容器内部</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it pod名称 -- bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看kubernetes给Pod分配的ip信息，并且通过ip和容器的端口，可以直接访问</span></span><br><span class="line">kubectl get pod -owide</span><br></pre></td></tr></table></figure>
</li>
<li><p>yaml方式（推荐）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    run: 运行的pod名称</span><br><span class="line">  name: pod名称</span><br><span class="line">  namespace: 命名空间</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: 镜像名称</span><br><span class="line">    name: 容器名称</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Pod：kubectl apply -f yaml文件名称</span></span><br><span class="line"><span class="comment"># 删除Pod：kubectl delete -f yaml文件名称</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Pod中运行多个容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    run: 运行的pod名称</span><br><span class="line">  name: pod名称</span><br><span class="line">  namespace: 命名空间</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: 镜像名称</span><br><span class="line">    name: 容器名称</span><br><span class="line">  - image: 镜像名称</span><br><span class="line">    name: 容器名称</span><br><span class="line">…………</span><br></pre></td></tr></table></figure>

<p>启动后可以查看到</p>
<p><img src="/images/DevOps/Kuboard%E6%95%88%E6%9E%9C.png" alt=""></p>
</li>
</ul>
</li>
</ul>
<h3 id="10-4-3-Deployment"><a href="#10-4-3-Deployment" class="headerlink" title="10.4.3 Deployment"></a>10.4.3 Deployment</h3><p>部署时，可以通过Deployment管理和编排Pod</p>
<p>Deployment部署实现</p>
<ul>
<li><p>命令方式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基于Deployment启动容器</span></span><br><span class="line">kubectl create deployment deployment名称 --image=镜像名称</span><br><span class="line"><span class="comment"># 用deployment启动的容器会在被删除后自动再次创建，达到故障漂移的效果</span></span><br><span class="line"><span class="comment"># 需要使用deploy的方式删除deploy</span></span><br><span class="line"><span class="comment"># 查看现在的deployment</span></span><br><span class="line">kubectl get deployment</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除deployment</span></span><br><span class="line">kubectl delete deployment deployment名称</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基于Deployment启动容器并设置Pod集群数</span></span><br><span class="line">kubectl create deployment deployment名称 --image=镜像名称 --replicas 集群个数</span><br></pre></td></tr></table></figure>
</li>
<li><p><a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noopener">配置文件方式</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deployment</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">       image: nginx</span><br><span class="line">       ports:</span><br><span class="line">       - containerPort: 80</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>弹性伸缩功能</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基于scale实现弹性伸缩</span></span><br><span class="line">kubectl scale deploy/Deployment名称 --replicas 集群个数</span><br><span class="line"><span class="comment"># 或者修改yaml文件</span></span><br><span class="line">kubectl edit deploy Deployment名称</span><br></pre></td></tr></table></figure>

<p><img src="/images/DevOps/%E5%9B%BE%E5%BD%A2%E5%8C%96%E9%A1%B5%E9%9D%A2%E4%BF%AE%E6%94%B9.png" alt=""></p>
</li>
</ul>
<p>灰度发布</p>
<p>Deploy可以在部署新版本数据时，成功启动一个pod，才会下线一个老版本的Pod</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">set</span> image deployment/Deployment名称 容器名=镜像:版本</span><br></pre></td></tr></table></figure>

<h3 id="10-4-4-Service"><a href="#10-4-4-Service" class="headerlink" title="10.4.4 Service"></a>10.4.4 Service</h3><p>可以将多个Pod对外暴露一个Service，让客户端可以通过Service访问到这一组Pod，并且可以实现负载均衡</p>
<h4 id="ClusterIP"><a href="#ClusterIP" class="headerlink" title="ClusterIP"></a>ClusterIP</h4><p>ClusterIP是集群内部Pod之间的访问方式</p>
<ul>
<li><p>命令实现效果</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过生成service映射一个Deployment下的所有pod中的某一个端口的容器</span></span><br><span class="line">kubectl expose deployment Deployment名称 --port=Service端口号 --target-port=Pod内容器端口</span><br></pre></td></tr></table></figure>

<p>之后通过<code>kubectl get service</code>查看Service提供的ip，即可访问</p>
<p>![](/images/DevOps/kubectl get service.png)</p>
</li>
</ul>
<p>也可以通过<code>Deployment名称.namespace名称.svc</code>作为域名访问</p>
<p><img src="/images/DevOps/%E5%9C%A8%E6%9C%8D%E5%8A%A1%E5%AE%B9%E5%99%A8%E5%86%85%E6%89%A7%E8%A1%8C.png" alt=""></p>
<h4 id="NodePort"><a href="#NodePort" class="headerlink" title="NodePort"></a>NodePort</h4><p>ClusterIP的方式只能在Pod内部实现访问，但是一般需要对外暴露网关，所以需要NodePort的方式Pod外暴露访问</p>
<ul>
<li><p>命令实现方式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过生成service映射一个Deployment下的所有pod中的某一个端口的容器</span></span><br><span class="line">kubectl expose deployment Deployment名称 --port=Service端口号 --target-port=Pod内容器端口 --<span class="built_in">type</span>=NodePort</span><br></pre></td></tr></table></figure>

<p><img src="/images/DevOps/%E6%9F%A5%E7%9C%8BService%E6%95%88%E6%9E%9C.png" alt=""></p>
<blockquote>
<p>通过宿主机IP+对外端口访问</p>
</blockquote>
</li>
<li><p>yaml文件实现</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels</span><br><span class="line">    app: nginx</span><br><span class="line">  name: nginx</span><br><span class="line">  spec:</span><br><span class="line">    selector:</span><br><span class="line">      app: nginx</span><br><span class="line">    ports:</span><br><span class="line">    - port: 8888</span><br><span class="line">     protocol: TCP</span><br><span class="line">     targetPort: 80</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deployment</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-deployment</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx-deployment</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-deployment</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx-deployment</span><br><span class="line">        image: nginx</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-service</span><br><span class="line">  name: nginx-service</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-deployment</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8888</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h2 id="10-4-5-Ingress"><a href="#10-4-5-Ingress" class="headerlink" title="10.4.5 Ingress"></a>10.4.5 Ingress</h2><p>Kubernetes推荐将Ingress作为所有Service的入口，提供统一的入口，避免多个服务之间需要记录大量的IP或者域名，毕竟IP可能改变，服务太多域名记录不方便。</p>
<p>Ingress底层其实就是一个Nginx， 可以在Kuboard上直接点击安装</p>
<p><img src="/images/DevOps/Ingress1.png" alt=""></p>
<p><img src="/images/DevOps/Ingress2.png" alt=""></p>
<p>因为副本数默认为1，但是k8s整体集群就2个节点，所以显示下面即为安装成功</p>
<p><img src="/images/DevOps/Ingress3.png" alt=""></p>
<p>可以将Ingress接收到的请求转发到不同的Service中。</p>
<p>推荐使用yaml文件方式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: ingress</span><br><span class="line">  rules:</span><br><span class="line">  - host: nginx.xxx.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: nginx-service</span><br><span class="line">            port:</span><br><span class="line">              number: 8888</span><br></pre></td></tr></table></figure>

<p><img src="/images/DevOps/%E5%90%AF%E5%8A%A8%E6%97%B6%E9%97%AE%E9%A2%98.png" alt="启动时问题"></p>
<p>Kuboard安装的Ingress有admission的校验配置，需要先删除配置再启动</p>
<p>找到指定的ingress的校验信息，删除即可</p>
<p><img src="/images/DevOps/%E5%88%A0%E9%99%A4ingress%E7%9A%84%E6%A0%A1%E9%AA%8C%E4%BF%A1%E6%81%AF.png" alt=""></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看校验webhook的配置</span></span><br><span class="line">kubectl get -A ValidatingWebhookConfiguration</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除指定的校验</span></span><br><span class="line">kubectl delete ValidatingWebhookConfiguration ingress-nginx-admission-my-ingress-controller</span><br></pre></td></tr></table></figure>

<blockquote>
<p>host文件配置nginx.xxx.com映射到宿主机ip</p>
<p>nginx.xxx.com:30717，域名+pod分配的外部端口访问</p>
</blockquote>
<h2 id="10-5-Jenkins集成Kubernetes"><a href="#10-5-Jenkins集成Kubernetes" class="headerlink" title="10.5 Jenkins集成Kubernetes"></a>10.5 Jenkins集成Kubernetes</h2><h3 id="10-5-1-准备部署的yml文件"><a href="#10-5-1-准备部署的yml文件" class="headerlink" title="10.5.1 准备部署的yml文件"></a>10.5.1 准备部署的yml文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  namespace: <span class="built_in">test</span></span><br><span class="line">  name: pipeline</span><br><span class="line">  labels:</span><br><span class="line">    app: pipeline</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: pipeline</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: pipeline    </span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: pipeline</span><br><span class="line">        image: 192.168.11.102:80/repo/pipeline:v4.0.0</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  namespace: <span class="built_in">test</span></span><br><span class="line">  labels:</span><br><span class="line">    app: pipeline</span><br><span class="line">  name: pipeline  </span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: pipeline</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8081</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  namespace: <span class="built_in">test</span></span><br><span class="line">  name: pipeline</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: ingress</span><br><span class="line">  rules:</span><br><span class="line">  - host: xxx.pipeline.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: pipeline</span><br><span class="line">            port:</span><br><span class="line">              number: 8081</span><br></pre></td></tr></table></figure>

<h3 id="10-5-2-Harbor私服配置"><a href="#10-5-2-Harbor私服配置" class="headerlink" title="10.5.2 Harbor私服配置"></a>10.5.2 Harbor私服配置</h3><p>在尝试用kubernetes的yml文件启动pipeline服务时，会出现Kubernetes无法拉取镜像的问题，这里需要在kubernetes所在的Linux中配置Harbor服务信息，并且保证Kubernetes可以拉取Harbor上的镜像</p>
<ul>
<li><p>设置Master和Worker的私服地址信息</p>
<p><img src="/images/DevOps/jenkins-%E8%AE%BE%E7%BD%AEHarbor%E7%A7%81%E6%9C%8D%E5%9C%B0%E5%9D%80.png" alt=""></p>
</li>
<li><p>在Kuboard上设置私服密文信息</p>
<p><img src="/images/DevOps/Kuboard%E4%B8%8A%E8%AE%BE%E7%BD%AE%E7%A7%81%E6%9C%8D%E5%AF%86%E6%96%87%E4%BF%A1%E6%81%AF.png" alt=""></p>
<p>按照复制指令的位置测试认证，效果如下</p>
<p><img src="/images/DevOps/%E5%A4%8D%E5%88%B6%E6%8C%87%E4%BB%A4%E7%9A%84%E4%BD%8D%E7%BD%AE%E6%B5%8B%E8%AF%95%E8%AE%A4%E8%AF%81.png" alt=""></p>
</li>
</ul>
<h3 id="10-5-3-测试使用效果"><a href="#10-5-3-测试使用效果" class="headerlink" title="10.5.3 测试使用效果"></a>10.5.3 测试使用效果</h3><p>执行kubectl命令，基于yml启动服务，并且基于部署后服务的提示信息以及Ingress的设置，直接访问</p>
<h4 id="10-5-3-1-Jenkins远程调用"><a href="#10-5-3-1-Jenkins远程调用" class="headerlink" title="10.5.3.1 Jenkins远程调用"></a>10.5.3.1 Jenkins远程调用</h4><ul>
<li><p>将pipeline.yml配置到Gitlab中</p>
<p><img src="/images/DevOps/pipeline.yml%E9%85%8D%E7%BD%AE%E5%88%B0Gitlab.png" alt=""></p>
</li>
<li><p>配置Jenkins的目标服务器，可以将yml文件传输到K8s的Master上</p>
<p><img src="/images/DevOps/%E8%AE%BE%E7%BD%AE%E7%9B%AE%E6%A0%87%E6%9C%8D%E5%8A%A1%E5%99%A8.png" alt=""></p>
</li>
<li><p>修改Jenkinsfile，重新设置流水线任务脚本，并测试效果</p>
<p><img src="/images/DevOps/%E4%BC%A0%E9%80%92yml%E6%96%87%E4%BB%B6%E8%84%9A%E6%9C%AC.png" alt=""></p>
<p><img src="/images/DevOps/%E4%BC%A0%E9%80%92yml%E6%96%87%E4%BB%B6%E8%84%9A%E6%9C%AC2.png" alt=""></p>
</li>
<li><p>设置Jenkins无密码登录k8s-master</p>
<p>将Jenkins中公钥信息复制到k8s-master的~/.ssh/authorized_keysz中，保证远程连接无密码</p>
<p><img src="/images/DevOps/%E8%BF%9C%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E6%97%A0%E9%9C%80%E5%AF%86%E7%A0%81.png" alt=""></p>
</li>
<li><p>设置执行kubectl的脚本到Jenkinsfile</p>
<p><img src="/images/DevOps/%E8%AE%BE%E7%BD%AEJenkinsfile.png" alt=""></p>
</li>
<li><p>执行查看效果</p>
<p><img src="/images/DevOps/%E6%89%A7%E8%A1%8C%E6%B5%81%E6%B0%B4%E7%BA%BF.png" alt=""></p>
<p>可以查看到yml文件是有变化的， 这样k8s就会重新加载</p>
<p>这种方式更适应与CD操作，将项目将基于某个版本部署到指定的目标服务器</p>
</li>
</ul>
<h2 id="10-6-基于GitLab的WebHooks"><a href="#10-6-基于GitLab的WebHooks" class="headerlink" title="10.6 基于GitLab的WebHooks"></a>10.6 基于GitLab的WebHooks</h2><p>这里要实现自动化的一个CI操作，也就是开发人员Push代码到Git仓库后，Jenkins会自动的构建项目，将最新的提交点代码构建并进行打包部署，这里区别去上述的CD操作，CD操作需要基于某个版本进行部署，而这里每次都是将最新的提交点集成到主干上并测试。</p>
<h3 id="10-6-1-WebHooks通知"><a href="#10-6-1-WebHooks通知" class="headerlink" title="10.6.1 WebHooks通知"></a>10.6.1 WebHooks通知</h3><p>开启Jenkins的自动构建</p>
<p><img src="/images/DevOps/%E6%9E%84%E5%BB%BA%E8%A7%A6%E5%8F%91%E5%99%A8.png" alt=""></p>
<p>设置Gitlab的Webhooks</p>
<p><img src="/images/DevOps/%E8%AE%BE%E7%BD%AEGitlab%E7%9A%84Webhooks.png" alt=""></p>
<p>需要关闭Jenkins的Gitlab认证</p>
<p><img src="/images/DevOps/%E5%85%B3%E9%97%ADJenkins%E7%9A%84Gitlab%E8%AE%A4%E8%AF%81.png" alt=""></p>
<p>再次测试Gitlab</p>
<p><img src="/images/DevOps/%E5%86%8D%E6%AC%A1%E6%B5%8B%E8%AF%95Gitlab.png" alt=""></p>
<h3 id="10-6-2-修改配置"><a href="#10-6-2-修改配置" class="headerlink" title="10.6.2 修改配置"></a>10.6.2 修改配置</h3><p>修改Jenkinsfile实现基于最新提交点实现持续集成效果，将之前引用${tag}的全部去掉</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">// 所有的脚本命令都放在pipeline中</span><br><span class="line">pipeline&#123;</span><br><span class="line">	// 指定任务再哪个集群节点中执行</span><br><span class="line">	agent any</span><br><span class="line"></span><br><span class="line">	// 声明全局变量，方便后面使用</span><br><span class="line">	environment &#123;</span><br><span class="line">		harborUser = <span class="string">'admin'</span></span><br><span class="line">        harborPasswd = <span class="string">'Harbor12345'</span></span><br><span class="line">        harborAddress = <span class="string">'192.168.11.102:80'</span></span><br><span class="line">        harborRepo = <span class="string">'repo'</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">'拉取git仓库代码'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                checkout([<span class="variable">$class</span>: <span class="string">'GitSCM'</span>, branches: [[name: <span class="string">'*/master'</span>]], extensions: [], userRemoteConfigs: [[url: <span class="string">'http://192.168.11.101:8929/root/mytest.git'</span>]]])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">'通过maven构建项目'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">'/var/jenkins_home/maven/bin/mvn clean package -DskipTests'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">'通过SonarQube做代码质量检测'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">'/var/jenkins_home/sonar-scanner/bin/sonar-scanner -Dsonar.source=./ -Dsonar.projectname=$&#123;JOB_NAME&#125; -Dsonar.projectKey=$&#123;JOB_NAME&#125; -Dsonar.java.binaries=./target/ -Dsonar.login=40306ae8ea69a4792df2ceb4d9d25fe8a6ab1701'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">'通过Docker制作自定义镜像'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">''</span><span class="string">'mv ./target/*.jar ./docker/</span></span><br><span class="line"><span class="string">                docker build -t $&#123;JOB_NAME&#125;:latest ./docker/'</span><span class="string">''</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">'将自定义镜像推送到Harbor'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">''</span><span class="string">'docker login -u $&#123;harborUser&#125; -p $&#123;harborPasswd&#125; $&#123;harborAddress&#125;</span></span><br><span class="line"><span class="string">                docker tag $&#123;JOB_NAME&#125;:latest  $&#123;harborAddress&#125;/$&#123;harborRepo&#125;/$&#123;JOB_NAME&#125;:latest</span></span><br><span class="line"><span class="string">                docker push $&#123;harborAddress&#125;/$&#123;harborRepo&#125;/$&#123;JOB_NAME&#125;:latest '</span><span class="string">''</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">'将yml文件传到k8s-master上'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sshPublisher(publishers: [sshPublisherDesc(configName: <span class="string">'k8s'</span>, transfers: [sshTransfer(cleanRemote: <span class="literal">false</span>, excludes: <span class="string">''</span>, execCommand: <span class="string">''</span>, execTimeout: 120000, flatten: <span class="literal">false</span>, makeEmptyDirs: <span class="literal">false</span>, noDefaultExcludes: <span class="literal">false</span>, patternSeparator: <span class="string">'[, ]+'</span>, remoteDirectory: <span class="string">''</span>, remoteDirectorySDF: <span class="literal">false</span>, removePrefix: <span class="string">''</span>, sourceFiles: <span class="string">'pipeline.yml'</span>)], usePromotionTimestamp: <span class="literal">false</span>, useWorkspaceInPromotion: <span class="literal">false</span>, verbose: <span class="literal">false</span>)])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">'远程执行k8s-master的kubectl命令'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">               sh <span class="string">''</span><span class="string">'ssh root@192.168.11.201 kubectl apply -f /usr/local/k8s/pipeline.yml</span></span><br><span class="line"><span class="string">                ssh root@192.168.11.201 kubectl rollout restart deployment pipeline -n test'</span><span class="string">''</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    post &#123;</span><br><span class="line">        success &#123;</span><br><span class="line">            dingtalk(</span><br><span class="line">                robot: <span class="string">'Jenkins-DingDing'</span>,</span><br><span class="line">                <span class="built_in">type</span>: <span class="string">'MARKDOWN'</span>,</span><br><span class="line">                title: <span class="string">"success: <span class="variable">$&#123;JOB_NAME&#125;</span>"</span>,</span><br><span class="line">                text: [<span class="string">"- 成功构建：<span class="variable">$&#123;JOB_NAME&#125;</span>! \n- 版本：latest \n- 持续时间：<span class="variable">$&#123;currentBuild.durationString&#125;</span>"</span> ]</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">        failure &#123;</span><br><span class="line">            dingtalk(</span><br><span class="line">                robot: <span class="string">'Jenkins-DingDing'</span>,</span><br><span class="line">                <span class="built_in">type</span>: <span class="string">'MARKDOWN'</span>,</span><br><span class="line">                title: <span class="string">"success: <span class="variable">$&#123;JOB_NAME&#125;</span>"</span>,</span><br><span class="line">                text: [<span class="string">"- 构建失败：<span class="variable">$&#123;JOB_NAME&#125;</span>! \n- 版本：latest \n- 持续时间：<span class="variable">$&#123;currentBuild.durationString&#125;</span>"</span> ]</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改pipeline.yml，更改镜像版本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  namespace: <span class="built_in">test</span></span><br><span class="line">  name: pipeline</span><br><span class="line">  labels:</span><br><span class="line">    app: pipeline</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: pipeline</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: pipeline    </span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: pipeline</span><br><span class="line">        image: 192.168.11.102:80/repo/pipeline:latest   <span class="comment"># 这里</span></span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line"><span class="comment"># 省略其他内容…………</span></span><br></pre></td></tr></table></figure>

<h3 id="10-6-3-滚动更新"><a href="#10-6-3-滚动更新" class="headerlink" title="10.6.3 滚动更新"></a>10.6.3 滚动更新</h3><p>因为pipeline没有改变时，每次不会重新加载，这样会导致Pod中的容器不会动态更新，这里需要使用kubectl的rollout restart命令滚动更新</p>
<p><img src="/images/DevOps/%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B01.png" alt=""></p>
<p><img src="/images/DevOps/%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B02.png" alt=""></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/devops/" rel="tag"># devops</a>
              <a href="/tags/docker/" rel="tag"># docker</a>
              <a href="/tags/gitlab/" rel="tag"># gitlab</a>
              <a href="/tags/jenkins/" rel="tag"># jenkins</a>
              <a href="/tags/K8s/" rel="tag"># K8s</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/11/16/k8s-%E5%AD%98%E5%82%A8%E5%8D%B7/" rel="prev" title="K8s-存储卷">
      <i class="fa fa-chevron-left"></i> K8s-存储卷
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#一、DevOps介绍"><span class="nav-text">一、DevOps介绍</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二、Code阶段工具"><span class="nav-text">二、Code阶段工具</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-Git安装"><span class="nav-text">2.1 Git安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-GitLab安装"><span class="nav-text">2.2 GitLab安装</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三、Build阶段工具"><span class="nav-text">三、Build阶段工具</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#四、Operate阶段工具"><span class="nav-text">四、Operate阶段工具</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-Docker安装"><span class="nav-text">4.1 Docker安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-Docker-Compose安装"><span class="nav-text">4.2 Docker-Compose安装</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#五、Integrate工具"><span class="nav-text">五、Integrate工具</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-Jenkins介绍"><span class="nav-text">5.1 Jenkins介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-Jenkins安装"><span class="nav-text">5.2 Jenkins安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-Jenkins入门配置"><span class="nav-text">5.3 Jenkins入门配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-1-构建任务"><span class="nav-text">5.3.1 构建任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-2-配置源码拉取地址"><span class="nav-text">5.3.2 配置源码拉取地址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-3-配置Maven构建代码"><span class="nav-text">5.3.3 配置Maven构建代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-4-配置Publish发布-amp-远程操作"><span class="nav-text">5.3.4 配置Publish发布&amp;远程操作</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#六、CI、CD入门操作"><span class="nav-text">六、CI、CD入门操作</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-持续集成"><span class="nav-text">6.1 持续集成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-持续交付、部署"><span class="nav-text">6.2 持续交付、部署</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#七、集成Sonar-Qube"><span class="nav-text">七、集成Sonar Qube</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#7-1-Sonar-Qube介绍"><span class="nav-text">7.1 Sonar Qube介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-2-Sonar-Qube环境搭建"><span class="nav-text">7.2 Sonar Qube环境搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-1-Sonar-Qube安装"><span class="nav-text">7.2.1 Sonar Qube安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-2-安装中文插件"><span class="nav-text">7.2.2 安装中文插件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-3-Sonar-Qube基本使用"><span class="nav-text">7.3 Sonar Qube基本使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-1-Maven实现代码检测"><span class="nav-text">7.3.1 Maven实现代码检测</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-2-Sonar-scanner实现代码检测"><span class="nav-text">7.3.2 Sonar-scanner实现代码检测</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-4-Jenkins集成Sonar-Qube"><span class="nav-text">7.4 Jenkins集成Sonar Qube</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-1-Jenkins安装插件"><span class="nav-text">7.4.1 Jenkins安装插件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-2-Jenkins配置Sonar-Qube"><span class="nav-text">7.4.2 Jenkins配置Sonar Qube</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-3-配置Sonar-scanner"><span class="nav-text">7.4.3 配置Sonar-scanner</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-4-构建任务"><span class="nav-text">7.4.4 构建任务</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#八、集成Harbor"><span class="nav-text">八、集成Harbor</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8-1-Harbor介绍"><span class="nav-text">8.1 Harbor介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-2-Harbor安装"><span class="nav-text">8.2 Harbor安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-3-Harbor使用方式"><span class="nav-text">8.3 Harbor使用方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-1-添加用户构建项目"><span class="nav-text">8.3.1 添加用户构建项目</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-2-发布镜像到Harbor"><span class="nav-text">8.3.2 发布镜像到Harbor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-3-从Harbor拉取镜像"><span class="nav-text">8.3.3 从Harbor拉取镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-4-Jenkins容器使用宿主机Docker"><span class="nav-text">8.3.4 Jenkins容器使用宿主机Docker</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-5-添加构建操作"><span class="nav-text">8.3.5 添加构建操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-6-编写部署脚本"><span class="nav-text">8.3.6 编写部署脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-7-配置构建后操作"><span class="nav-text">8.3.7 配置构建后操作</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#九、Jenkins流水线"><span class="nav-text">九、Jenkins流水线</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#9-1-Jenkins流水线任务介绍"><span class="nav-text">9.1 Jenkins流水线任务介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-2-Jenkins流水线任务"><span class="nav-text">9.2 Jenkins流水线任务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-1-构建Jenkins流水线任务"><span class="nav-text">9.2.1 构建Jenkins流水线任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-2-Groovy脚本"><span class="nav-text">9.2.2 Groovy脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-3-Jenkinsfile实现"><span class="nav-text">9.2.3 Jenkinsfile实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-3-Jenkins流水线任务实现"><span class="nav-text">9.3 Jenkins流水线任务实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-3-1-参数化构建"><span class="nav-text">9.3.1 参数化构建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-3-2-拉取Git代码"><span class="nav-text">9.3.2 拉取Git代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-3-3-构建代码"><span class="nav-text">9.3.3 构建代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-3-4-代码质量检测"><span class="nav-text">9.3.4 代码质量检测</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-3-5-制作自定义镜像并发布"><span class="nav-text">9.3.5 制作自定义镜像并发布</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-4-Jenkins流水线整合钉钉"><span class="nav-text">9.4 Jenkins流水线整合钉钉</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#十、Kubernetes编排工具"><span class="nav-text">十、Kubernetes编排工具</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#10-1-Kubernetes介绍"><span class="nav-text">10.1 Kubernetes介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-2-Kubernetes架构"><span class="nav-text">10.2 Kubernetes架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-3-Kubernetes安装"><span class="nav-text">10.3 Kubernetes安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-4-Kubernetes操作"><span class="nav-text">10.4 Kubernetes操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-4-1-Namespace"><span class="nav-text">10.4.1 Namespace</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-4-2-Pod"><span class="nav-text">10.4.2 Pod</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-4-3-Deployment"><span class="nav-text">10.4.3 Deployment</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-4-4-Service"><span class="nav-text">10.4.4 Service</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ClusterIP"><span class="nav-text">ClusterIP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NodePort"><span class="nav-text">NodePort</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-4-5-Ingress"><span class="nav-text">10.4.5 Ingress</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-5-Jenkins集成Kubernetes"><span class="nav-text">10.5 Jenkins集成Kubernetes</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-5-1-准备部署的yml文件"><span class="nav-text">10.5.1 准备部署的yml文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-5-2-Harbor私服配置"><span class="nav-text">10.5.2 Harbor私服配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-5-3-测试使用效果"><span class="nav-text">10.5.3 测试使用效果</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#10-5-3-1-Jenkins远程调用"><span class="nav-text">10.5.3.1 Jenkins远程调用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-6-基于GitLab的WebHooks"><span class="nav-text">10.6 基于GitLab的WebHooks</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-6-1-WebHooks通知"><span class="nav-text">10.6.1 WebHooks通知</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-6-2-修改配置"><span class="nav-text">10.6.2 修改配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-6-3-滚动更新"><span class="nav-text">10.6.3 滚动更新</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yrl"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">yrl</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">97</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">37</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">47</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yrl</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  
</body>
</html>
