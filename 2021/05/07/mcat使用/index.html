<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yrlzero.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="一、读写分离​    通过mycat和mysql的主从复制配合搭建数据库的读写分离，可以实现mysql的高可用性。 修改mycat的schema.xml配置">
<meta property="og:type" content="article">
<meta property="og:title" content="mycat使用">
<meta property="og:url" content="http://yrlzero.github.io/2021/05/07/mcat%E4%BD%BF%E7%94%A8/index.html">
<meta property="og:site_name" content="yrl&#39;s blog">
<meta property="og:description" content="一、读写分离​    通过mycat和mysql的主从复制配合搭建数据库的读写分离，可以实现mysql的高可用性。 修改mycat的schema.xml配置">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yrlzero.github.io/images/linux/mycat/mycat%E6%8F%92%E5%85%A5.jpg">
<meta property="og:image" content="http://yrlzero.github.io/images/linux/mycat/%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%9F%A5%E8%AF%A2.jpg">
<meta property="og:image" content="http://yrlzero.github.io/images/linux/mycat/mycat%E5%A4%9A%E4%B8%BB%E5%A4%9A%E4%BB%8E.jpg">
<meta property="og:image" content="http://yrlzero.github.io/images/linux/mycat/%E5%88%86%E5%BA%93-01.jpg">
<meta property="og:image" content="http://yrlzero.github.io/images/linux/mycat/%E5%88%86%E5%BA%93-02.jpg">
<meta property="og:image" content="http://yrlzero.github.io/images/linux/mycat/%E5%88%86%E8%A1%A8-%E5%8F%96%E6%A8%A1.jpg">
<meta property="og:image" content="http://yrlzero.github.io/images/linux/mycat/%E5%88%86%E7%89%87-%E5%88%86%E7%89%87%E6%9E%9A%E4%B8%BE.jpg">
<meta property="og:image" content="http://yrlzero.github.io/images/linux/mycat/%E5%88%86%E7%89%87-%E8%8C%83%E5%9B%B4%E5%88%86%E7%89%87.jpg">
<meta property="og:image" content="http://yrlzero.github.io/images/linux/mycat/%E5%88%86%E7%89%87-%E8%8C%83%E5%9B%B4%E6%B1%82%E6%A8%A1.jpg">
<meta property="og:image" content="http://yrlzero.github.io/images/linux/mycat/%E5%88%86%E7%89%87-%E5%9B%BA%E5%AE%9A%E5%88%86%E7%89%87hash%E7%AE%97%E6%B3%95.jpg">
<meta property="og:image" content="http://yrlzero.github.io/images/linux/mycat/%E5%88%86%E7%89%87-%E5%8F%96%E6%A8%A1%E8%8C%83%E5%9B%B4%E7%AE%97%E6%B3%95-1620120538787.jpg">
<meta property="og:image" content="http://yrlzero.github.io/images/linux/mycat/%E5%88%86%E7%89%87-%E5%AD%97%E7%AC%A6%E4%B8%B2hash%E6%B1%82%E6%A8%A1%E8%8C%83%E5%9B%B4%E7%AE%97%E6%B3%95.jpg">
<meta property="og:image" content="http://yrlzero.github.io/images/linux/mycat/%E5%88%86%E7%89%87-%E5%BA%94%E7%94%A8%E6%8C%87%E5%AE%9A%E7%9A%84%E7%AE%97%E6%B3%95.jpg">
<meta property="og:image" content="http://yrlzero.github.io/images/linux/mycat/%E5%88%86%E7%89%87-%E5%AD%97%E7%AC%A6%E4%B8%B2hash%E8%A7%A3%E6%9E%90%E7%AE%97%E6%B3%95.jpg">
<meta property="og:image" content="http://yrlzero.github.io/images/linux/mycat/%E5%88%86%E7%89%87-%E6%8C%89%E7%85%A7%E6%97%A5%E6%9C%9F%E8%8C%83%E5%9B%B4%E5%88%86%E7%89%87.jpg">
<meta property="og:image" content="http://yrlzero.github.io/images/linux/mycat/%E5%88%86%E8%A1%A8-%E6%8C%89%E5%8D%95%E6%9C%88%E5%B0%8F%E6%97%B6%E5%88%86%E7%89%87.jpg">
<meta property="og:image" content="http://yrlzero.github.io/images/linux/mycat/%E5%88%86%E8%A1%A8-%E6%97%A5%E6%9C%9F%E8%8C%83%E5%9B%B4hash%E5%88%86%E7%89%87.jpg">
<meta property="og:image" content="http://yrlzero.github.io/images/linux/mycat/%E5%88%86%E8%A1%A8-%E5%86%B7%E7%83%AD%E6%95%B0%E6%8D%AE%E5%88%86%E7%89%87.jpg">
<meta property="og:image" content="http://yrlzero.github.io/images/linux/mycat/%E5%88%86%E7%89%87-%E8%87%AA%E7%84%B6%E6%9C%88%E5%88%86%E7%89%87.jpg">
<meta property="og:image" content="http://yrlzero.github.io/images/linux/mycat/%E5%88%86%E7%89%87-%E4%B8%80%E8%87%B4%E6%80%A7hash.jpg">
<meta property="og:image" content="http://yrlzero.github.io/images/linux/mycat/%E5%85%A8%E5%B1%80%E8%A1%A8.jpg">
<meta property="og:image" content="http://yrlzero.github.io/images/linux/mycat/er%E5%88%86%E7%89%87.jpg">
<meta property="article:published_time" content="2021-05-07T14:00:00.000Z">
<meta property="article:modified_time" content="2021-06-10T14:13:39.550Z">
<meta property="article:author" content="yrl">
<meta property="article:tag" content="mysql">
<meta property="article:tag" content="db">
<meta property="article:tag" content="mycat">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yrlzero.github.io/images/linux/mycat/mycat%E6%8F%92%E5%85%A5.jpg">

<link rel="canonical" href="http://yrlzero.github.io/2021/05/07/mcat%E4%BD%BF%E7%94%A8/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>mycat使用 | yrl's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">yrl's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yrlzero.github.io/2021/05/07/mcat%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="yrl">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yrl's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          mycat使用
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-07 22:00:00" itemprop="dateCreated datePublished" datetime="2021-05-07T22:00:00+08:00">2021-05-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-10 22:13:39" itemprop="dateModified" datetime="2021-06-10T22:13:39+08:00">2021-06-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="一、读写分离"><a href="#一、读写分离" class="headerlink" title="一、读写分离"></a>一、读写分离</h2><p>​    通过<a href="/2021/04/29/mycat%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BD%BF%E7%94%A8/#%E5%AE%89%E8%A3%85">mycat</a>和<a href="/2021/04/28/mysql%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/#%E4%B8%80%E4%B8%BB%E4%B8%80%E4%BB%8E">mysql的主从复制</a>配合搭建数据库的读写分离，可以实现mysql的高可用性。</p>
<p>修改mycat的<code>schema.xml</code>配置</p>
<a id="more"></a>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mycat</span>:schema <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"schema.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">"http://io.mycat/"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">"TESTDB"</span> <span class="attr">checkSQLschema</span>=<span class="string">"false"</span> <span class="attr">sqlMaxLimit</span>=<span class="string">"100"</span> <span class="attr">dataNode</span>=<span class="string">"dn1"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">"dn1"</span> <span class="attr">dataHost</span>=<span class="string">"host1"</span> <span class="attr">database</span>=<span class="string">"my_multi_test"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 修改负载策略</span></span><br><span class="line"><span class="comment">	balance=1:全部的readhost和stand by writehost参与select 语句的负载均衡，简单的说，当双主双从模式下，其他的节点都参与select语句的负载均衡	</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">"host1"</span> <span class="attr">maxCon</span>=<span class="string">"1000"</span> <span class="attr">minCon</span>=<span class="string">"10"</span> <span class="attr">balance</span>=<span class="string">"1"</span></span></span><br><span class="line"><span class="tag">			  <span class="attr">writeType</span>=<span class="string">"0"</span> <span class="attr">dbType</span>=<span class="string">"mysql"</span> <span class="attr">dbDriver</span>=<span class="string">"native"</span> <span class="attr">switchType</span>=<span class="string">"1"</span>  <span class="attr">slaveThreshold</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">       	 <span class="comment">&lt;!--master-1--&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">"hostM1"</span> <span class="attr">url</span>=<span class="string">"192.168.243.131:3306"</span> <span class="attr">user</span>=<span class="string">"root"</span></span></span><br><span class="line"><span class="tag">				   <span class="attr">password</span>=<span class="string">"Root_123"</span>&gt;</span></span><br><span class="line">            	<span class="comment">&lt;!--slave-1--&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">"hostS1"</span> <span class="attr">url</span>=<span class="string">"192.168.243.132:3306"</span> <span class="attr">user</span>=<span class="string">"root"</span> <span class="attr">password</span>=<span class="string">"Root_123"</span>&gt;</span><span class="tag">&lt;/<span class="name">readHost</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        	<span class="comment">&lt;!--master-2--&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">"hostM2"</span> <span class="attr">url</span>=<span class="string">"192.168.243.133:3306"</span> <span class="attr">user</span>=<span class="string">"root"</span></span></span><br><span class="line"><span class="tag">				   <span class="attr">password</span>=<span class="string">"Root_123"</span>&gt;</span></span><br><span class="line">            	<span class="comment">&lt;!--slave-2--&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">"hostS2"</span> <span class="attr">url</span>=<span class="string">"192.168.243.134:3306"</span> <span class="attr">user</span>=<span class="string">"root"</span> <span class="attr">password</span>=<span class="string">"Root_123"</span>&gt;</span><span class="tag">&lt;/<span class="name">readHost</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="writeType"><a href="#writeType" class="headerlink" title="writeType"></a>writeType</h3><p>​    表示写操作发送到哪台机器</p>
<ul>
<li>writeType=0:所有写操作都发送到配置的第一个writeHost，第一个挂了切换到还生存的第二个</li>
<li>writeType=1:所有写操作都随机的发送到配置的writehost中，1.5之后废弃</li>
</ul>
<h3 id="switchType"><a href="#switchType" class="headerlink" title="switchType"></a>switchType</h3><p>​    表示如何进行切换</p>
<ul>
<li><p>switchType=1:默认值，自动切换</p>
</li>
<li><p>switchType=-1:表示不自动切换</p>
</li>
<li><p>switchType=2：基于mysql主从同步的状态决定是否切换</p>
</li>
</ul>
<h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p>重启<code>mycat restart</code></p>
<p>连接mycat <code>mysql -uroot -pRoot_123 -P 8066 -h 192.168.243.131</code></p>
<p>执行插入语句 <code>insert into t1 values(2,@@hostname);</code></p>
<p>分别连接四台mysql查询结果</p>
<p><img src="/images/linux/mycat/mycat%E6%8F%92%E5%85%A5.jpg" alt=""></p>
<p>连接mycat查询结果</p>
<img src="/images/linux/mycat/读写分离查询.jpg" style="zoom: 80%;" />



<p>到此，mysql双主双从结合mycat搭建读写分离完成，架构如下图所示</p>
<img src="/images/linux/mycat/mycat多主多从.jpg" style="zoom: 60%;" />

<ul>
<li>当查询时，会被分发到<code>slave-1</code>、<code>master-2</code>、<code>slave-2</code>这三台机器上；</li>
<li>当写操作时，会被分发到<code>master-1</code>上；</li>
<li>如果<code>master-1</code>宕机，mycat会将写操作自动切换到<code>master-2</code>，之后如果<code>master-1</code>恢复（从master-2同步数据，slave-1再从master-1同步数据），也只提供读服务，写仍由<code>master-2</code>提供。</li>
</ul>
<hr>
<h2 id="二、分库分表"><a href="#二、分库分表" class="headerlink" title="二、分库分表"></a>二、分库分表</h2><p>​        数据的切分，主要有两种方式，分别是垂直切分和水平切分，所谓的垂直切分就是将不同的表分布在不同的数据库实例中，而水平切分指的是将一张表的数据按照不同的切分规则切分在不同实例的相同名称的表中。</p>
<h3 id="1、分库"><a href="#1、分库" class="headerlink" title="1、分库"></a>1、分库</h3><p>将不同的表分布在不同的库中，但是访问的时候使用的是同一个mycat的终端，这些操作都由mycat来完成的，我们只需修改相应的配置即可。</p>
<h4 id="1-1、修改-etc-my-cnf文件"><a href="#1-1、修改-etc-my-cnf文件" class="headerlink" title="1.1、修改/etc/my.cnf文件"></a>1.1、修改<code>/etc/my.cnf</code>文件</h4><p>​        在mycat操作时它是不区分表明大小写的，需要在mysql的配置文件中添加<code>lower_case_table_names=1</code>参数，来保证查询的时候能够进行正常的查询。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lower_case_table_names&#x3D;1</span><br></pre></td></tr></table></figure>

<h4 id="1-2、重启mysql"><a href="#1-2、重启mysql" class="headerlink" title="1.2、重启mysql"></a>1.2、重启mysql</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重启</span></span><br><span class="line">service mysqld restart</span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">service mysqld status</span><br></pre></td></tr></table></figure>

<h4 id="1-3、修改schema-xml文件"><a href="#1-3、修改schema-xml文件" class="headerlink" title="1.3、修改schema.xml文件"></a>1.3、修改<code>schema.xml</code>文件</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mycat</span>:schema <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"schema.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">"http://io.mycat/"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">"TESTDB"</span> <span class="attr">checkSQLschema</span>=<span class="string">"false"</span> <span class="attr">sqlMaxLimit</span>=<span class="string">"100"</span> <span class="attr">dataNode</span>=<span class="string">"dn1"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 指定customer表分发到db2进行操作，其余未指定的表默认dn1 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span> = <span class="string">"customer"</span> <span class="attr">dataNode</span>=<span class="string">"dn2"</span>&gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">        <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">"dn1"</span> <span class="attr">dataHost</span>=<span class="string">"host1"</span> <span class="attr">database</span>=<span class="string">"my_db"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">"dn2"</span> <span class="attr">dataHost</span>=<span class="string">"host2"</span> <span class="attr">database</span>=<span class="string">"my_db"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">"host1"</span> <span class="attr">maxCon</span>=<span class="string">"1000"</span> <span class="attr">minCon</span>=<span class="string">"10"</span> <span class="attr">balance</span>=<span class="string">"1"</span></span></span><br><span class="line"><span class="tag">                          <span class="attr">writeType</span>=<span class="string">"0"</span> <span class="attr">dbType</span>=<span class="string">"mysql"</span> <span class="attr">dbDriver</span>=<span class="string">"native"</span> <span class="attr">switchType</span>=<span class="string">"1"</span>  <span class="attr">slaveThreshold</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">&lt;!--master-1--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">"hostM1"</span> <span class="attr">url</span>=<span class="string">"192.168.243.131:3306"</span> <span class="attr">user</span>=<span class="string">"root"</span> <span class="attr">password</span>=<span class="string">"Root_123"</span>&gt;</span></span><br><span class="line">			<span class="comment">&lt;!--slave-1--&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">"hostS1"</span> <span class="attr">url</span>=<span class="string">"192.168.243.132:3306"</span> <span class="attr">user</span>=<span class="string">"root"</span> <span class="attr">password</span>=<span class="string">"Root_123"</span>&gt;</span><span class="tag">&lt;/<span class="name">readHost</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">"host2"</span> <span class="attr">maxCon</span>=<span class="string">"1000"</span> <span class="attr">minCon</span>=<span class="string">"10"</span> <span class="attr">balance</span>=<span class="string">"1"</span></span></span><br><span class="line"><span class="tag">                          <span class="attr">writeType</span>=<span class="string">"0"</span> <span class="attr">dbType</span>=<span class="string">"mysql"</span> <span class="attr">dbDriver</span>=<span class="string">"native"</span> <span class="attr">switchType</span>=<span class="string">"1"</span>  <span class="attr">slaveThreshold</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">                </span><br><span class="line">				<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--master-2--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">"hostM2"</span> <span class="attr">url</span>=<span class="string">"192.168.243.133:3306"</span> <span class="attr">user</span>=<span class="string">"root"</span> <span class="attr">password</span>=<span class="string">"Root_123"</span>&gt;</span></span><br><span class="line">			<span class="comment">&lt;!--slave-2--&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">"hostS2"</span> <span class="attr">url</span>=<span class="string">"192.168.243.134:3306"</span> <span class="attr">user</span>=<span class="string">"root"</span> <span class="attr">password</span>=<span class="string">"Root_123"</span>&gt;</span><span class="tag">&lt;/<span class="name">readHost</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="1-4、重启mycat"><a href="#1-4、重启mycat" class="headerlink" title="1.4、重启mycat"></a>1.4、重启mycat</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重启</span></span><br><span class="line">mycat restart</span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">mycat status</span><br></pre></td></tr></table></figure>

<h4 id="1-5、停止master的slave服务"><a href="#1-5、停止master的slave服务" class="headerlink" title="1.5、停止master的slave服务"></a>1.5、停止<code>master</code>的slave服务</h4><p>​        使用mycat进行分库操作之前，需要分别登陆<code>master-1</code>和<code>master-2</code>执行<code>stop slave</code>，将它们的主备关系去除，否则相互之间会进行数据同步，起不到分库的作用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-- 停止slave服务</span><br><span class="line">stop slave;</span><br><span class="line">-- 查看状态</span><br><span class="line">show slave status\G</span><br></pre></td></tr></table></figure>

<p>登陆<code>master-1</code>和<code>master-2</code>的mysql服务分别创建my_db数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create database my_db;</span><br></pre></td></tr></table></figure>

<h4 id="1-6、验证"><a href="#1-6、验证" class="headerlink" title="1.6、验证"></a>1.6、验证</h4><h5 id="登陆mcat"><a href="#登陆mcat" class="headerlink" title="登陆mcat"></a>登陆mcat</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -pRoot_123 -h 192.168.243.131 -P 8066</span><br></pre></td></tr></table></figure>

<h5 id="建表"><a href="#建表" class="headerlink" title="建表"></a>建表</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> customer(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">INT</span> AUTO_INCREMENT,</span><br><span class="line">    <span class="keyword">NAME</span> <span class="built_in">VARCHAR</span>(<span class="number">200</span>),</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(<span class="keyword">id</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><img src="/images/linux/mycat/%E5%88%86%E5%BA%93-01.jpg" alt=""></p>
<blockquote>
<p>由上图可以看到，<code>mycat</code>的建表语句被分发到了<code>master-2</code>执行，并且因为<code>master-2</code>与<code>slave-2</code>主从同步，<code>slave-2</code>也出现了customer表。</p>
</blockquote>
<h5 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> customer <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'zhangsan'</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/images/linux/mycat/%E5%88%86%E5%BA%93-02.jpg" alt=""></p>
<blockquote>
<p>由上图可以看到，<code>mycat</code>插入的语句被分发到了<code>master-2</code>执行，并且因为<code>master-2</code>与<code>slave-2</code>主从同步，<code>slave-2</code>也出现了相关的数据。</p>
</blockquote>
<hr>
<h3 id="2、分表（分片）"><a href="#2、分表（分片）" class="headerlink" title="2、分表（分片）"></a>2、分表（分片）</h3><p>​        相对于垂直拆分，水平拆分不是将表做分类，而是按照某个字段的某种规则来分散到多个库之中，每个表中 包含一部分数据。简单来说，我们可以将数据的水平切分理解为是按照数据行的切分，就是将表中的某些行切分 到一个数据库，而另外的某些行又切分到其他的数据库中 。</p>
<h4 id="2-1、取模运算"><a href="#2-1、取模运算" class="headerlink" title="2.1、取模运算"></a>2.1、取模运算</h4><p>​        <code>把customer_id按照取模运算进行数据拆分</code></p>
<h5 id="修改schema-xml文件"><a href="#修改schema-xml文件" class="headerlink" title="修改schema.xml文件"></a><strong>修改<code>schema.xml</code>文件</strong></h5><p>​        在上文<a href="https://yrlzero.gitee.io/2021/04/29/mycat%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BD%BF%E7%94%A8/#1-3%E3%80%81%E4%BF%AE%E6%94%B9schema-xml%E6%96%87%E4%BB%B6" target="_blank" rel="noopener">分库的schema文件</a>基础上修改</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">"TESTDB"</span> <span class="attr">checkSQLschema</span>=<span class="string">"false"</span> <span class="attr">sqlMaxLimit</span>=<span class="string">"100"</span> <span class="attr">dataNode</span>=<span class="string">"dn1"</span>&gt;</span>		</span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span> = <span class="string">"customer"</span> <span class="attr">dataNode</span>=<span class="string">"dn2"</span>&gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span> =<span class="string">"orders"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2"</span> <span class="attr">rule</span>=<span class="string">"mod_rule"</span>&gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span>	</span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="修改rule-xml文件"><a href="#修改rule-xml文件" class="headerlink" title="修改rule.xml文件"></a><strong>修改<code>rule.xml</code>文件</strong></h5><p>​        配置取模运算规则</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">"mod_rule"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>customer_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>mod-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">"mod-long"</span> <span class="attr">class</span>=<span class="string">"io.mycat.route.function.PartitionByMod"</span>&gt;</span>		</span><br><span class="line">    <span class="comment">&lt;!-- how many data nodes --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"count"</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="重启mycat"><a href="#重启mycat" class="headerlink" title="重启mycat"></a><strong>重启mycat</strong></h5><h5 id="建表-1"><a href="#建表-1" class="headerlink" title="建表"></a><strong>建表</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> orders(</span><br><span class="line">	<span class="keyword">id</span> <span class="built_in">INT</span> AUTO_INCREMENT,</span><br><span class="line">	order_type <span class="built_in">INT</span>,</span><br><span class="line">	customer_id <span class="built_in">INT</span>,</span><br><span class="line">	amount <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">	PRIMARY <span class="keyword">KEY</span>(<span class="keyword">id</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h5 id="插入数据-1"><a href="#插入数据-1" class="headerlink" title="插入数据"></a><strong>插入数据</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders(<span class="keyword">id</span>,order_type,customer_id,amount) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="number">101</span>,<span class="number">100</span>,<span class="number">100100</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders(<span class="keyword">id</span>,order_type,customer_id,amount) <span class="keyword">VALUES</span>(<span class="number">2</span>,<span class="number">101</span>,<span class="number">100</span>,<span class="number">100300</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders(<span class="keyword">id</span>,order_type,customer_id,amount) <span class="keyword">VALUES</span>(<span class="number">3</span>,<span class="number">101</span>,<span class="number">101</span>,<span class="number">120000</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders(<span class="keyword">id</span>,order_type,customer_id,amount) <span class="keyword">VALUES</span>(<span class="number">4</span>,<span class="number">101</span>,<span class="number">101</span>,<span class="number">103000</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders(<span class="keyword">id</span>,order_type,customer_id,amount) <span class="keyword">VALUES</span>(<span class="number">5</span>,<span class="number">102</span>,<span class="number">101</span>,<span class="number">100400</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders(<span class="keyword">id</span>,order_type,customer_id,amount) <span class="keyword">VALUES</span>(<span class="number">6</span>,<span class="number">102</span>,<span class="number">100</span>,<span class="number">100020</span>);</span><br></pre></td></tr></table></figure>

<h5 id="查询结果"><a href="#查询结果" class="headerlink" title="查询结果"></a><strong>查询结果</strong></h5><p><img src="/images/linux/mycat/%E5%88%86%E8%A1%A8-%E5%8F%96%E6%A8%A1.jpg" alt=""></p>
<blockquote>
<p>由上图可以看出，<code>mycat</code>会将我们插入的数据根据<code>customer_id</code>字段值%2，结果为0的分发到<code>master-1</code>，为1分发<code>master-2</code></p>
</blockquote>
<hr>
<h4 id="2-2、分片枚举"><a href="#2-2、分片枚举" class="headerlink" title="2.2、分片枚举"></a>2.2、分片枚举</h4><p>​        <code>通过在配置文件中配置可能存在的值，配置分片。</code></p>
<h5 id="修改schema-xml文件-1"><a href="#修改schema-xml文件-1" class="headerlink" title="修改schema.xml文件"></a><strong>修改<code>schema.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">"TESTDB"</span> <span class="attr">checkSQLschema</span>=<span class="string">"false"</span> <span class="attr">sqlMaxLimit</span>=<span class="string">"100"</span> <span class="attr">dataNode</span>=<span class="string">"dn1"</span>&gt;</span>	</span><br><span class="line">	<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"orders_ware_info"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2"</span> <span class="attr">rule</span>=<span class="string">"sharding_by_intfile"</span> &gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="修改rule-xml文件-1"><a href="#修改rule-xml文件-1" class="headerlink" title="修改rule.xml文件"></a><strong>修改<code>rule.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">"sharding_by_intfile"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- columns：分片字段 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">columns</span>&gt;</span>areacode<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- algorithm：分片函数,对应下面的function标签 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>hash-int<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">"hash-int"</span> <span class="attr">class</span>=<span class="string">"io.mycat.route.function.PartitionByFileMap"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- mapFile： 标识配置文件名称--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mapFile"</span>&gt;</span>partition-hash-int.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--  type： 0为int型、 非0为String --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"type"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- defaultNode： 默认节点:小于 0 表示不设置默认节点，大于等于 0 表示设置默认节点，</span></span><br><span class="line"><span class="comment">	设置默认节点如果碰到不识别的枚举值，就让它路由到默认节点，如不设置不识别就报错 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"defaultNode"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="修改partition-hash-int-txt文件"><a href="#修改partition-hash-int-txt文件" class="headerlink" title="修改partition-hash-int.txt文件"></a><strong>修改<code>partition-hash-int.txt</code>文件</strong></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#10000&#x3D;0</span><br><span class="line">#10010&#x3D;1</span><br><span class="line">110&#x3D;0</span><br><span class="line">120&#x3D;1</span><br></pre></td></tr></table></figure>

<h5 id="重启mycat-1"><a href="#重启mycat-1" class="headerlink" title="重启mycat"></a><strong>重启mycat</strong></h5><h5 id="建表-2"><a href="#建表-2" class="headerlink" title="建表"></a><strong>建表</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> orders_ware_info</span><br><span class="line">(</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">INT</span> AUTO_INCREMENT <span class="keyword">comment</span> <span class="string">'编号'</span>,</span><br><span class="line">    <span class="string">`order_id`</span> <span class="built_in">INT</span> <span class="keyword">comment</span> <span class="string">'订单编号'</span>,</span><br><span class="line">    <span class="string">`address`</span> <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">comment</span> <span class="string">'地址'</span>,</span><br><span class="line">    <span class="string">`areacode`</span> <span class="built_in">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">comment</span> <span class="string">'区域编号'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(<span class="keyword">id</span>)</span><br><span class="line">)<span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>

<h5 id="插入数据-2"><a href="#插入数据-2" class="headerlink" title="插入数据"></a><strong>插入数据</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders_ware_info(<span class="keyword">id</span>, order_id,address,areacode) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="number">1</span>,<span class="string">'北京'</span>,<span class="string">'110'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders_ware_info(<span class="keyword">id</span>, order_id,address,areacode) <span class="keyword">VALUES</span> (<span class="number">2</span>,<span class="number">2</span>,<span class="string">'天津'</span>,<span class="string">'120'</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/images/linux/mycat/%E5%88%86%E7%89%87-%E5%88%86%E7%89%87%E6%9E%9A%E4%B8%BE.jpg" alt=""></p>
<blockquote>
<p>由上图可以看出，<code>mycat</code>会将我们插入的数据根据<code>areacode</code>值与<code>partition-hash-int.txt</code>文件中配置参数比对确定存放的节点，110被分发到<code>node-1</code>，120被分发到<code>node-2</code></p>
</blockquote>
<hr>
<h4 id="2-3、范围分片"><a href="#2-3、范围分片" class="headerlink" title="2.3、范围分片"></a>2.3、范围分片</h4><p>​    根据分片字段，约定好属于哪一个范围</p>
<h5 id="修改schema-xml文件-2"><a href="#修改schema-xml文件-2" class="headerlink" title="修改schema.xml文件"></a><strong>修改<code>schema.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"payment_info"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2"</span> <span class="attr">rule</span>=<span class="string">"auto-sharding-long"</span> &gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="修改rule-xml文件-2"><a href="#修改rule-xml文件-2" class="headerlink" title="修改rule.xml文件"></a><strong>修改<code>rule.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">"auto-sharding-long"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- columns：分片字段 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>order_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- algorithm：分片函数 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>rang-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">"rang-long"</span> <span class="attr">class</span>=<span class="string">"io.mycat.route.function.AutoPartitionByLong"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- mapFile： 标识配置文件名称 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mapFile"</span>&gt;</span>autopartition-long.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- defaultNode： 默认节点:小于 0 表示不设置默认节点，大于等于 0 表示设置默认节点，</span></span><br><span class="line"><span class="comment">	设置默认节点如果碰到不识别的枚举值，就让它路由到默认节点，如不设置不识别就报错 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"defaultNode"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="修改autopartition-long-txt文件"><a href="#修改autopartition-long-txt文件" class="headerlink" title="修改autopartition-long.txt文件"></a>修改<code>autopartition-long.txt</code>文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># range start-end ,data node index</span><br><span class="line"># K&#x3D;1000,M&#x3D;10000.</span><br><span class="line">#0-500M&#x3D;0</span><br><span class="line">#500M-1000M&#x3D;1</span><br><span class="line">#1000M-1500M&#x3D;2</span><br><span class="line">0-102&#x3D;0</span><br><span class="line">103-200&#x3D;1</span><br></pre></td></tr></table></figure>

<h5 id="重启mycat-2"><a href="#重启mycat-2" class="headerlink" title="重启mycat"></a><strong>重启mycat</strong></h5><h5 id="建表-3"><a href="#建表-3" class="headerlink" title="建表"></a><strong>建表</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> payment_info</span><br><span class="line">(</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">INT</span> AUTO_INCREMENT <span class="keyword">comment</span> <span class="string">'编号'</span>,</span><br><span class="line">    <span class="string">`order_id`</span> <span class="built_in">INT</span> <span class="keyword">comment</span> <span class="string">'订单编号'</span>,</span><br><span class="line">    <span class="string">`payment_status`</span> <span class="built_in">INT</span> <span class="keyword">comment</span> <span class="string">'支付状态'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(<span class="keyword">id</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h5 id="插入数据-3"><a href="#插入数据-3" class="headerlink" title="插入数据"></a><strong>插入数据</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> payment_info (<span class="keyword">id</span>,order_id,payment_status) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="number">101</span>,<span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> payment_info (<span class="keyword">id</span>,order_id,payment_status) <span class="keyword">VALUES</span> (<span class="number">2</span>,<span class="number">102</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> payment_info (<span class="keyword">id</span>,order_id ,payment_status) <span class="keyword">VALUES</span> (<span class="number">3</span>,<span class="number">103</span>,<span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> payment_info (<span class="keyword">id</span>,order_id,payment_status) <span class="keyword">VALUES</span> (<span class="number">4</span>,<span class="number">104</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<h5 id="查询结果-1"><a href="#查询结果-1" class="headerlink" title="查询结果"></a><strong>查询结果</strong></h5><p><img src="/images/linux/mycat/%E5%88%86%E7%89%87-%E8%8C%83%E5%9B%B4%E5%88%86%E7%89%87.jpg" alt=""></p>
<blockquote>
<p>由上图可以看出，<code>mycat</code>会将我们插入的数据根据<code>order_id</code>值与<code>autopartition-long.txt</code>文件中配置参数比对确定存放的节点</p>
</blockquote>
<hr>
<h4 id="2-4、范围求模算法"><a href="#2-4、范围求模算法" class="headerlink" title="2.4、范围求模算法"></a>2.4、范围求模算法</h4><p>​    该算法为先进行<code>范围分片</code>，计算出分片组，<code>组内再求模</code>，综合了范围分片和求模分片的优点。</p>
<p>​    分片组内使用求模可以保证组内的数据分步比较均匀，分片组之间采用范围分片可以兼顾范围分片的特点。事先规定好分片的数量，数据扩容时按分片组扩容，则原有分片组的数据不需要迁移。由于分片组内的数据分步比较均匀，所以分片组内可以避免热点数据问题。</p>
<h5 id="修改schema-xml文件-3"><a href="#修改schema-xml文件-3" class="headerlink" title="修改schema.xml文件"></a><strong>修改<code>schema.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"person"</span> <span class="attr">primaryKey</span>=<span class="string">"id"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2,dn3"</span> <span class="attr">rule</span>=<span class="string">"auto-sharding-rang-mod"</span>&gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="修改rule-xml文件-3"><a href="#修改rule-xml文件-3" class="headerlink" title="修改rule.xml文件"></a><strong>修改<code>rule.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">"auto-sharding-rang-mod"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>rang-mod<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">"rang-mod"</span> <span class="attr">class</span>=<span class="string">"io.mycat.route.function.PartitionByRangeMod"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mapFile"</span>&gt;</span>partition-range-mod.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"defaultNode"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="修改partition-range-mod-txt文件"><a href="#修改partition-range-mod-txt文件" class="headerlink" title="修改partition-range-mod.txt文件"></a><strong>修改partition-range-mod.txt文件</strong></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># range start-end ,data node group size</span><br><span class="line"># 0-200M&#x3D;5</span><br><span class="line"># 200M1-400M&#x3D;1</span><br><span class="line"># 400M1-600M&#x3D;4</span><br><span class="line"># 600M1-800M&#x3D;4</span><br><span class="line"># 800M1-1000M&#x3D;6</span><br><span class="line">0-1M&#x3D;2</span><br><span class="line">1M1-2M&#x3D;1</span><br></pre></td></tr></table></figure>

<h5 id="重启mycat-3"><a href="#重启mycat-3" class="headerlink" title="重启mycat"></a><strong>重启mycat</strong></h5><h5 id="建表-4"><a href="#建表-4" class="headerlink" title="建表"></a><strong>建表</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`person`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>

<h5 id="插入数据-4"><a href="#插入数据-4" class="headerlink" title="插入数据"></a><strong>插入数据</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> person(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">9999</span>,<span class="string">'zhangsan1'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> person(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">10000</span>,<span class="string">'zhangsan2'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> person(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">10001</span>,<span class="string">'zhangsan3'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> person(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">20000</span>,<span class="string">'zhangsan4'</span>);</span><br></pre></td></tr></table></figure>

<h5 id="查询结果-2"><a href="#查询结果-2" class="headerlink" title="查询结果"></a><strong>查询结果</strong></h5><p><img src="/images/linux/mycat/%E5%88%86%E7%89%87-%E8%8C%83%E5%9B%B4%E6%B1%82%E6%A8%A1.jpg" alt=""></p>
<blockquote>
<p>由上图可以看出，<code>mycat</code>会将我们插入的数据根据<code>id</code>值与<code>partition-range-mod.txt</code>文件中配置参数比对，确定存放在哪个分片，如果该分片只有一个节点直接放入，分片存在多个节点时，需要对<code>id</code>值进行取模运算确定存放的节点</p>
<p>先匹配范围，再取模</p>
</blockquote>
<hr>
<h4 id="2-5、固定分片hash算法"><a href="#2-5、固定分片hash算法" class="headerlink" title="2.5、固定分片hash算法"></a>2.5、固定分片hash算法</h4><p>​        类似于十进制的求模运算，但是为二进制的操作，取id的二进制低10位，即id的二进制 &amp; 1111111111，结果落在0-1023之间，所以默认最大分片为1024.</p>
<p>​        此算法的优点在于如果按照十进制取模运算，则在连续插入1<del>10时，1</del>10会被分到1~10个分片，增大了插入事务的控制难度。而此算法根据二进制则可能会分到连续的分片，降低了插入事务的控制难度。</p>
<h5 id="修改schema-xml文件-4"><a href="#修改schema-xml文件-4" class="headerlink" title="修改schema.xml文件"></a><strong>修改<code>schema.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">primaryKey</span>=<span class="string">"id"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2,dn3"</span> <span class="attr">rule</span>=<span class="string">"rule1"</span>&gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="修改rule-xml文件-4"><a href="#修改rule-xml文件-4" class="headerlink" title="修改rule.xml文件"></a><strong>修改<code>rule.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">"rule1"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>func1<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">"func1"</span> <span class="attr">class</span>=<span class="string">"io.mycat.route.function.PartitionByLong"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- partitionCount为分片个数列表 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"partitionCount"</span>&gt;</span>2,1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- partitionLength为分片范围列表，分区长度默认最大为1024，即最大支持1024个分区 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"partitionLength"</span>&gt;</span>256,512<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="重启mycat-4"><a href="#重启mycat-4" class="headerlink" title="重启mycat"></a><strong>重启mycat</strong></h5><h5 id="建表-5"><a href="#建表-5" class="headerlink" title="建表"></a><strong>建表</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>

<h5 id="插入数据-5"><a href="#插入数据-5" class="headerlink" title="插入数据"></a><strong>插入数据</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">1023</span>,<span class="string">'zhangsan1'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">1024</span>,<span class="string">'zhangsan2'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">266</span>,<span class="string">'zhangsan3'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">255</span>,<span class="string">'zhangsan4'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">1025</span>,<span class="string">'zhangsan2'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">1025</span>,<span class="string">'zhangsan5'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">1257</span>,<span class="string">'zhangsan6'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">1281</span>,<span class="string">'zhangsan7'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">256</span>,<span class="string">'zhangsan8'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">511</span>,<span class="string">'zhangsan9'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">512</span>,<span class="string">'zhangsan10'</span>);</span><br></pre></td></tr></table></figure>

<h5 id="查询结果-3"><a href="#查询结果-3" class="headerlink" title="查询结果"></a><strong>查询结果</strong></h5><img src="/images/linux/mycat/分片-固定分片hash算法.jpg" style="zoom:80%;" />

<blockquote>
<p>由上图可以看出，<code>mycat</code>会将我们插入的数据根据<code>id</code>值与<code>rule.xml</code>文件中配置参数比对，确定存放在哪个分片，当数值超过1024时会减去1024再进行范围匹配</p>
<p>最大分片数为1024，范围从0-1023</p>
</blockquote>
<hr>
<h4 id="2-6、取模范围算法"><a href="#2-6、取模范围算法" class="headerlink" title="2.6、取模范围算法"></a>2.6、取模范围算法</h4><p>​    取模运算与范围约束的结合主要是为后续的数据迁移做准备，即可以自主决定取模后数据的节点分布。</p>
<h5 id="修改schema-xml文件-5"><a href="#修改schema-xml文件-5" class="headerlink" title="修改schema.xml文件"></a><strong>修改<code>schema.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"user2"</span> <span class="attr">primaryKey</span>=<span class="string">"id"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2,dn3"</span> <span class="attr">rule</span>=<span class="string">"sharding-by-pattern"</span>&gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="修改rule-xml文件-5"><a href="#修改rule-xml文件-5" class="headerlink" title="修改rule.xml文件"></a><strong>修改<code>rule.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">"sharding-by-pattern"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>sharding-by-pattern<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">"sharding-by-pattern"</span> <span class="attr">class</span>=<span class="string">"io.mycat.route.function.PartitionByPattern"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- mapFile：切分规则配置文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mapFile"</span>&gt;</span>partition-pattern.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- patternValue：求模基数 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"patternValue"</span>&gt;</span>256<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- defaultNode：默认节点，小于0表示不设置默认节点，大于等于0表示设置默认节点，如果超出配置的范围，则使用默认节点 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"defaultNode"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="修改partition-pattern-txt文件"><a href="#修改partition-pattern-txt文件" class="headerlink" title="修改partition-pattern.txt文件"></a>修改partition-pattern.txt文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0-86&#x3D;0</span><br><span class="line">87-173&#x3D;1</span><br><span class="line">174-256&#x3D;2</span><br></pre></td></tr></table></figure>

<h5 id="重启mycat-5"><a href="#重启mycat-5" class="headerlink" title="重启mycat"></a><strong>重启mycat</strong></h5><h5 id="建表-6"><a href="#建表-6" class="headerlink" title="建表"></a><strong>建表</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user2`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>

<h5 id="插入数据-6"><a href="#插入数据-6" class="headerlink" title="插入数据"></a><strong>插入数据</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user2(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">85</span>,<span class="string">'zhangsan1'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user2(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">100</span>,<span class="string">'zhangsan2'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user2(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">200</span>,<span class="string">'zhangsan3'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user2(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">257</span>,<span class="string">'zhangsan4'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user2(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">343</span>,<span class="string">'zhangsan5'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user2(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">430</span>,<span class="string">'zhangsan6'</span>);</span><br></pre></td></tr></table></figure>

<h5 id="查询结果-4"><a href="#查询结果-4" class="headerlink" title="查询结果"></a><strong>查询结果</strong></h5><img src="/images/linux/mycat/分片-取模范围算法-1620120538787.jpg" style="zoom:80%;" />

<blockquote>
<p>由上图可以看出，<code>mycat</code>会将我们插入的数据根据<code>id</code>值与<code>rule.xml</code>文件中配置的取模基数<code>patternValue</code>进行计算，看结果落在哪个范围分片，最终确定存放在哪个节点</p>
<p>先取模，再匹配范围</p>
</blockquote>
<hr>
<h4 id="2-7、字符串hash求模范围算法"><a href="#2-7、字符串hash求模范围算法" class="headerlink" title="2.7、字符串hash求模范围算法"></a>2.7、字符串hash求模范围算法</h4><p>​        与取模范围算法类似，该算法支持数值、符号、字母取模，此方式就是将指定位数的字符的ascll码的和进行取模运算。</p>
<h5 id="修改schema-xml文件-6"><a href="#修改schema-xml文件-6" class="headerlink" title="修改schema.xml文件"></a><strong>修改<code>schema.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"user3"</span> <span class="attr">primaryKey</span>=<span class="string">"id"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2,dn3"</span> <span class="attr">rule</span>=<span class="string">"sharding-by-prefixpattern"</span>&gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="修改rule-xml文件-6"><a href="#修改rule-xml文件-6" class="headerlink" title="修改rule.xml文件"></a><strong>修改<code>rule.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">"sharding-by-prefixpattern"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- columns标识将要分片的表字段 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>name<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- algorithm为分片函数 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>sharding-by-prefixpattern<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">"sharding-by-prefixpattern"</span> <span class="attr">class</span>=<span class="string">"io.mycat.route.function.PartitionByPrefixPattern"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- mapFile：切分规则配置文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mapFile"</span>&gt;</span>partition-pattern.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- patternValue：求模基数 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"patternValue"</span>&gt;</span>256<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- prefixLength:ASCII 截取的位数 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prefixLength"</span>&gt;</span>5<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="修改partition-pattern-txt文件-1"><a href="#修改partition-pattern-txt文件-1" class="headerlink" title="修改partition-pattern.txt文件"></a>修改partition-pattern.txt文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># ASCII</span><br><span class="line"># 8-57&#x3D;0-9 阿拉伯数字</span><br><span class="line"># 64、 65-90&#x3D;@、 A-Z</span><br><span class="line"># 97-122&#x3D;a-z  </span><br><span class="line">0-86&#x3D;0</span><br><span class="line">87-173&#x3D;1</span><br><span class="line">174-256&#x3D;2</span><br></pre></td></tr></table></figure>

<h5 id="重启mycat-6"><a href="#重启mycat-6" class="headerlink" title="重启mycat"></a><strong>重启mycat</strong></h5><h5 id="建表-7"><a href="#建表-7" class="headerlink" title="建表"></a><strong>建表</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user3`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>

<h5 id="插入数据-7"><a href="#插入数据-7" class="headerlink" title="插入数据"></a><strong>插入数据</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user3(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'zhangsan'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user3(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">'lisi'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user3(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">'wangwu'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user3(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">4</span>,<span class="string">'zzzzzzz'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user3(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">5</span>,<span class="string">'z99'</span>);</span><br></pre></td></tr></table></figure>

<h5 id="查询结果-5"><a href="#查询结果-5" class="headerlink" title="查询结果"></a><strong>查询结果</strong></h5><img src="/images/linux/mycat/分片-字符串hash求模范围算法.jpg" style="zoom:80%;" />

<blockquote>
<p>由上图可以看出，<code>mycat</code>会将我们插入的数据根据<code>name</code>值的前五位进行截取计算ASCII值，结果值再与<code>rule.xml</code>文件中配置的取模基数<code>patternValue</code>进行取模计算，看取模结果落在哪个范围分片，最终确定存放在哪个节点</p>
<p>先截取换算ASCII值，取模计算，再匹配范围</p>
</blockquote>
<hr>
<h4 id="2-8、应用指定的算法"><a href="#2-8、应用指定的算法" class="headerlink" title="2.8、应用指定的算法"></a>2.8、应用指定的算法</h4><p>​    在运行阶段由应用程序自主决定路由到哪个分片。</p>
<h5 id="修改schema-xml文件-7"><a href="#修改schema-xml文件-7" class="headerlink" title="修改schema.xml文件"></a><strong>修改<code>schema.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"user4"</span> <span class="attr">primaryKey</span>=<span class="string">"id"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2,dn3"</span> <span class="attr">rule</span>=<span class="string">"sharding-by-substring"</span>&gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="修改rule-xml文件-7"><a href="#修改rule-xml文件-7" class="headerlink" title="修改rule.xml文件"></a><strong>修改<code>rule.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">"sharding-by-substring"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>name<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>sharding-by-substring<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">"sharding-by-substring"</span> <span class="attr">class</span>=<span class="string">"io.mycat.route.function.PartitionDirectBySubString"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 开始的索引值 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"startIndex"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 取值长度 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"size"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 分片数量 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"partitionCount"</span>&gt;</span>3<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 默认的分片节点 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"defaultPartition"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="重启mycat-7"><a href="#重启mycat-7" class="headerlink" title="重启mycat"></a><strong>重启mycat</strong></h5><h5 id="建表-8"><a href="#建表-8" class="headerlink" title="建表"></a><strong>建表</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user4`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>

<h5 id="插入数据-8"><a href="#插入数据-8" class="headerlink" title="插入数据"></a><strong>插入数据</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user4(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'0-zhangsan'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user4(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">'1-lisi'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user4(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">'2-wangwu'</span>);</span><br></pre></td></tr></table></figure>

<h5 id="查询结果-6"><a href="#查询结果-6" class="headerlink" title="查询结果"></a><strong>查询结果</strong></h5><img src="/images/linux/mycat/分片-应用指定的算法.jpg" style="zoom:80%;" />

<blockquote>
<p>由上图可以看出，<code>mycat</code>会将我们插入的数据根据<code>name</code>值从<code>startIndex</code>截取<code>size</code>数量的字符，结果值匹配分片的索引，最终确定存放在哪个节点</p>
</blockquote>
<hr>
<h4 id="2-9、字符串hash解析算法"><a href="#2-9、字符串hash解析算法" class="headerlink" title="2.9、字符串hash解析算法"></a>2.9、字符串hash解析算法</h4><p>​        字符串hash解析分片，其实就是根据配置的hash预算位规则，将截取的字符串进行hash计算后，得到的int数值即为datanode index(分片节点索引，从0开始)。</p>
<h5 id="修改schema-xml文件-8"><a href="#修改schema-xml文件-8" class="headerlink" title="修改schema.xml文件"></a><strong>修改<code>schema.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"user5"</span> <span class="attr">primaryKey</span>=<span class="string">"id"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2,dn3"</span> <span class="attr">rule</span>=<span class="string">"sharding-by-stringhash"</span>&gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="修改rule-xml5文件"><a href="#修改rule-xml5文件" class="headerlink" title="修改rule.xml5文件"></a><strong>修改<code>rule.xml5</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">"sharding-by-stringhash"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- columns标识将要分片的表字段 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- algorithm为分片函数 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>sharding-by-stringhash<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">partitionLength:求模基数</span></span><br><span class="line"><span class="comment">partitionCount:分片数量</span></span><br><span class="line"><span class="comment">hashslice： hash预算位，即根据子字符串中 int 值 hash 运算</span></span><br><span class="line"><span class="comment">    0 代表 str.length(), -1 代表 str.length()-1，大于0只代表数字自身</span></span><br><span class="line"><span class="comment">    /**</span></span><br><span class="line"><span class="comment">    * “2” -&gt; (0,2)</span></span><br><span class="line"><span class="comment">    * “1:2” -&gt; (1,2)</span></span><br><span class="line"><span class="comment">    * “1:” -&gt; (1,0)</span></span><br><span class="line"><span class="comment">    * “-1:” -&gt; (-1,0)</span></span><br><span class="line"><span class="comment">    * “:-1” -&gt; (0,-1)</span></span><br><span class="line"><span class="comment">    * “:” -&gt; (0,0)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">"sharding-by-stringhash"</span> <span class="attr">class</span>=<span class="string">"io.mycat.route.function.PartitionByString"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- partitionLength为分片范围列表，分区长度默认最大为1024，即最大支持1024个分区 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"partitionLength"</span>&gt;</span>512,256<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- partitionCount为分片个数列表 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"partitionCount"</span>&gt;</span>1,2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hashSlice"</span>&gt;</span>0:6<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="重启mycat-8"><a href="#重启mycat-8" class="headerlink" title="重启mycat"></a><strong>重启mycat</strong></h5><h5 id="建表-9"><a href="#建表-9" class="headerlink" title="建表"></a><strong>建表</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user5`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>

<h5 id="插入数据-9"><a href="#插入数据-9" class="headerlink" title="插入数据"></a><strong>插入数据</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user5(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">1111111</span>,<span class="keyword">database</span>());</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user5(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">2222222</span>,<span class="keyword">database</span>());</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user5(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">3333333</span>,<span class="keyword">database</span>());</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user5(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">4444444</span>,<span class="keyword">database</span>());</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user5(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">8960000</span>,<span class="keyword">database</span>());</span><br></pre></td></tr></table></figure>

<h5 id="查询结果-7"><a href="#查询结果-7" class="headerlink" title="查询结果"></a><strong>查询结果</strong></h5><img src="/images/linux/mycat/分片-字符串hash解析算法.jpg" style="zoom:80%;" />

<blockquote>
<p>由上图可以看出，<code>mycat</code>会将我们插入的数据中的<code>id</code>值根据<code>hashslice</code>截取合适的字符串进行hash值计算，再从长度是1024的数组中获取对应的节点索引值，将结果存入该节点</p>
<p>最大分片数为1024，范围从0-1023</p>
</blockquote>
<hr>
<h4 id="2-10、按照日期范围分片"><a href="#2-10、按照日期范围分片" class="headerlink" title="2.10、按照日期范围分片"></a>2.10、按照日期范围分片</h4><p>​        按照某个指定的日期进行分片</p>
<h5 id="修改schema-xml文件-9"><a href="#修改schema-xml文件-9" class="headerlink" title="修改schema.xml文件"></a><strong>修改<code>schema.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"login_info"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2"</span> <span class="attr">rule</span>=<span class="string">"sharding_by_date"</span> &gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="修改rule-xml文件-8"><a href="#修改rule-xml文件-8" class="headerlink" title="修改rule.xml文件"></a><strong>修改<code>rule.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">"sharding_by_date"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- columns：分片字段 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>login_date<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- algorithm：分片函数 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>shardingByDate<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">"shardingByDate"</span> <span class="attr">class</span>=<span class="string">"io.mycat.route.function.PartitionByDate"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- sBeginDate ：开始日期 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dateFormat"</span>&gt;</span>yyyy-MM-dd<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- sBeginDate ：开始日期 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sBeginDate"</span>&gt;</span>2020-06-01<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- sEndDate：结束日期,则代表数据达到了这个日期的分片后循环从开始分片插入 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sEndDate"</span>&gt;</span>2020-06-04<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- sPartionDay ：分区天数，即默认从开始日期算起，分隔 2 天一个分区 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sPartionDay"</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="重启mycat-9"><a href="#重启mycat-9" class="headerlink" title="重启mycat"></a><strong>重启mycat</strong></h5><h5 id="建表-10"><a href="#建表-10" class="headerlink" title="建表"></a><strong>建表</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> login_info</span><br><span class="line">(</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">INT</span> AUTO_INCREMENT <span class="keyword">comment</span> <span class="string">'编号'</span>,</span><br><span class="line">    <span class="string">`user_id`</span> <span class="built_in">INT</span> <span class="keyword">comment</span> <span class="string">'用户编号'</span>,</span><br><span class="line">    <span class="string">`login_date`</span> <span class="built_in">date</span> <span class="keyword">comment</span> <span class="string">'登录日期'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(<span class="keyword">id</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h5 id="插入数据-10"><a href="#插入数据-10" class="headerlink" title="插入数据"></a><strong>插入数据</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> login_info(<span class="keyword">id</span>,user_id,login_date) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="number">101</span>,<span class="string">'2020-06-01'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> login_info(<span class="keyword">id</span>,user_id,login_date) <span class="keyword">VALUES</span> (<span class="number">2</span>,<span class="number">102</span>,<span class="string">'2020-06-02'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> login_info(<span class="keyword">id</span>,user_id,login_date) <span class="keyword">VALUES</span> (<span class="number">3</span>,<span class="number">103</span>,<span class="string">'2020-06-03'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> login_info(<span class="keyword">id</span>,user_id,login_date) <span class="keyword">VALUES</span> (<span class="number">4</span>,<span class="number">104</span>,<span class="string">'2020-06-04'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> login_info(<span class="keyword">id</span>,user_id,login_date) <span class="keyword">VALUES</span> (<span class="number">5</span>,<span class="number">103</span>,<span class="string">'2020-06-05'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> login_info(<span class="keyword">id</span>,user_id,login_date) <span class="keyword">VALUES</span> (<span class="number">6</span>,<span class="number">104</span>,<span class="string">'2020-06-06'</span>);</span><br></pre></td></tr></table></figure>

<h5 id="查询结果-8"><a href="#查询结果-8" class="headerlink" title="查询结果"></a><strong>查询结果</strong></h5><img src="/images/linux/mycat/分片-按照日期范围分片.jpg" style="zoom:80%;" />

<blockquote>
<p>按照某个指定的日期进行分片,达到结束日期后循环开始分片插入</p>
</blockquote>
<hr>
<h4 id="2-11、按单月小时分片"><a href="#2-11、按单月小时分片" class="headerlink" title="2.11、按单月小时分片"></a>2.11、按单月小时分片</h4><p>​        此规则是单月内按照小时拆分，最小粒度是小时，可以一天最多24个分片，最少一个分片，一个月完成后下个月开始循环，每个月月尾，需要手工清理数据。</p>
<h5 id="修改schema-xml文件-10"><a href="#修改schema-xml文件-10" class="headerlink" title="修改schema.xml文件"></a><strong>修改<code>schema.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"user6"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2,dn3"</span> <span class="attr">rule</span>=<span class="string">"sharding-by-hour"</span>&gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="修改rule-xml文件-9"><a href="#修改rule-xml文件-9" class="headerlink" title="修改rule.xml文件"></a><strong>修改<code>rule.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">"sharding-by-hour"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- columns： 拆分字段，字符串类型（yyyymmddHH） --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>create_time<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>sharding-by-hour<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">"sharding-by-hour"</span> <span class="attr">class</span>=<span class="string">"io.mycat.route.function.LatestMonthPartion"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- splitOneDay ：一天切分的分片数 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"splitOneDay"</span>&gt;</span>3<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="重启mycat-10"><a href="#重启mycat-10" class="headerlink" title="重启mycat"></a><strong>重启mycat</strong></h5><h5 id="建表-11"><a href="#建表-11" class="headerlink" title="建表"></a><strong>建表</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user6(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">64</span>),</span><br><span class="line">    create_time <span class="built_in">varchar</span>(<span class="number">10</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h5 id="插入数据-11"><a href="#插入数据-11" class="headerlink" title="插入数据"></a><strong>插入数据</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060100'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060101'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060102'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060103'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060104'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060105'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060106'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060107'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060108'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060109'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060110'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060111'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060112'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060113'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060114'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060115'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060116'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060117'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060118'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060119'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060120'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060121'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060122'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060123'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060200'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060201'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060202'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060203'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060204'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060205'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060206'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060207'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060208'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060209'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060210'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user6(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020060211'</span>);</span><br></pre></td></tr></table></figure>

<h5 id="查询结果-9"><a href="#查询结果-9" class="headerlink" title="查询结果"></a><strong>查询结果</strong></h5><img src="/images/linux/mycat/分表-按单月小时分片.jpg" style="zoom:67%;" />

<blockquote>
<p>当运行完成之后会发现，第一天的数据能够正常的插入成功，均匀的分散到3个分片上，但是第二天的数据就无法成功分散了，原因就在于我们的数据分片不够，所以这种方式几乎没有人使用。</p>
<p>ERROR 1064 (HY000): Can’t find a valid data node for specified node index :USER6 -&gt; CREATE_TIME -&gt; 2020060200 -&gt; Index : 3</p>
</blockquote>
<hr>
<h4 id="2-12、日期范围hash分片"><a href="#2-12、日期范围hash分片" class="headerlink" title="2.12、日期范围hash分片"></a>2.12、日期范围hash分片</h4><p>​        思想与范围求模一致，当由于日期在取模会有数据集中问题，所以改成了hash方法。先根据时间hash使得短期内数据分布的更均匀，有点可以避免扩容时的数据迁移，又可以一定程度上避免范围分片的热点问题，要求日期格式尽量精确，不然达不到局部均匀的目的。</p>
<h5 id="修改schema-xml文件-11"><a href="#修改schema-xml文件-11" class="headerlink" title="修改schema.xml文件"></a><strong>修改<code>schema.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"user7"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2,dn3"</span> <span class="attr">rule</span>=<span class="string">"rangeDateHash"</span>&gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="修改rule-xml文件-10"><a href="#修改rule-xml文件-10" class="headerlink" title="修改rule.xml文件"></a><strong>修改<code>rule.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">"rangeDateHash"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- columns： 拆分字段，字符串类型（yyyymmddHH） --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>create_time<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- algorithm:分片函数 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>range-date-hash<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">"range-date-hash"</span> <span class="attr">class</span>=<span class="string">"io.mycat.route.function.PartitionByRangeDateHash"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- sBeginDate:指定开始的日期，与dateFormat格式一致 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sBeginDate"</span>&gt;</span>2020-06-01 00:00:00<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- sPartionDay:代表多少天一组 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sPartionDay"</span>&gt;</span>3<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- dateFormat:指定的日期格式，符合java标准 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dateFormat"</span>&gt;</span>yyyy-MM-dd HH:mm:ss<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 一组分片的分片数 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"groupPartionSize"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="重启mycat-11"><a href="#重启mycat-11" class="headerlink" title="重启mycat"></a><strong>重启mycat</strong></h5><h5 id="建表-12"><a href="#建表-12" class="headerlink" title="建表"></a><strong>建表</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user7(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">64</span>),</span><br><span class="line">    create_time <span class="built_in">varchar</span>(<span class="number">20</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h5 id="插入数据-12"><a href="#插入数据-12" class="headerlink" title="插入数据"></a><strong>插入数据</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user7(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020-06-01 00:00:00'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user7(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020-06-02 00:00:00'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user7(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020-06-03 00:00:00'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user7(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020-06-04 00:00:00'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user7(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020-06-05 00:00:00'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user7(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020-06-06 00:00:00'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user7(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020-06-07 00:00:00'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user7(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020-06-08 00:00:00'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user7(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020-06-09 00:00:00'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user7(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020-06-10 00:00:00'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user7(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'steven'</span>,<span class="string">'2020-06-11 00:00:00'</span>);</span><br></pre></td></tr></table></figure>

<h5 id="查询结果-10"><a href="#查询结果-10" class="headerlink" title="查询结果"></a><strong>查询结果</strong></h5><img src="/images/linux/mycat/分表-日期范围hash分片.jpg" style="zoom: 67%;" />

<blockquote>
<p>通过结果也可以看出，每三天一个分片，那么我们只有三个数据节点，所以到10号的数据的时候，没有办法进行数据的插入了，原因就在于没有足够多的数据节点。</p>
<p>insert into user7(id,name,create_time) values(1,’steven’,’2020-06-11 00:00:00’);ERROR 1064 (HY000): Can’t find a valid data node for specified node index :USER7 -&gt; CREATE_TIME -&gt; 2020-06-10 00:00:00 -&gt; Index : 3</p>
</blockquote>
<hr>
<h4 id="2-13、冷热数据分片"><a href="#2-13、冷热数据分片" class="headerlink" title="2.13、冷热数据分片"></a>2.13、冷热数据分片</h4><p>​        根据日期查询冷热数据分布，最近n个月的到实时交易库查询，其他的到其他库中</p>
<h5 id="修改schema-xml文件-12"><a href="#修改schema-xml文件-12" class="headerlink" title="修改schema.xml文件"></a><strong>修改<code>schema.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"user8"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2,dn3"</span> <span class="attr">rule</span>=<span class="string">"sharding-by-hotdate"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="修改rule-xml文件-11"><a href="#修改rule-xml文件-11" class="headerlink" title="修改rule.xml文件"></a><strong>修改<code>rule.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">"sharding-by-hotdate"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>create_time<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>sharding-by-hotdate<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">"sharding-by-hotdate"</span> <span class="attr">class</span>=<span class="string">"io.mycat.route.function.PartitionByHotDate"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- dataFormat：时间格式化 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dateFormat"</span>&gt;</span>yyyy-MM-dd<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- sLastDay:热数据的天数 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sLastDay"</span>&gt;</span>10<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- sPartionDay:冷数据的分片天数（按照天数分片）--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sPartionDay"</span>&gt;</span>30<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="重启mycat-12"><a href="#重启mycat-12" class="headerlink" title="重启mycat"></a><strong>重启mycat</strong></h5><h5 id="建表-13"><a href="#建表-13" class="headerlink" title="建表"></a><strong>建表</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span>  user8(create_time <span class="built_in">timestamp</span> <span class="literal">NULL</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span>  ,<span class="string">`db_nm`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>

<h5 id="插入数据-13"><a href="#插入数据-13" class="headerlink" title="插入数据"></a><strong>插入数据</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user8 (create_time,db_nm) <span class="keyword">VALUES</span> (<span class="string">'2021-03-01'</span>, <span class="keyword">database</span>());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user8 (create_time,db_nm) <span class="keyword">VALUES</span> (<span class="string">'2021-04-01'</span>, <span class="keyword">database</span>());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user8 (create_time,db_nm) <span class="keyword">VALUES</span> (<span class="string">'2021-04-10'</span>, <span class="keyword">database</span>());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user8 (create_time,db_nm) <span class="keyword">VALUES</span> (<span class="string">'2021-04-11'</span>, <span class="keyword">database</span>());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user8 (create_time,db_nm) <span class="keyword">VALUES</span> (<span class="string">'2021-04-21'</span>, <span class="keyword">database</span>());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user8 (create_time,db_nm) <span class="keyword">VALUES</span> (<span class="string">'2021-04-30'</span>, <span class="keyword">database</span>());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user8 (create_time,db_nm) <span class="keyword">VALUES</span> (<span class="string">'2021-05-01'</span>, <span class="keyword">database</span>());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user8 (create_time,db_nm) <span class="keyword">VALUES</span> (<span class="string">'2021-05-10'</span>, <span class="keyword">database</span>());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user8 (create_time,db_nm) <span class="keyword">VALUES</span> (<span class="string">'2021-05-30'</span>, <span class="keyword">database</span>());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user8 (create_time,db_nm) <span class="keyword">VALUES</span> (<span class="string">'2021-03-24'</span>, <span class="keyword">database</span>());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user8 (create_time,db_nm) <span class="keyword">VALUES</span> (<span class="string">'2021-03-25'</span>, <span class="keyword">database</span>());</span><br></pre></td></tr></table></figure>

<h5 id="查询结果-11"><a href="#查询结果-11" class="headerlink" title="查询结果"></a><strong>查询结果</strong></h5><img src="/images/linux/mycat/分表-冷热数据分片.jpg" style="zoom:67%;" />

<blockquote>
<p>当前时间之后及前<code>sLastDay</code>天的数据放入第一个节点</p>
<p>当前操作时间前<code>sPartionDay</code>-当前操作时间前<code>sLastDay</code>天内的数据放入第二个节点</p>
<p>其余当如第三个节点</p>
</blockquote>
<hr>
<h4 id="2-14、自然月分片"><a href="#2-14、自然月分片" class="headerlink" title="2.14、自然月分片"></a>2.14、自然月分片</h4><h5 id="修改schema-xml文件-13"><a href="#修改schema-xml文件-13" class="headerlink" title="修改schema.xml文件"></a><strong>修改<code>schema.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"user9"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2,dn3"</span> <span class="attr">rule</span>=<span class="string">"sharding-by-month"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="修改rule-xml文件-12"><a href="#修改rule-xml文件-12" class="headerlink" title="修改rule.xml文件"></a><strong>修改<code>rule.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">"sharding-by-month"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>create_time<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>sharding-by-month<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">"sharding-by-month"</span> <span class="attr">class</span>=<span class="string">"io.mycat.route.function.PartitionByMonth"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- dateFormat ： 日期字符串格式 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dateFormat"</span>&gt;</span>yyyy-MM-dd<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- sBeginDate ： 开始日期 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sBeginDate"</span>&gt;</span>2021-01-01<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="重启mycat-13"><a href="#重启mycat-13" class="headerlink" title="重启mycat"></a><strong>重启mycat</strong></h5><h5 id="建表-14"><a href="#建表-14" class="headerlink" title="建表"></a><strong>建表</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span>  user9(<span class="keyword">id</span> <span class="built_in">int</span>,<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">10</span>),create_time <span class="built_in">varchar</span>(<span class="number">20</span>));</span><br></pre></td></tr></table></figure>

<h5 id="插入数据-14"><a href="#插入数据-14" class="headerlink" title="插入数据"></a><strong>插入数据</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user9(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">111</span>,<span class="string">'zhangsan'</span>,<span class="string">'2021-01-01'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user9(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">111</span>,<span class="string">'zhangsan'</span>,<span class="string">'2021-03-01'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user9(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">111</span>,<span class="string">'zhangsan'</span>,<span class="string">'2021-05-01'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user9(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">111</span>,<span class="string">'zhangsan'</span>,<span class="string">'2021-07-01'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user9(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">111</span>,<span class="string">'zhangsan'</span>,<span class="string">'2021-09-01'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user9(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">111</span>,<span class="string">'zhangsan'</span>,<span class="string">'2021-11-01'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user9(<span class="keyword">id</span>,<span class="keyword">name</span>,create_time) <span class="keyword">values</span>(<span class="number">111</span>,<span class="string">'zhangsan'</span>,<span class="string">'2021-02-01'</span>);</span><br></pre></td></tr></table></figure>

<h5 id="查询结果-12"><a href="#查询结果-12" class="headerlink" title="查询结果"></a><strong>查询结果</strong></h5><img src="/images/linux/mycat/分片-自然月分片.jpg" style="zoom:67%;" />

<blockquote>
<p>从<code>sBeginDate</code>指定的月份开始，根据配置的节点数进行分片，因为配置了三个节点，所以如图所示，只有前三个月的数据会被会被分配插入，其余的报错ERROR 1064 (HY000): Can’t find a valid data node for specified node index :USER9 -&gt; CREATE_TIME -&gt; 2021-11-01 -&gt; Index : 10  因为无法找到对应有效的节点</p>
</blockquote>
<hr>
<h4 id="2-15、一致性hash分片"><a href="#2-15、一致性hash分片" class="headerlink" title="2.15、一致性hash分片"></a>2.15、一致性hash分片</h4><p>​        实现方式：一致性hash分片，利用一个分片节点对应一个或者多个虚拟hash桶的思想，尽可能减少分片扩展时的数据迁移。将指定的列值进行hash再对2^32进行取模得到hash环的对应位置</p>
<p>​        优点：有效解决了分布式数据库的扩容问题。</p>
<p>​        缺点：在横向扩展的时候，需要迁移部分数据；由于虚拟桶倍数与分片节点数都必须是正整数，而且要服从”虚拟桶倍数×分片节点数=设计极限”，因此在横向扩容的过程中，增加分片节点并不是一台一台地加上去的，而是以一种因式分解的方式增加，因此有浪费物理计算力的可能性。</p>
<h5 id="修改schema-xml文件-14"><a href="#修改schema-xml文件-14" class="headerlink" title="修改schema.xml文件"></a><strong>修改<code>schema.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"user10"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2,dn3"</span> <span class="attr">primaryKey</span>=<span class="string">"id"</span> <span class="attr">rule</span>=<span class="string">"sharding-by-murmur"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="修改rule-xml文件-13"><a href="#修改rule-xml文件-13" class="headerlink" title="修改rule.xml文件"></a><strong>修改<code>rule.xml</code>文件</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">"sharding-by-murmur"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>murmur<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">"murmur"</span> <span class="attr">class</span>=<span class="string">"io.mycat.route.function.PartitionByMurmurHash"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 默认是 0--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"seed"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 要分片的数据库节点数量，必须指定，否则没法分片--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"count"</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 一个实际的数据库节点被映射为这么多虚拟节点，默认是160倍，也就是虚拟节点数是物理节点数的 160 倍--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"virtualBucketTimes"</span>&gt;</span>160<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--节点的权重，没有指定权重的节点默认是 1。以 properties 文件的格式填写，以从 0 开始到 count-1 的整数值也就是节点索引为 key，以节点权重值为值。所有权重值必须是正整数，否则以 1 代替 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;property name="weightMapFile"&gt;weightMapFile&lt;/property&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--用于测试时观察各物理节点与虚拟节点的分布情况，如果指定了这个属性，会把虚拟节点的 murmur hash 值与物理节点的映射按行输出到这个文件，没有默认值，如果不指定，就不会输出任何东西 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"bucketMapPath"</span>&gt;</span>/etc/mycat/bucketMapPath<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="重启mycat-14"><a href="#重启mycat-14" class="headerlink" title="重启mycat"></a><strong>重启mycat</strong></h5><h5 id="建表-15"><a href="#建表-15" class="headerlink" title="建表"></a><strong>建表</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user10(<span class="keyword">id</span> <span class="built_in">bigint</span> <span class="keyword">not</span> <span class="literal">null</span> primary <span class="keyword">key</span>,<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">20</span>));</span><br></pre></td></tr></table></figure>

<h5 id="插入数据-15"><a href="#插入数据-15" class="headerlink" title="插入数据"></a><strong>插入数据</strong></h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user10(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">1111111</span>,<span class="keyword">database</span>());</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user10(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">2222222</span>,<span class="keyword">database</span>());</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user10(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">3333333</span>,<span class="keyword">database</span>());</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user10(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">4444444</span>,<span class="keyword">database</span>());</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user10(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">8960000</span>,<span class="keyword">database</span>());</span><br></pre></td></tr></table></figure>

<h5 id="查询结果-13"><a href="#查询结果-13" class="headerlink" title="查询结果"></a><strong>查询结果</strong></h5><img src="/images/linux/mycat/分片-一致性hash.jpg" style="zoom: 55%;" />

<blockquote>
<p>根据<code>count</code>指定分片的节点数量，每个节点会被映射<code>virtualBucketTimes</code>倍的虚拟节点，将<code>columns</code>字段计算hash值再对2^32取模得出hash槽位，顺时针寻找该位最近的节点进行存储</p>
</blockquote>
<hr>
<h2 id="三、分片join"><a href="#三、分片join" class="headerlink" title="三、分片join"></a>三、分片join</h2><p>​        Join绝对是关系型数据库中最常用的一个特性，然而在分布式环境中，跨分配的join却是最复杂的，最难解决的一个问题。</p>
<p>​        性能建议：</p>
<ol>
<li>尽量避免使用left join或right join，而用inner join</li>
<li>在使用left join或right join时，on会优先执行，where条件在最后执行，所以再使用过程中，条件尽可能的在on语句中判断，减少where的执行</li>
<li>少使用子查询，而用join</li>
</ol>
<p>​        mycat目前版本支持跨分配的join，主要有四种实现方式：<a href="https://yrlzero.gitee.io/2021/04/29/mycat%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BD%BF%E7%94%A8/#%E5%85%A8%E5%B1%80%E8%A1%A8" target="_blank" rel="noopener"><code>全局表</code></a>、<a href="https://yrlzero.gitee.io/2021/04/29/mycat%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BD%BF%E7%94%A8/#ER%E5%88%86%E7%89%87" target="_blank" rel="noopener"><code>ER分片</code></a>、<code>catletT(人工智能)</code>、<code>ShareJoin</code></p>
<h3 id="全局表"><a href="#全局表" class="headerlink" title="全局表"></a><strong>全局表</strong></h3><p>​        在分片的情况下，当业务表因为规模而进行分片之后，业务表与这个字典表的之间关联会变得比较棘手，因此，在mycat中存在一种全局表，他具备以下特性：</p>
<ol>
<li>全局表的插入、更新操作会实时的在所有节点上执行，保持各个分片的数据一致性</li>
<li>全局表的查询操作，只从一个节点获取</li>
<li>全局表可以跟任何一个表进行join操作</li>
</ol>
<h4 id="修改schema-xml文件-15"><a href="#修改schema-xml文件-15" class="headerlink" title="修改schema.xml文件"></a><strong>修改<code>schema.xml</code>文件</strong></h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"dict_order_type"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2"</span> <span class="attr">type</span>=<span class="string">"global"</span>&gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="重启mycat-15"><a href="#重启mycat-15" class="headerlink" title="重启mycat"></a><strong>重启mycat</strong></h4><h4 id="建表-16"><a href="#建表-16" class="headerlink" title="建表"></a><strong>建表</strong></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> dict_order_type(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">INT</span> AUTO_INCREMENT,</span><br><span class="line">    order_type <span class="built_in">VARCHAR</span>(<span class="number">200</span>),</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(<span class="keyword">id</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h4 id="插入数据-16"><a href="#插入数据-16" class="headerlink" title="插入数据"></a><strong>插入数据</strong></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> dict_order_type(<span class="keyword">id</span>,order_type) <span class="keyword">VALUES</span>(<span class="number">101</span>,<span class="string">'type1'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> dict_order_type(<span class="keyword">id</span>,order_type) <span class="keyword">VALUES</span>(<span class="number">102</span>,<span class="string">'type2'</span>);</span><br></pre></td></tr></table></figure>

<h4 id="查询结果-14"><a href="#查询结果-14" class="headerlink" title="查询结果"></a><strong>查询结果</strong></h4><img src="/images/linux/mycat/全局表.jpg" style="zoom:67%;" />

<blockquote>
<p>由图可以看出，每个节点都保存了一份数据，而查询只会从一个节点获取，相当于每个节点都冗余了一个全局表，以便节点内的数据join操作</p>
</blockquote>
<hr>
<h3 id="ER分片"><a href="#ER分片" class="headerlink" title="ER分片"></a><strong>ER分片</strong></h3><p>​        在mycat中，我们已经将orders进行了数据分片，但是orders表跟orders_detail发生关联，如果只把orders_detail放到一个分片上，那么跨库的join很麻烦，所以提出了ER关系的表分片。什么意思呢？<code>就是通过关联关系，将子表与父表关联的记录放在同一个数据分片上。</code></p>
<h4 id="修改schema-xml文件-16"><a href="#修改schema-xml文件-16" class="headerlink" title="修改schema.xml文件"></a><strong>修改<code>schema.xml</code>文件</strong></h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span> =<span class="string">"orders"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2"</span> <span class="attr">rule</span>=<span class="string">"mod_rule"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">childTable</span> <span class="attr">name</span>=<span class="string">"orders_detail"</span> <span class="attr">primaryKey</span>=<span class="string">"id"</span> <span class="attr">joinKey</span>=<span class="string">"order_id"</span> <span class="attr">parentKey</span>=<span class="string">"id"</span> /&gt;</span>	<span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>修改<code>rule.xml</code>文件</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">"mod_rule"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>customer_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>mod-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="重启mycat-16"><a href="#重启mycat-16" class="headerlink" title="重启mycat"></a><strong>重启mycat</strong></h4><h4 id="建表-17"><a href="#建表-17" class="headerlink" title="建表"></a><strong>建表</strong></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--订单表 </span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> orders(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">INT</span> AUTO_INCREMENT,</span><br><span class="line">    order_type <span class="built_in">INT</span>,</span><br><span class="line">    customer_id <span class="built_in">INT</span>,</span><br><span class="line">    amount <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(<span class="keyword">id</span>)</span><br><span class="line">);</span><br><span class="line"><span class="comment">--订单详细表 </span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> orders_detail(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">INT</span> AUTO_INCREMENT,</span><br><span class="line">    detail <span class="built_in">VARCHAR</span>(<span class="number">2000</span>),</span><br><span class="line">    order_id <span class="built_in">INT</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(<span class="keyword">id</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h4 id="插入数据-17"><a href="#插入数据-17" class="headerlink" title="插入数据"></a><strong>插入数据</strong></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders(<span class="keyword">id</span>,order_type,customer_id,amount) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="number">101</span>,<span class="number">100</span>,<span class="number">100100</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders(<span class="keyword">id</span>,order_type,customer_id,amount) <span class="keyword">VALUES</span>(<span class="number">2</span>,<span class="number">101</span>,<span class="number">100</span>,<span class="number">100300</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders(<span class="keyword">id</span>,order_type,customer_id,amount) <span class="keyword">VALUES</span>(<span class="number">3</span>,<span class="number">101</span>,<span class="number">101</span>,<span class="number">120000</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders(<span class="keyword">id</span>,order_type,customer_id,amount) <span class="keyword">VALUES</span>(<span class="number">4</span>,<span class="number">101</span>,<span class="number">101</span>,<span class="number">103000</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders(<span class="keyword">id</span>,order_type,customer_id,amount) <span class="keyword">VALUES</span>(<span class="number">5</span>,<span class="number">102</span>,<span class="number">101</span>,<span class="number">100400</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders(<span class="keyword">id</span>,order_type,customer_id,amount) <span class="keyword">VALUES</span>(<span class="number">6</span>,<span class="number">102</span>,<span class="number">100</span>,<span class="number">100020</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders_detail(<span class="keyword">id</span>,detail,order_id) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'detail1'</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders_detail(<span class="keyword">id</span>,detail,order_id) <span class="keyword">VALUES</span>(<span class="number">2</span>,<span class="string">'detail1'</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders_detail(<span class="keyword">id</span>,detail,order_id) <span class="keyword">VALUES</span>(<span class="number">3</span>,<span class="string">'detail1'</span>,<span class="number">3</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders_detail(<span class="keyword">id</span>,detail,order_id) <span class="keyword">VALUES</span>(<span class="number">4</span>,<span class="string">'detail1'</span>,<span class="number">4</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders_detail(<span class="keyword">id</span>,detail,order_id) <span class="keyword">VALUES</span>(<span class="number">5</span>,<span class="string">'detail1'</span>,<span class="number">5</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders_detail(<span class="keyword">id</span>,detail,order_id) <span class="keyword">VALUES</span>(<span class="number">6</span>,<span class="string">'detail1'</span>,<span class="number">6</span>);</span><br></pre></td></tr></table></figure>

<h4 id="查询结果-15"><a href="#查询结果-15" class="headerlink" title="查询结果"></a><strong>查询结果</strong></h4><img src="/images/linux/mycat/er分片.jpg" style="zoom:60%;" />

<blockquote>
<p>关联关系，将子表与父表关联的记录放在同一个数据分片上，以便数据之间的join关联</p>
</blockquote>
<hr>
<h3 id="Share-join"><a href="#Share-join" class="headerlink" title="Share join"></a>Share join</h3><p>​        ShareJoin是一个简单的跨分片join,基于HBT的方式实现。目前支持2个表的join，原理是解析SQL语句，拆分成单表的SQL语句执行，然后把各个节点的数据汇集。</p>
<h4 id="修改schema-xml文件-17"><a href="#修改schema-xml文件-17" class="headerlink" title="修改schema.xml文件"></a><strong>修改<code>schema.xml</code>文件</strong></h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"company"</span> <span class="attr">primaryKey</span>=<span class="string">"id"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2,dn3"</span> <span class="attr">rule</span>=<span class="string">"mod-long"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"customers"</span> <span class="attr">primaryKey</span>=<span class="string">"id"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2"</span> <span class="attr">rule</span>=<span class="string">"sharding-by-intfile"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="修改rule-xml文件-14"><a href="#修改rule-xml文件-14" class="headerlink" title="修改rule.xml文件"></a><strong>修改<code>rule.xml</code>文件</strong></h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">"mod-long"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>mod-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">"mod-long"</span> <span class="attr">class</span>=<span class="string">"io.mycat.route.function.PartitionByMod"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- how many data nodes --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"count"</span>&gt;</span>3<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">"sharding-by-intfile"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>sharding_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>hash-int<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">"hash-int"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"io.mycat.route.function.PartitionByFileMap"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mapFile"</span>&gt;</span>partition-hash-int.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="修改partition-hash-int-txt文件-1"><a href="#修改partition-hash-int-txt文件-1" class="headerlink" title="修改partition-hash-int.txt文件"></a>修改partition-hash-int.txt文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">10000&#x3D;0</span><br><span class="line">10010&#x3D;1</span><br></pre></td></tr></table></figure>

<h4 id="重启mycat-17"><a href="#重启mycat-17" class="headerlink" title="重启mycat"></a><strong>重启mycat</strong></h4><h4 id="建表-18"><a href="#建表-18" class="headerlink" title="建表"></a><strong>建表</strong></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> company(<span class="keyword">id</span> <span class="built_in">int</span> primary <span class="keyword">key</span>,<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">10</span>)) <span class="keyword">engine</span>=<span class="keyword">innodb</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> customers(<span class="keyword">id</span> <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span> primary <span class="keyword">key</span>,<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">100</span>),company_id <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span>,sharding_id <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<h4 id="插入数据-18"><a href="#插入数据-18" class="headerlink" title="插入数据"></a><strong>插入数据</strong></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> company (<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'mycat'</span>);</span><br><span class="line"><span class="keyword">insert</span> company (<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">'ibm'</span>);</span><br><span class="line"><span class="keyword">insert</span> company (<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">'hp'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> customers(<span class="keyword">id</span>,<span class="keyword">name</span>,company_id,sharding_id)<span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'wang'</span>,<span class="number">1</span>,<span class="number">10000</span>),(<span class="number">2</span>,<span class="string">'xue'</span>,<span class="number">2</span>,<span class="number">10010</span>),(<span class="number">3</span>,<span class="string">'feng'</span>,<span class="number">3</span>,<span class="number">10000</span>);</span><br></pre></td></tr></table></figure>

<h4 id="查询结果-16"><a href="#查询结果-16" class="headerlink" title="查询结果"></a><strong>查询结果</strong></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 可以看到有时可以查出对应的结果，有时则查询不到</span></span><br><span class="line"><span class="keyword">select</span> a.*,b.ID,b.NAME <span class="keyword">as</span> tit <span class="keyword">from</span> customers a,company b <span class="keyword">where</span> a.COMPANY_ID=b.ID;</span><br><span class="line"><span class="comment">--可以看到每次都可以直接查询到结果</span></span><br><span class="line"><span class="comment">/*!mycat:catlet=io.mycat.catlets.ShareJoin */</span><span class="keyword">select</span> a.*,b.ID,b.NAME <span class="keyword">as</span> tit <span class="keyword">from</span> customers a,company b <span class="keyword">where</span> a.COMPANY_ID=b.ID;</span><br><span class="line"><span class="comment">--其他写法</span></span><br><span class="line"><span class="comment">/*!mycat:catlet=io.mycat.catlets.ShareJoin */</span><span class="keyword">select</span> a.*,b.ID,b.NAME <span class="keyword">as</span> tit <span class="keyword">from</span> customers a <span class="keyword">join</span> company b <span class="keyword">on</span> a.COMPANY_ID=b.ID;</span><br><span class="line"><span class="comment">/*!mycat:catlet=io.mycat.catlets.ShareJoin */</span><span class="keyword">select</span> a.*,b.ID,b.NAME <span class="keyword">as</span> tit <span class="keyword">from</span> customers a <span class="keyword">join</span> company b <span class="keyword">where</span> a.COMPANY_ID=b.ID;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="四、全局序列号"><a href="#四、全局序列号" class="headerlink" title="四、全局序列号"></a>四、全局序列号</h2><h3 id="1、本地文件方式"><a href="#1、本地文件方式" class="headerlink" title="1、本地文件方式"></a>1、本地文件方式</h3><p>​        使用此方式的时候，mycat讲sequence配置到文件中，当使用到sequence中的配置，mycat会更新sequence_conf.properties文件中sequence当前的值。</p>
<p>​        <strong>配置方式：</strong></p>
<p>​        在 sequence_conf.properties 文件中做如下配置：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">GLOBAL_SEQ.HISIDS</span>=<span class="string"></span></span><br><span class="line"><span class="meta">GLOBAL_SEQ.MINID</span>=<span class="string">10001</span></span><br><span class="line"><span class="meta">GLOBAL_SEQ.MAXID</span>=<span class="string">20000</span></span><br><span class="line"><span class="meta">GLOBAL_SEQ.CURID</span>=<span class="string">10000</span></span><br></pre></td></tr></table></figure>

<p>​        其中 HISIDS 表示使用过的历史分段(一般无特殊需要可不配置)， MINID 表示最小 ID 值， MAXID 表示最大<br>ID 值， CURID 表示当前 ID 值。<br>​        server.xml 中配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">system</span>&gt;</span><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sequnceHandlerType"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="tag">&lt;/<span class="name">system</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​        注： sequnceHandlerType 需要配置为 0，表示使用本地文件方式。  </p>
<p>​        案例使用：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tab1(<span class="keyword">id</span> <span class="built_in">int</span> primary <span class="keyword">key</span>,<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">10</span>));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tab1(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="keyword">next</span> <span class="keyword">value</span> <span class="keyword">for</span> mycatseq_global,<span class="string">'test1'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tab1(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="keyword">next</span> <span class="keyword">value</span> <span class="keyword">for</span> mycatseq_global,<span class="string">'test2'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tab1(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="keyword">next</span> <span class="keyword">value</span> <span class="keyword">for</span> mycatseq_global,<span class="string">'test3'</span>);</span><br></pre></td></tr></table></figure>

<p>​        缺点：当mycat重新发布后，配置文件中的sequence会恢复到初始值</p>
<p>​        优点：本地加载，读取速度较快</p>
<h3 id="2、数据库方式"><a href="#2、数据库方式" class="headerlink" title="2、数据库方式"></a>2、数据库方式</h3><p>​        在数据库中建立一张表，存放sequence名称（name）,sequence当前值(current_value),步长（increment int类型，每次读取多少个sequence，假设为K）等信息；</p>
<p>​        <strong>获取数据步骤</strong>：</p>
<p>​        1、当初次使用该sequence时，根据传入的sequence名称，从数据库这张表中读取current_value和increment到mycat中，并将数据库中的current_value设置为原current_value值+increment值。</p>
<p>​        2、mycat将读取到current_value+increment作为本次要使用的sequence值，下次使用时，自动加1，当使用increment次后，执行步骤1中的操作</p>
<p>​        3、mycat负责维护这张表，用到哪些sequence，只需要在这张表中插入一条记录即可，若某次读取的sequence没有用完，系统就停掉了，则这次读取的sequence剩余值不会再使用</p>
<p>​        <strong>配置方式：</strong></p>
<p>​        1、修改server.xml文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">system</span>&gt;</span><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sequnceHandlerType"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="tag">&lt;/<span class="name">system</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​        2、修改schema.xml文件        </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"test"</span> <span class="attr">primaryKey</span>=<span class="string">"id"</span> <span class="attr">autoIncrement</span>=<span class="string">"true"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2,dn3"</span> <span class="attr">rule</span>=<span class="string">"mod-long"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"mycat_sequence"</span> <span class="attr">primaryKey</span>=<span class="string">"name"</span> <span class="attr">dataNode</span>=<span class="string">"dn2"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>​        3、修改mycat配置文件sequence_db_conf.properties，添加属性值</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#sequence stored in datanode</span></span><br><span class="line"><span class="attr">GLOBAL</span>=<span class="string">dn1</span></span><br><span class="line"><span class="attr">COMPANY</span>=<span class="string">dn1</span></span><br><span class="line"><span class="attr">CUSTOMER</span>=<span class="string">dn1</span></span><br><span class="line"><span class="attr">ORDERS</span>=<span class="string">dn1</span></span><br><span class="line"><span class="attr">MYCAT</span>=<span class="string">dn2</span></span><br></pre></td></tr></table></figure>

<p>​        4、在dn2上添加mycat_sequence表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> mycat_sequence;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mycat_sequence (<span class="keyword">name</span> <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,current_value <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,<span class="keyword">increment</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">100</span>, PRIMARY <span class="keyword">KEY</span>(<span class="keyword">name</span>)) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;</span><br></pre></td></tr></table></figure>

<p>​        5、在dn2上的mycat_sequence表中插入初始记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> mycat_sequence(<span class="keyword">name</span>,current_value,<span class="keyword">increment</span>) <span class="keyword">VALUES</span> (<span class="string">'mycat'</span>, <span class="number">-99</span>, <span class="number">100</span>);</span><br></pre></td></tr></table></figure>

<p>​        6、在dn2上创建函数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--创建函数</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">FUNCTION</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> mycat_seq_currval;</span><br><span class="line">DELIMITER $</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> mycat_seq_currval(seq_name <span class="built_in">VARCHAR</span>(<span class="number">50</span>)) <span class="keyword">RETURNS</span> <span class="built_in">varchar</span>(<span class="number">64</span>)     <span class="keyword">CHARSET</span> utf8</span><br><span class="line"><span class="keyword">DETERMINISTIC</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">DECLARE</span> retval <span class="built_in">VARCHAR</span>(<span class="number">64</span>);</span><br><span class="line"><span class="keyword">SET</span> retval=<span class="string">"-999999999,null"</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">concat</span>(<span class="keyword">CAST</span>(current_value <span class="keyword">AS</span> <span class="built_in">CHAR</span>),<span class="string">","</span>,<span class="keyword">CAST</span>(<span class="keyword">increment</span> <span class="keyword">AS</span> <span class="built_in">CHAR</span>)) <span class="keyword">INTO</span> retval <span class="keyword">FROM</span> mycat_sequence <span class="keyword">WHERE</span> <span class="keyword">name</span> = seq_name;</span><br><span class="line">RETURN retval;</span><br><span class="line"><span class="keyword">END</span> $</span><br><span class="line">DELIMITER ;</span><br><span class="line"><span class="comment">--设置sequence值</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">FUNCTION</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> mycat_seq_setval;</span><br><span class="line">DELIMITER $</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> mycat_seq_setval(seq_name <span class="built_in">VARCHAR</span>(<span class="number">50</span>),<span class="keyword">value</span> <span class="built_in">INTEGER</span>) <span class="keyword">RETURNS</span>     <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">CHARSET</span> utf8</span><br><span class="line"><span class="keyword">DETERMINISTIC</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">UPDATE</span> mycat_sequence</span><br><span class="line"><span class="keyword">SET</span> current_value = <span class="keyword">value</span></span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> = seq_name;</span><br><span class="line">RETURN mycat_seq_currval(seq_name);</span><br><span class="line"><span class="keyword">END</span> $</span><br><span class="line">DELIMITER ;</span><br><span class="line"><span class="comment">--获取下一个sequence值</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">FUNCTION</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> mycat_seq_nextval;</span><br><span class="line">DELIMITER $</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> mycat_seq_nextval(seq_name <span class="built_in">VARCHAR</span>(<span class="number">50</span>)) <span class="keyword">RETURNS</span> <span class="built_in">varchar</span>(<span class="number">64</span>)     <span class="keyword">CHARSET</span> utf8</span><br><span class="line"><span class="keyword">DETERMINISTIC</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">UPDATE</span> mycat_sequence</span><br><span class="line"><span class="keyword">SET</span> current_value = current_value + <span class="keyword">increment</span> <span class="keyword">WHERE</span> <span class="keyword">name</span> = seq_name;</span><br><span class="line">RETURN mycat_seq_currval(seq_name);</span><br><span class="line"><span class="keyword">END</span> $</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<p>​        <strong>数据测试：</strong></p>
<p>​        1、插入数据表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">test</span>(<span class="keyword">id</span> <span class="built_in">int</span>,<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">10</span>));</span><br></pre></td></tr></table></figure>

<p>​        2、查询对应的序列数据表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> mycat_sequence;</span><br></pre></td></tr></table></figure>

<p>​        3、向表中插入数据，可以多执行几次</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">test</span>(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="keyword">next</span> <span class="keyword">value</span> <span class="keyword">for</span> MYCATSEQ_MYCAT,(<span class="keyword">select</span> <span class="keyword">database</span>()));</span><br></pre></td></tr></table></figure>

<p>​        4、查询添加的数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">test</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">id</span> <span class="keyword">asc</span>;</span><br></pre></td></tr></table></figure>

<p>​        5、重新启动mycat，重新添加数据，查看结果，重启之后从101开始</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> mycat_sequence;</span><br></pre></td></tr></table></figure>

<p>​        6、重新查询数据表test</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">test</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">id</span> <span class="keyword">asc</span>;</span><br></pre></td></tr></table></figure>

<p>​        大家在使用的时候会发现报错的情况，这个错误的原因不是因为我们的配置，是因为我们的版本问题，简单替换下版本即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into test(id,name) values(next value for MYCATSEQ_MYCAT,(select database()));</span><br><span class="line">ERROR 1003 (HY000): mycat sequnce err.java.lang.NumberFormatException: null</span><br></pre></td></tr></table></figure>

<h3 id="3、本地时间戳方式"><a href="#3、本地时间戳方式" class="headerlink" title="3、本地时间戳方式"></a>3、本地时间戳方式</h3><p>​        ID= 64 位二进制 (42(毫秒)+5(机器 ID)+5(业务编码)+12(重复累加)。</p>
<p>​        换算成十进制为 18 位数的 long 类型，每毫秒可以并发 12 位二进制的累加。  </p>
<p>​        <strong>使用方式：</strong></p>
<p>​        1、配置server.xml文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sequnceHandlerType"</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​        2、修改sequence_time_conf.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">WORKID</span>=<span class="string">06 #任意整数</span></span><br><span class="line"><span class="attr">DATAACENTERID</span>=<span class="string">06  #任意整数</span></span><br></pre></td></tr></table></figure>

<p>​        3、修改schema.xml文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"test2"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2,dn3"</span> <span class="attr">primaryKey</span>=<span class="string">"id"</span> <span class="attr">autoIncrement</span>=<span class="string">"true"</span> <span class="attr">rule</span>=<span class="string">"mod-long"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>​        4、启动mycat，并且创建表进行测试</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test2(<span class="keyword">id</span> <span class="built_in">bigint</span> auto_increment primary <span class="keyword">key</span>,xm <span class="built_in">varchar</span>(<span class="number">32</span>));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test2(<span class="keyword">id</span>,xm) <span class="keyword">values</span>(<span class="keyword">next</span> <span class="keyword">value</span> <span class="keyword">for</span> MYCATSEQ_GLOBAL，<span class="string">'lisi'</span>) ;</span><br></pre></td></tr></table></figure>

<p>​        此方式的优点是配置简单，但是缺点也很明显就是18位的id太长，需要耗费多余的存储空间。</p>
<h3 id="4、自定义全局序列"><a href="#4、自定义全局序列" class="headerlink" title="4、自定义全局序列"></a>4、自定义全局序列</h3><p>​        用户还可以在程序中自定义全局序列，通过java代码来实现，这种方式一般比较麻烦，因此在能使用mycat提供的方式满足需求的前提下一般不需要自己通过java代码来实现。</p>
<h3 id="5、分布式ZK-ID生成器"><a href="#5、分布式ZK-ID生成器" class="headerlink" title="5、分布式ZK ID生成器"></a>5、分布式ZK ID生成器</h3><p>​        如果在搭建的时候使用了zookeeper，也可以使用zk来生成对应的id，此方式需要zk的配合，此处不再展示，有兴趣的同学下去自己演示即可。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/mysql/" rel="tag"># mysql</a>
              <a href="/tags/db/" rel="tag"># db</a>
              <a href="/tags/mycat/" rel="tag"># mycat</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/05/07/mycat%E5%9F%BA%E6%9C%AC%E5%AE%89%E8%A3%85%E5%8F%8A%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/" rel="prev" title="mycat基本安装及高可用部署">
      <i class="fa fa-chevron-left"></i> mycat基本安装及高可用部署
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/05/16/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%89%A7%E8%A1%8C%E5%8E%9F%E7%90%86/" rel="next" title="线程池-执行原理">
      线程池-执行原理 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、读写分离"><span class="nav-text">一、读写分离</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#writeType"><span class="nav-text">writeType</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#switchType"><span class="nav-text">switchType</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证"><span class="nav-text">验证</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、分库分表"><span class="nav-text">二、分库分表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1、分库"><span class="nav-text">1、分库</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1、修改-etc-my-cnf文件"><span class="nav-text">1.1、修改&#x2F;etc&#x2F;my.cnf文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2、重启mysql"><span class="nav-text">1.2、重启mysql</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3、修改schema-xml文件"><span class="nav-text">1.3、修改schema.xml文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4、重启mycat"><span class="nav-text">1.4、重启mycat</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-5、停止master的slave服务"><span class="nav-text">1.5、停止master的slave服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-6、验证"><span class="nav-text">1.6、验证</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#登陆mcat"><span class="nav-text">登陆mcat</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#建表"><span class="nav-text">建表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#插入数据"><span class="nav-text">插入数据</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2、分表（分片）"><span class="nav-text">2、分表（分片）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1、取模运算"><span class="nav-text">2.1、取模运算</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#修改schema-xml文件"><span class="nav-text">修改schema.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改rule-xml文件"><span class="nav-text">修改rule.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#重启mycat"><span class="nav-text">重启mycat</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#建表-1"><span class="nav-text">建表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#插入数据-1"><span class="nav-text">插入数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查询结果"><span class="nav-text">查询结果</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2、分片枚举"><span class="nav-text">2.2、分片枚举</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#修改schema-xml文件-1"><span class="nav-text">修改schema.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改rule-xml文件-1"><span class="nav-text">修改rule.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改partition-hash-int-txt文件"><span class="nav-text">修改partition-hash-int.txt文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#重启mycat-1"><span class="nav-text">重启mycat</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#建表-2"><span class="nav-text">建表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#插入数据-2"><span class="nav-text">插入数据</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3、范围分片"><span class="nav-text">2.3、范围分片</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#修改schema-xml文件-2"><span class="nav-text">修改schema.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改rule-xml文件-2"><span class="nav-text">修改rule.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改autopartition-long-txt文件"><span class="nav-text">修改autopartition-long.txt文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#重启mycat-2"><span class="nav-text">重启mycat</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#建表-3"><span class="nav-text">建表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#插入数据-3"><span class="nav-text">插入数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查询结果-1"><span class="nav-text">查询结果</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4、范围求模算法"><span class="nav-text">2.4、范围求模算法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#修改schema-xml文件-3"><span class="nav-text">修改schema.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改rule-xml文件-3"><span class="nav-text">修改rule.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改partition-range-mod-txt文件"><span class="nav-text">修改partition-range-mod.txt文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#重启mycat-3"><span class="nav-text">重启mycat</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#建表-4"><span class="nav-text">建表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#插入数据-4"><span class="nav-text">插入数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查询结果-2"><span class="nav-text">查询结果</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5、固定分片hash算法"><span class="nav-text">2.5、固定分片hash算法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#修改schema-xml文件-4"><span class="nav-text">修改schema.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改rule-xml文件-4"><span class="nav-text">修改rule.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#重启mycat-4"><span class="nav-text">重启mycat</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#建表-5"><span class="nav-text">建表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#插入数据-5"><span class="nav-text">插入数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查询结果-3"><span class="nav-text">查询结果</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6、取模范围算法"><span class="nav-text">2.6、取模范围算法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#修改schema-xml文件-5"><span class="nav-text">修改schema.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改rule-xml文件-5"><span class="nav-text">修改rule.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改partition-pattern-txt文件"><span class="nav-text">修改partition-pattern.txt文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#重启mycat-5"><span class="nav-text">重启mycat</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#建表-6"><span class="nav-text">建表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#插入数据-6"><span class="nav-text">插入数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查询结果-4"><span class="nav-text">查询结果</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-7、字符串hash求模范围算法"><span class="nav-text">2.7、字符串hash求模范围算法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#修改schema-xml文件-6"><span class="nav-text">修改schema.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改rule-xml文件-6"><span class="nav-text">修改rule.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改partition-pattern-txt文件-1"><span class="nav-text">修改partition-pattern.txt文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#重启mycat-6"><span class="nav-text">重启mycat</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#建表-7"><span class="nav-text">建表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#插入数据-7"><span class="nav-text">插入数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查询结果-5"><span class="nav-text">查询结果</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-8、应用指定的算法"><span class="nav-text">2.8、应用指定的算法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#修改schema-xml文件-7"><span class="nav-text">修改schema.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改rule-xml文件-7"><span class="nav-text">修改rule.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#重启mycat-7"><span class="nav-text">重启mycat</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#建表-8"><span class="nav-text">建表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#插入数据-8"><span class="nav-text">插入数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查询结果-6"><span class="nav-text">查询结果</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-9、字符串hash解析算法"><span class="nav-text">2.9、字符串hash解析算法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#修改schema-xml文件-8"><span class="nav-text">修改schema.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改rule-xml5文件"><span class="nav-text">修改rule.xml5文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#重启mycat-8"><span class="nav-text">重启mycat</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#建表-9"><span class="nav-text">建表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#插入数据-9"><span class="nav-text">插入数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查询结果-7"><span class="nav-text">查询结果</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-10、按照日期范围分片"><span class="nav-text">2.10、按照日期范围分片</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#修改schema-xml文件-9"><span class="nav-text">修改schema.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改rule-xml文件-8"><span class="nav-text">修改rule.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#重启mycat-9"><span class="nav-text">重启mycat</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#建表-10"><span class="nav-text">建表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#插入数据-10"><span class="nav-text">插入数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查询结果-8"><span class="nav-text">查询结果</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-11、按单月小时分片"><span class="nav-text">2.11、按单月小时分片</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#修改schema-xml文件-10"><span class="nav-text">修改schema.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改rule-xml文件-9"><span class="nav-text">修改rule.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#重启mycat-10"><span class="nav-text">重启mycat</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#建表-11"><span class="nav-text">建表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#插入数据-11"><span class="nav-text">插入数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查询结果-9"><span class="nav-text">查询结果</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-12、日期范围hash分片"><span class="nav-text">2.12、日期范围hash分片</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#修改schema-xml文件-11"><span class="nav-text">修改schema.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改rule-xml文件-10"><span class="nav-text">修改rule.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#重启mycat-11"><span class="nav-text">重启mycat</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#建表-12"><span class="nav-text">建表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#插入数据-12"><span class="nav-text">插入数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查询结果-10"><span class="nav-text">查询结果</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-13、冷热数据分片"><span class="nav-text">2.13、冷热数据分片</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#修改schema-xml文件-12"><span class="nav-text">修改schema.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改rule-xml文件-11"><span class="nav-text">修改rule.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#重启mycat-12"><span class="nav-text">重启mycat</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#建表-13"><span class="nav-text">建表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#插入数据-13"><span class="nav-text">插入数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查询结果-11"><span class="nav-text">查询结果</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-14、自然月分片"><span class="nav-text">2.14、自然月分片</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#修改schema-xml文件-13"><span class="nav-text">修改schema.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改rule-xml文件-12"><span class="nav-text">修改rule.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#重启mycat-13"><span class="nav-text">重启mycat</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#建表-14"><span class="nav-text">建表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#插入数据-14"><span class="nav-text">插入数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查询结果-12"><span class="nav-text">查询结果</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-15、一致性hash分片"><span class="nav-text">2.15、一致性hash分片</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#修改schema-xml文件-14"><span class="nav-text">修改schema.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改rule-xml文件-13"><span class="nav-text">修改rule.xml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#重启mycat-14"><span class="nav-text">重启mycat</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#建表-15"><span class="nav-text">建表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#插入数据-15"><span class="nav-text">插入数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查询结果-13"><span class="nav-text">查询结果</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、分片join"><span class="nav-text">三、分片join</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#全局表"><span class="nav-text">全局表</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#修改schema-xml文件-15"><span class="nav-text">修改schema.xml文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重启mycat-15"><span class="nav-text">重启mycat</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#建表-16"><span class="nav-text">建表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#插入数据-16"><span class="nav-text">插入数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查询结果-14"><span class="nav-text">查询结果</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ER分片"><span class="nav-text">ER分片</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#修改schema-xml文件-16"><span class="nav-text">修改schema.xml文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重启mycat-16"><span class="nav-text">重启mycat</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#建表-17"><span class="nav-text">建表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#插入数据-17"><span class="nav-text">插入数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查询结果-15"><span class="nav-text">查询结果</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Share-join"><span class="nav-text">Share join</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#修改schema-xml文件-17"><span class="nav-text">修改schema.xml文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改rule-xml文件-14"><span class="nav-text">修改rule.xml文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改partition-hash-int-txt文件-1"><span class="nav-text">修改partition-hash-int.txt文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重启mycat-17"><span class="nav-text">重启mycat</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#建表-18"><span class="nav-text">建表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#插入数据-18"><span class="nav-text">插入数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查询结果-16"><span class="nav-text">查询结果</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、全局序列号"><span class="nav-text">四、全局序列号</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1、本地文件方式"><span class="nav-text">1、本地文件方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2、数据库方式"><span class="nav-text">2、数据库方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3、本地时间戳方式"><span class="nav-text">3、本地时间戳方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4、自定义全局序列"><span class="nav-text">4、自定义全局序列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5、分布式ZK-ID生成器"><span class="nav-text">5、分布式ZK ID生成器</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yrl"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">yrl</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">60</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yrl</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  
</body>
</html>
