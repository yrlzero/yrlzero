<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yrlzero.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="一、 service作用使用kubernetes集群运行工作负载时，由于Pod经常处于用后即焚状态，Pod经常被重新生成，因此Pod对应的IP地址也会经常变化，导致无法直接访问Pod提供的服务，Kubernetes中使用了Service来解决这一问题，即在Pod前面使用Service对Pod进行代理，无论Pod怎样变化 ，只要有Label，就可以让Service能够联系上Pod，把PodIP地址添">
<meta property="og:type" content="article">
<meta property="og:title" content="K8s-service">
<meta property="og:url" content="http://yrlzero.github.io/2022/11/15/k8s-service/index.html">
<meta property="og:site_name" content="yrl&#39;s blog">
<meta property="og:description" content="一、 service作用使用kubernetes集群运行工作负载时，由于Pod经常处于用后即焚状态，Pod经常被重新生成，因此Pod对应的IP地址也会经常变化，导致无法直接访问Pod提供的服务，Kubernetes中使用了Service来解决这一问题，即在Pod前面使用Service对Pod进行代理，无论Pod怎样变化 ，只要有Label，就可以让Service能够联系上Pod，把PodIP地址添">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yrlzero.github.io/images/k8s-service/%E6%88%AA%E5%9B%BE19.png">
<meta property="og:image" content="http://yrlzero.github.io/images/k8s-service/%E6%88%AA%E5%9B%BE20.png">
<meta property="og:image" content="http://yrlzero.github.io/images/k8s-service/%E6%88%AA%E5%9B%BE21.png">
<meta property="og:image" content="http://yrlzero.github.io/images/k8s-service/%E6%88%AA%E5%9B%BE22.png">
<meta property="og:image" content="http://yrlzero.github.io/images/k8s-service/%E6%88%AA%E5%9B%BE23.png">
<meta property="og:image" content="http://yrlzero.github.io/images/k8s-service/%E6%88%AA%E5%9B%BE24.png">
<meta property="og:image" content="http://yrlzero.github.io/images/k8s-service/%E6%88%AA%E5%9B%BE25.png">
<meta property="og:image" content="http://yrlzero.github.io/images/k8s-service/%E6%88%AA%E5%9B%BE26.png">
<meta property="article:published_time" content="2022-11-15T14:32:13.579Z">
<meta property="article:modified_time" content="2022-11-15T14:31:53.969Z">
<meta property="article:author" content="yrl">
<meta property="article:tag" content="K8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yrlzero.github.io/images/k8s-service/%E6%88%AA%E5%9B%BE19.png">

<link rel="canonical" href="http://yrlzero.github.io/2022/11/15/k8s-service/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>K8s-service | yrl's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">yrl's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yrlzero.github.io/2022/11/15/k8s-service/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="yrl">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yrl's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          K8s-service
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-11-15 22:32:13 / 修改时间：22:31:53" itemprop="dateCreated datePublished" datetime="2022-11-15T22:32:13+08:00">2022-11-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/devops/" itemprop="url" rel="index"><span itemprop="name">devops</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/devops/K8s/" itemprop="url" rel="index"><span itemprop="name">K8s</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="一、-service作用"><a href="#一、-service作用" class="headerlink" title="一、 service作用"></a>一、 service作用</h1><p>使用kubernetes集群运行工作负载时，由于Pod经常处于用后即焚状态，Pod经常被重新生成，因此Pod对应的IP地址也会经常变化，导致无法直接访问Pod提供的服务，Kubernetes中使用了Service来解决这一问题，即在Pod前面使用Service对Pod进行代理，无论Pod怎样变化 ，只要有Label，就可以让Service能够联系上Pod，把PodIP地址添加到Service对应的端点列表（Endpoints）实现对Pod IP跟踪，进而实现通过Service访问Pod目的。</p>
<ul>
<li><p>通过service为pod客户端提供访问pod方法，即可客户端访问pod入口</p>
</li>
<li><p>通过标签动态感知pod IP地址变化等</p>
</li>
<li><p>防止pod失联</p>
</li>
<li><p>定义访问pod访问策略</p>
</li>
<li><p>通过label-selector相关联</p>
</li>
<li><p>通过Service实现Pod的负载均衡（TCP/UDP 4层）</p>
</li>
<li><p>底层实现由kube-proxy通过userspace、iptables、ipvs三种代理模式</p>
<a id="more"></a>

</li>
</ul>
<h1 id="二、kube-proxy三种代理模式"><a href="#二、kube-proxy三种代理模式" class="headerlink" title="二、kube-proxy三种代理模式"></a>二、kube-proxy三种代理模式</h1><ul>
<li><p>kubernetes集群中有三层网络，一类是真实存在的，例如Node Network、Pod Network,提供真实IP地址;一类是虚拟的，例如Cluster Network或Service Network，提供虚拟IP地址，不会出现在接口上，仅会出现在Service当中</p>
</li>
<li><p>kube-proxy始终watch（监控）kube-apiserver上关于Service相关的资源变动状态，一旦获取相关信息，kube-proxy就把相关信息转化为当前节点之上能够实现Service资源调度到特定Pod之上的规则，进而实现访问Service就能够获取Pod所提供的服务</p>
</li>
<li><p>kube-proxy三种代理模式：UserSpace模式、iptables模式、ipvs模式</p>
</li>
</ul>
<h2 id="2-1-UserSpace模式"><a href="#2-1-UserSpace模式" class="headerlink" title="2.1 UserSpace模式"></a>2.1 UserSpace模式</h2><p>userspace 模式是 kube-proxy 使用的第一代模式，该模式在 kubernetes v1.0 版本开始支持使用。</p>
<p>userspace 模式的实现原理图示如下：</p>
<img src="/images/k8s-service/截图19.png" alt="截图19" style="zoom:67%;" />

<p>kube-proxy 会为每个 Service 随机监听一个端口(proxy port)，并增加一条 iptables 规则。所以通过 ClusterIP:Port 访问 Service 的报文都 redirect 到 proxy port，kube-proxy 从它监听的 proxy port 收到报文以后，走 round robin(默认) 或是 session affinity(会话亲和力，即同一 client IP 都走同一链路给同一 pod 服务)，分发给对应的 pod。</p>
<p>由于 userspace 模式会造成所有报文都走一遍用户态（也就是 Service 请求会先从用户空间进入内核 iptables，然后再回到用户空间，由 kube-proxy 完成后端 Endpoints 的选择和代理工作），需要在内核空间和用户空间转换，流量从用户空间进出内核会带来性能损耗，所以这种模式效率低、性能不高，不推荐使用。</p>
<img src="/images/k8s-service/截图20.png" alt="截图20" style="zoom: 67%;" />

<h2 id="2-2-iptables模式"><a href="#2-2-iptables模式" class="headerlink" title="2.2 iptables模式"></a>2.2 iptables模式</h2><p>iptables 模式是 kube-proxy 使用的第二代模式，该模式在 kubernetes v1.1 版本开始支持，从 v1.2 版本开始成为 kube-proxy 的默认模式。</p>
<p>iptables 模式的负载均衡模式是通过底层 netfilter/iptables 规则来实现的，通过 Informer 机制 Watch 接口实时跟踪 Service 和 Endpoint 的变更事件，并触发对 iptables 规则的同步更新。</p>
<p>iptables 模式的实现原理图示如下：</p>
<img src="/images/k8s-service/截图21.png" alt="截图21" style="zoom: 67%;" />

<p>通过图示我们可以发现在 iptables 模式下，kube-proxy 只是作为 controller，而不是 server，真正服务的是内核的 netfilter，体现在用户态的是 iptables。所以整体的效率会比 userspace 模式高。</p>
<img src="/images/k8s-service/截图22.png" alt="截图22" style="zoom:67%;" />



<h2 id="2-3-ipvs模式"><a href="#2-3-ipvs模式" class="headerlink" title="2.3 ipvs模式"></a>2.3 ipvs模式</h2><p>ipvs 模式被 kube-proxy 采纳为第三代模式，模式在 kubernetes v1.8 版本开始引入，在 v1.9 版本中处于 beta 阶段，在 v1.11 版本中正式开始使用。</p>
<p>ipvs(IP Virtual Server) 实现了传输层负载均衡，也就是 4 层交换，作为 Linux 内核的一部分。<code>ipvs</code>运行在主机上，在真实服务器前充当负载均衡器。ipvs 可以将基于 TCP 和 UDP 的服务请求转发到真实服务器上，并使真实服务器上的服务在单个 IP 地址上显示为虚拟服务。</p>
<p>ipvs 模式的实现原理图示如下：</p>
<img src="/images/k8s-service/截图23.png" alt="截图23" style="zoom:67%;" />

<img src="/images/k8s-service/截图24.png" alt="截图23" style="zoom:67%;" />

<p>ipvs 和 iptables 都是基于 netfilter 的，那么 ipvs 模式有哪些更好的性能呢？</p>
<ul>
<li>ipvs 为大型集群提供了更好的可拓展性和性能</li>
<li>ipvs 支持比 iptables 更复杂的负载均衡算法（包括：最小负载、最少连接、加权等）</li>
<li>ipvs 支持服务器健康检查和连接重试等功能</li>
<li>可以动态修改 ipset 的集合，即使 iptables 的规则正在使用这个集合</li>
</ul>
<p>ipvs 依赖于 iptables。ipvs 会使用 iptables 进行包过滤、airpin-masquerade tricks(地址伪装)、SNAT 等功能，但是使用的是 iptables 的扩展 ipset，并不是直接调用 iptables 来生成规则链。通过 ipset 来存储需要 DROP 或 masquerade 的流量的源或目标地址，用于确保 iptables 规则的数量是恒定的，这样我们就不需要关心有多少 Service 或是 Pod 了。</p>
<p>使用 ipset 相较于 iptables 有什么优点呢？iptables 是线性的数据结构，而 ipset 引入了带索引的数据结构，当规则很多的时候，ipset 依然可以很高效的查找和匹配。我们可以将 ipset 简单理解为一个 IP(段) 的集合，这个集合的内容可以是 IP 地址、IP 网段、端口等，iptables 可以直接添加规则对这个“可变的集合进行操作”，这样就可以大大减少 iptables 规则的数量，从而减少性能损耗。</p>
<p>举一个例子，如果我们要禁止成千上万个 IP 访问我们的服务器，如果使用 iptables 就需要一条一条的添加规则，这样会在 iptables 中生成大量的规则；如果用 ipset 就只需要将相关的 IP 地址(网段)加入到 ipset 集合中，然后只需要设置少量的 iptables 规则就可以实现这个目标。</p>
<p>下面的表格是 ipvs 模式下维护的 ipset 表集合：</p>
<table>
<thead>
<tr>
<th align="left">设置名称</th>
<th align="left">成员</th>
<th align="left">用法</th>
</tr>
</thead>
<tbody><tr>
<td align="left">KUBE-CLUSTER-IP</td>
<td align="left">所有服务 IP + 端口</td>
<td align="left">在 masquerade-all=true 或 clusterCIDR 指定的情况下对 Service Cluster IP 地址进行伪装，解决数据包欺骗问题</td>
</tr>
<tr>
<td align="left">KUBE-LOOP-BACK</td>
<td align="left">所有服务 IP + 端口 + IP</td>
<td align="left">解决数据包欺骗问题</td>
</tr>
<tr>
<td align="left">KUBE-EXTERNAL-IP</td>
<td align="left">服务外部 IP + 端口</td>
<td align="left">将数据包伪装成 Service 的外部 IP 地址</td>
</tr>
<tr>
<td align="left">KUBE-LOAD-BALANCER</td>
<td align="left">负载均衡器入口 IP + 端口</td>
<td align="left">将数据包伪装成 Load Balancer 类型的 Service</td>
</tr>
<tr>
<td align="left">KUBE-LOAD-BALANCER-LOCAL</td>
<td align="left">负载均衡器入口 IP + 端口 以及<code>externalTrafficPolicy=local</code></td>
<td align="left">接受数据包到 Load Balancer externalTrafficPolicy=local</td>
</tr>
<tr>
<td align="left">KUBE-LOAD-BALANCER-FW</td>
<td align="left">负载均衡器入口 IP + 端口 以及<code>loadBalancerSourceRanges</code></td>
<td align="left">使用指定的 loadBalancerSourceRanges 丢弃 Load Balancer 类型 Service 的数据包</td>
</tr>
<tr>
<td align="left">KUBE-LOAD-BALANCER-SOURCE-CIDR</td>
<td align="left">负载均衡器入口 IP + 端口 + 源 CIDR</td>
<td align="left">接受 Load Balancer 类型 Service 的数据包，并指定 loadBalancerSourceRanges</td>
</tr>
<tr>
<td align="left">KUBE-NODE-PORT-TCP</td>
<td align="left">NodePort 类型服务 TCP 端口</td>
<td align="left">将数据包伪装成 NodePort（TCP）</td>
</tr>
<tr>
<td align="left">KUBE-NODE-PORT-LOCAL-TCP</td>
<td align="left">NodePort 类型服务 TCP 端口，带有<code>externalTrafficPolicy=local</code></td>
<td align="left">接受数据包到 NodePort 服务，使用 externalTrafficPolicy=local</td>
</tr>
<tr>
<td align="left">KUBE-NODE-PORT-UDP</td>
<td align="left">NodePort 类型服务 UDP 端口</td>
<td align="left">将数据包伪装成 NodePort(UDP)</td>
</tr>
<tr>
<td align="left">KUBE-NODE-PORT-LOCAL-UDP</td>
<td align="left">NodePort 类型服务 UDP 端口，使用<code>externalTrafficPolicy=local</code></td>
<td align="left">接受数据包到 NodePort 服务，使用 externalTrafficPolicy=local</td>
</tr>
</tbody></table>
<h2 id="2-4-iptables与ipvs对比"><a href="#2-4-iptables与ipvs对比" class="headerlink" title="2.4 iptables与ipvs对比"></a>2.4 iptables与ipvs对比</h2><ul>
<li><p>iptables</p>
<ul>
<li>工作在内核空间</li>
<li>优点：灵活，功能强大（可以在数据包不同阶段对包进行操作）</li>
<li>缺点：表中规则过多时，响应变慢，即规则遍历匹配和更新，呈线性时延</li>
</ul>
</li>
<li><p>ipvs</p>
<ul>
<li>工作在内核空间</li>
<li>优点<ul>
<li>转发效率高</li>
<li>调度算法丰富：rr，wrr，lc，wlc，ip hash…</li>
</ul>
</li>
<li>缺点：内核支持不全,低版本内核不能使用，需要升级到4.0或5.0以上。</li>
</ul>
</li>
<li><p>使用iptables与ipvs时机</p>
<ul>
<li>1.10版本之前使用iptables(1.1版本之前使用UserSpace进行转发)</li>
<li>1.11版本之后同时支持iptables与ipvs，默认使用ipvs，如果ipvs模块没有加载时，会自动降级至iptables</li>
</ul>
</li>
</ul>
<h1 id="三、-service类型"><a href="#三、-service类型" class="headerlink" title="三、 service类型"></a>三、 service类型</h1><p>Service类型决定了访问Service的方法</p>
<h2 id="3-1-service类型"><a href="#3-1-service类型" class="headerlink" title="3.1 service类型"></a>3.1 service类型</h2><ul>
<li><p>ClusterIP</p>
<ul>
<li>默认，分配一个集群内部可以访问的虚拟IP</li>
</ul>
</li>
<li><p>NodePort</p>
<ul>
<li>在每个Node上分配一个端口作为外部访问入口</li>
<li>nodePort端口范围为:30000-32767</li>
</ul>
</li>
<li><p>LoadBalancer</p>
<ul>
<li>工作在特定的Cloud Provider上，例如Google Cloud，AWS，OpenStack</li>
</ul>
</li>
<li><p>ExternalName</p>
<ul>
<li>表示把集群外部的服务引入到集群内部中来，即实现了集群内部pod和集群外部的服务进行通信</li>
</ul>
</li>
</ul>
<h2 id="3-2-Service参数"><a href="#3-2-Service参数" class="headerlink" title="3.2 Service参数"></a>3.2 Service参数</h2><ul>
<li><p>port：访问service使用的端口</p>
</li>
<li><p>targetPort：Pod中容器端口</p>
</li>
<li><p>nodePort：通过Node实现外网用户访问k8s集群内service (30000-32767)</p>
</li>
</ul>
<h1 id="四、-Service创建"><a href="#四、-Service创建" class="headerlink" title="四、 Service创建"></a>四、 Service创建</h1><blockquote>
<p>Service的创建在工作中有两种方式，一是命令行创建，二是通过资源清单文件YAML文件创建。</p>
</blockquote>
<h2 id="4-1-ClusterIP类型"><a href="#4-1-ClusterIP类型" class="headerlink" title="4.1 ClusterIP类型"></a>4.1 ClusterIP类型</h2><p>ClusterIP根据是否生成ClusterIP又可分为普通Service和Headless Service</p>
<p>Service两类：</p>
<ul>
<li><p>普通Service：为Kubernetes的Service分配一个集群内部可访问的固定虚拟IP(Cluster IP), 实现集群内的访问。</p>
</li>
<li><p>Headless Service：该服务不会分配Cluster IP, 也不通过kube-proxy做反向代理和负载均衡。而是通过DNS提供稳定的网络ID来访问，DNS会将headless service的后端直接解析为pod IP列表。</p>
</li>
</ul>
<img src="/images/k8s-service/截图25.png" alt="截图25" style="zoom:67%;" />



<h3 id="4-1-1-普通ClusterIP-Service创建"><a href="#4-1-1-普通ClusterIP-Service创建" class="headerlink" title="4.1.1 普通ClusterIP Service创建"></a>4.1.1 普通ClusterIP Service创建</h3><h4 id="4-1-1-1-命令行创建Service"><a href="#4-1-1-1-命令行创建Service" class="headerlink" title="4.1.1.1 命令行创建Service"></a>4.1.1.1 命令行创建Service</h4><p>创建Deployment类型的应用</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># cat 01_create_deployment_app_nginx.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-server1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">     metadata:</span><br><span class="line">       labels:</span><br><span class="line">         app: nginx</span><br><span class="line">     spec:</span><br><span class="line">       containers:</span><br><span class="line">       - name: c1</span><br><span class="line">         image: nginx:1.15-alpine</span><br><span class="line">         imagePullPolicy: IfNotPresent</span><br><span class="line">         ports:</span><br><span class="line">         - containerPort: 80</span><br></pre></td></tr></table></figure>

<p>应用资源清单文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># kubectl apply -f 01_create_deployment_app_nginx.yaml</span></span><br></pre></td></tr></table></figure>

<p>验证Deployment类型的创建情况</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># kubectl get deployment.apps</span></span><br><span class="line">NAME            READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-server1   2/2     2            2           13s</span><br></pre></td></tr></table></figure>

<p>创建ClusterIP类型service与Deployment类型应用关联</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#命令创建service</span></span><br><span class="line">[root@master01 ~]<span class="comment"># kubectl expose deployment.apps nginx-server1 --type=ClusterIP --target-port=80 --port=80</span></span><br><span class="line">service/nginx-server1 exposed</span><br></pre></td></tr></table></figure>

<blockquote>
<p>说明<br>expose 创建service<br>deployment.apps 控制器类型<br>nginx-server1 应用名称，也是service名称<br>–type=ClusterIP 指定service类型<br>–target-port=80 指定Pod中容器端口<br>–port=80 指定service端口</p>
</blockquote>
<h4 id="4-1-1-2-通过资源清单文件创建Service"><a href="#4-1-1-2-通过资源清单文件创建Service" class="headerlink" title="4.1.1.2 通过资源清单文件创建Service"></a>4.1.1.2 通过资源清单文件创建Service</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># cat 02_create_deployment_app_nginx_with_service.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-server1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">     metadata:</span><br><span class="line">       labels:</span><br><span class="line">         app: nginx</span><br><span class="line">     spec:</span><br><span class="line">       containers:</span><br><span class="line">       - name: nginx-smart</span><br><span class="line">         image: nginx:1.15-alpine</span><br><span class="line">         imagePullPolicy: IfNotPresent</span><br><span class="line">         ports:</span><br><span class="line">         - containerPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-svc</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br></pre></td></tr></table></figure>

<p>应用资源文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># kubectl  apply -f 02_create_deployment_app_nginx_with_service.yaml</span></span><br></pre></td></tr></table></figure>

<p>验证</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看service</span></span><br><span class="line">[root@master01 ~]<span class="comment"># kubectl get service</span></span><br><span class="line">NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP    4d15h</span><br><span class="line">nginx-svc    ClusterIP   10.101.153.50   &lt;none&gt;        80/TCP    3s</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看endpoints</span></span><br><span class="line">[root@master01 ~]<span class="comment"># kubectl get endpoints</span></span><br><span class="line">NAME         ENDPOINTS                            AGE</span><br><span class="line">kubernetes   192.168.122.30:6443                  4d15h</span><br><span class="line">nginx-svc    172.16.189.74:80,172.16.235.150:80   8s</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看Pod</span></span><br><span class="line">[root@master01 ~]<span class="comment"># kubectl get pods -l app=nginx</span></span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-server1-77d4c485d8-gsrmq   1/1     Running   0          12s</span><br><span class="line">nginx-server1-77d4c485d8-mmc52   1/1     Running   0          12s</span><br></pre></td></tr></table></figure>

<h4 id="4-1-1-3-访问"><a href="#4-1-1-3-访问" class="headerlink" title="4.1.1.3 访问"></a>4.1.1.3 访问</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># curl http://10.101.153.50:80</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">"http://nginx.org/"</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">"http://nginx.com/"</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h4 id="4-1-1-4-两个pod里做成不同的主页方便测试负载均衡"><a href="#4-1-1-4-两个pod里做成不同的主页方便测试负载均衡" class="headerlink" title="4.1.1.4 两个pod里做成不同的主页方便测试负载均衡"></a>4.1.1.4 两个pod里做成不同的主页方便测试负载均衡</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># kubectl exec -it nginx-server1-77d4c485d8-gsrmq -- /bin/bash</span></span><br><span class="line">root@deployment-nginx-6fcfb67547-nv7dn:/<span class="comment"># cd /usr/share/nginx/html/</span></span><br><span class="line">root@deployment-nginx-6fcfb67547-nv7dn:/usr/share/nginx/html<span class="comment"># echo web1 &gt; index.html</span></span><br><span class="line">root@deployment-nginx-6fcfb67547-nv7dn:/usr/share/nginx/html<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">xxxxxxxxxx [root@master01 ~]<span class="comment"># kubectl exec -it nginx-server1-77d4c485d8-mmc52 -- /bin/bashroot@deployment-nginx-6fcfb67547-rqrcw:/# cd /usr/share/nginx/html/root@deployment-nginx-6fcfb67547-rqrcw:/usr/share/nginx/html# echo web2 &gt; index.htmlroot@deployment-nginx-6fcfb67547-rqrcw:/usr/share/nginx/html# exitexit</span></span><br></pre></td></tr></table></figure>

<h4 id="4-1-1-5-测试"><a href="#4-1-1-5-测试" class="headerlink" title="4.1.1.5 测试"></a>4.1.1.5 测试</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># curl 10.101.153.50</span></span><br><span class="line">或</span><br><span class="line">[root@master01 ~]<span class="comment"># while true;do curl 10.101.153.50;sleep 1; done</span></span><br></pre></td></tr></table></figure>

<h3 id="4-1-2-Headless-Service"><a href="#4-1-2-Headless-Service" class="headerlink" title="4.1.2 Headless Service"></a>4.1.2 Headless Service</h3><ul>
<li>普通的ClusterIP service是service name解析为cluster ip,然后cluster ip对应到后面的pod ip</li>
<li>Headless service是指service name 直接解析为后面的pod ip</li>
</ul>
<h4 id="4-1-2-1-编写用于创建Deployment控制器类型的资源清单文件"><a href="#4-1-2-1-编写用于创建Deployment控制器类型的资源清单文件" class="headerlink" title="4.1.2.1 编写用于创建Deployment控制器类型的资源清单文件"></a>4.1.2.1 编写用于创建Deployment控制器类型的资源清单文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># cat 03_create_deployment_app_nginx.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-server1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">     metadata:</span><br><span class="line">       labels:</span><br><span class="line">         app: nginx</span><br><span class="line">     spec:</span><br><span class="line">       containers:</span><br><span class="line">       - name: nginx-smart</span><br><span class="line">         image: nginx:1.15-alpine</span><br><span class="line">         imagePullPolicy: IfNotPresent</span><br><span class="line">         ports:</span><br><span class="line">         - containerPort: 80</span><br></pre></td></tr></table></figure>

<h4 id="4-1-2-2-通过资源清单文件创建headless-Service"><a href="#4-1-2-2-通过资源清单文件创建headless-Service" class="headerlink" title="4.1.2.2 通过资源清单文件创建headless Service"></a>4.1.2.2 通过资源清单文件创建headless Service</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#编写YAML文件</span></span><br><span class="line">[root@master ~]<span class="comment"># vim 04_headless-service.yml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: headless-service</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP     <span class="comment"># ClusterIP类型,也是默认类型</span></span><br><span class="line">  clusterIP: None     <span class="comment"># None就代表是无头service</span></span><br><span class="line">  ports:                                <span class="comment"># 指定service 端口及容器端口</span></span><br><span class="line">  - port: 80                            <span class="comment"># service ip中的端口</span></span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80                      <span class="comment"># pod中的端口</span></span><br><span class="line">  selector:                             <span class="comment"># 指定后端pod标签</span></span><br><span class="line">     app: nginx                    <span class="comment"># 可通过kubectl get pod -l app=nginx查看哪些pod在使用此标签</span></span><br></pre></td></tr></table></figure>

<h4 id="4-1-2-3-应用资源清单文件创建headless-Service"><a href="#4-1-2-3-应用资源清单文件创建headless-Service" class="headerlink" title="4.1.2.3 应用资源清单文件创建headless Service"></a>4.1.2.3 应用资源清单文件创建headless Service</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl apply -f 04_headless_service.yml</span></span><br><span class="line">service/headless-service created</span><br></pre></td></tr></table></figure>

<h4 id="4-1-2-4-查看已创建的headless-Service"><a href="#4-1-2-4-查看已创建的headless-Service" class="headerlink" title="4.1.2.4 查看已创建的headless Service"></a>4.1.2.4 查看已创建的headless Service</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl get svc</span></span><br><span class="line"></span><br><span class="line">NAME               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">headless-service   ClusterIP   None             &lt;none&gt;        80/TCP           2m18s</span><br><span class="line">kubernetes         ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP          5d9h</span><br><span class="line"><span class="comment">#可以看到headless-service没有CLUSTER-IP,用None表示</span></span><br></pre></td></tr></table></figure>

<h4 id="4-1-2-5-DNS"><a href="#4-1-2-5-DNS" class="headerlink" title="4.1.2.5 DNS"></a>4.1.2.5 DNS</h4><p>DNS服务监视Kubernetes API，为每一个Service创建DNS记录用于域名解析</p>
<p>headless service需要DNS来解决访问问题</p>
<p>DNS记录格式为：<code>&lt;service-name&gt;.&lt;namespace-name&gt;.svc.cluster.local.</code></p>
<p>查看kube-dns服务的IP</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment"># kubectl get svc -n kube-system</span></span><br><span class="line"></span><br><span class="line">NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">kube-dns         ClusterIP   10.96.0.2      &lt;none&gt;        53/UDP,53/TCP,9153/TCP   5d9h</span><br><span class="line">metrics-server   ClusterIP   10.105.219.44   &lt;none&gt;        443/TCP                  45h</span><br><span class="line"><span class="comment">#查看到coreDNS的服务地址是10.96.0.2</span></span><br></pre></td></tr></table></figure>

<p>在集群主机通过DNS服务地址查找无头服务的dns解析</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># dig -t A headless-service.default.svc.cluster.local. @10.96.0.2</span></span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-16.P2.el7_8.2 &lt;&lt;&gt;&gt; -t A headless-service.default.svc.cluster.local. @10.96.0.2</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; WARNING: .<span class="built_in">local</span> is reserved <span class="keyword">for</span> Multicast DNS</span><br><span class="line">;; You are currently testing what happens when an mDNS query is leaked to DNS</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 31371</span><br><span class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;headless-service.default.svc.cluster.local. IN A <span class="comment">#被解析域名</span></span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">headless-service.default.svc.cluster.local. 30 IN A 10.224.235.147 <span class="comment">#注意这里IP</span></span><br><span class="line"></span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 10.96.0.10<span class="comment">#53(10.96.0.2)</span></span><br><span class="line">;; WHEN: Sun May 17 10:58:50 CST 2020</span><br><span class="line">;; MSG SIZE  rcvd: 129</span><br></pre></td></tr></table></figure>

<p>验证pod的IP</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl get pod -o wide</span></span><br><span class="line"></span><br><span class="line">NAME                                READY   STATUS             RESTARTS   AGE   IP               NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-deployment-56bf6c9c8c-jmk7r   1/1     Running            0          35m   10.224.235.147   worker1   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>在集群中创建一个pod验证</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建一个镜像为busyboxplus:curl的pod，pod名称为bb2,用来解析域名</span></span><br><span class="line"></span><br><span class="line">[root@master01 ~]<span class="comment"># kubectl run bbp --image=busyboxplus:curl -it</span></span><br><span class="line">或</span><br><span class="line">[root@master01 ~]<span class="comment"># kubectl run bbp --image=1.28 -it</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#输出</span></span><br><span class="line">If you don<span class="string">'t see a command prompt, try pressing enter.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#解析域名</span></span><br><span class="line"><span class="string">nslookup headless-service.default.svc.cluster.local.</span></span><br><span class="line"><span class="string">#访问命令</span></span><br><span class="line"><span class="string">[ root@bbp:/ ]$ curl http://headless-service.default.svc.cluster.local.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#输出</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;style&gt;</span></span><br><span class="line"><span class="string">    body &#123;</span></span><br><span class="line"><span class="string">        width: 35em;</span></span><br><span class="line"><span class="string">        margin: 0 auto;</span></span><br><span class="line"><span class="string">        font-family: Tahoma, Verdana, Arial, sans-serif;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span></span><br><span class="line"><span class="string">working. Further configuration is required.&lt;/p&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;p&gt;For online documentation and support please refer to</span></span><br><span class="line"><span class="string">&lt;a href="http://nginx.org/"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span></span><br><span class="line"><span class="string">Commercial support is available at</span></span><br><span class="line"><span class="string">&lt;a href="http://nginx.com/"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">[ root@bbp:/ ]$ exit</span></span><br><span class="line"><span class="string">Session ended, resume using '</span>kubectl attach bbp -c bbp -i -t<span class="string">' command when the pod is running</span></span><br></pre></td></tr></table></figure>

<h2 id="4-2-NodePort类型"><a href="#4-2-NodePort类型" class="headerlink" title="4.2 NodePort类型"></a>4.2 NodePort类型</h2><p>在每个node上分配一个端口（30000-32767）作为外部访问入口</p>
<p>创建资源清单文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># cat 05_create_nodeport_service_app.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-app</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-app</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx-app</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-app</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: c1</span><br><span class="line">        image: nginx:1.15-alpine</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-app</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-app</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    nodePort: 30001</span><br><span class="line">    port: 8060</span><br><span class="line">    targetPort: 80</span><br></pre></td></tr></table></figure>

<p>应用资源清单文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># kubectl apply -f 05_create_nodeport_service_app.yaml</span></span><br><span class="line">deployment.apps/nginx-app created</span><br><span class="line">service/nginx-app created</span><br></pre></td></tr></table></figure>

<p>验证service创建</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># kubectl get deployment.apps</span></span><br><span class="line">NAME         READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-app    2/2     2            2           26s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master01 ~]<span class="comment"># kubectl get svc</span></span><br><span class="line">NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP          2d22h</span><br><span class="line">nginx-app    NodePort    10.104.157.20    &lt;none&gt;        8060:30001/TCP   36s</span><br><span class="line"></span><br><span class="line">[root@master01 ~]<span class="comment"># kubectl get endpoints</span></span><br><span class="line">NAME         ENDPOINTS                       AGE</span><br><span class="line">kubernetes   192.168.122.10:6443             2d22h</span><br><span class="line">nginx-app    172.16.1.24:80,172.16.2.20:80   2m10s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master01 ~]<span class="comment"># ss -anput | grep ":30001"</span></span><br><span class="line">tcp    LISTEN     0      128      :::30001                :::*                   users:((<span class="string">"kube-proxy"</span>,pid=5826,fd=9))</span><br><span class="line"></span><br><span class="line">[root@worker01 ~]<span class="comment"># ss -anput | grep ":30001"</span></span><br><span class="line">tcp    LISTEN     0      128      :::30001                :::*                   users:((<span class="string">"kube-proxy"</span>,pid=4937,fd=11))</span><br><span class="line"></span><br><span class="line">[root@worker02 ~]<span class="comment"># ss -anput | grep ":30001"</span></span><br><span class="line">tcp    LISTEN     0      128      :::30001                :::*                   users:((<span class="string">"kube-proxy"</span>,pid=5253,fd=11))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master01 ~]<span class="comment"># kubectl get pods</span></span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-app-ffd5ccc78-cnwbx    1/1     Running   0          8m59s</span><br><span class="line">nginx-app-ffd5ccc78-mz77g    1/1     Running   0          8m59s</span><br><span class="line"></span><br><span class="line">[root@master01 ~]<span class="comment"># kubectl exec -it nginx-app-ffd5ccc78-cnwbx -- bash</span></span><br><span class="line">root@nginx-app-ffd5ccc78-cnwbx:/<span class="comment"># echo "nginx-app-1" &gt; /usr/share/nginx/html/index.html</span></span><br><span class="line">root@nginx-app-ffd5ccc78-cnwbx:/<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">[root@master01 ~]<span class="comment"># kubectl exec -it nginx-app-ffd5ccc78-mz77g -- bash</span></span><br><span class="line">root@nginx-app-ffd5ccc78-mz77g:/<span class="comment"># echo "nginx-app-2" &gt; /usr/share/nginx/html/index.html</span></span><br><span class="line">root@nginx-app-ffd5ccc78-mz77g:/<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<p>在与kubernetes 节点同一网络主机中访问k8s集群内service</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]<span class="comment"># curl http://192.168.10.12:30001</span></span><br><span class="line">nginx-app-2</span><br><span class="line">[root@bogon ~]<span class="comment"># curl http://192.168.10.13:30001</span></span><br><span class="line">nginx-app-1</span><br><span class="line">[root@bogon ~]<span class="comment"># curl http://192.168.10.14:30001</span></span><br><span class="line">nginx-app-1</span><br><span class="line">[root@bogon ~]<span class="comment"># curl http://192.168.10.15:30001</span></span><br><span class="line">nginx-app-2</span><br></pre></td></tr></table></figure>

<h2 id="4-3-LoadBalancer"><a href="#4-3-LoadBalancer" class="headerlink" title="4.3 LoadBalancer"></a>4.3 LoadBalancer</h2><h3 id="4-3-1-集群外访问过程"><a href="#4-3-1-集群外访问过程" class="headerlink" title="4.3.1 集群外访问过程"></a>4.3.1 集群外访问过程</h3><ul>
<li><h4 id="用户"><a href="#用户" class="headerlink" title="用户"></a>用户</h4></li>
<li><h4 id="域名"><a href="#域名" class="headerlink" title="域名"></a>域名</h4></li>
<li><h4 id="云服务提供商提供LB服务"><a href="#云服务提供商提供LB服务" class="headerlink" title="云服务提供商提供LB服务"></a>云服务提供商提供LB服务</h4></li>
<li><h4 id="NodeIP-Port-service-IP"><a href="#NodeIP-Port-service-IP" class="headerlink" title="NodeIP:Port(service IP)"></a>NodeIP:Port(service IP)</h4></li>
<li><h4 id="Pod-IP：端口"><a href="#Pod-IP：端口" class="headerlink" title="Pod IP：端口"></a>Pod IP：端口</h4></li>
</ul>
<img src="/images/k8s-service/截图26.png" alt="截图26" style="zoom:67%;" />



<h3 id="4-3-2-自建Kubernetes的LoadBalancer类型服务方案-MetalLB"><a href="#4-3-2-自建Kubernetes的LoadBalancer类型服务方案-MetalLB" class="headerlink" title="4.3.2  自建Kubernetes的LoadBalancer类型服务方案-MetalLB"></a>4.3.2  自建Kubernetes的LoadBalancer类型服务方案-MetalLB</h3><p>MetalLB可以为kubernetes集群中的Service提供网络负载均衡功能。</p>
<p>MetalLB两大功能为:</p>
<ul>
<li>地址分配，类似于DHCP</li>
<li>外部通告，一旦MetalLB为服务分配了外部IP地址，它就需要使群集之外的网络意识到该IP在群集中“存在”。MetalLB使用标准路由协议来实现此目的：ARP，NDP或BGP。</li>
</ul>
<p>参考网址： <a href="https://metallb.universe.tf/installation/" target="_blank" rel="noopener">https://metallb.universe.tf/installation/</a></p>
<p>应用资源清单文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">资源清单文件下载：</span><br><span class="line"><span class="comment"># kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/namespace.yaml</span></span><br><span class="line"><span class="comment"># kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/metallb.yaml</span></span><br></pre></td></tr></table></figure>

<p>准备metallb配置文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx metallb]<span class="comment"># cat metallb-conf.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  namespace: metallb-system</span><br><span class="line">  name: config</span><br><span class="line">data:</span><br><span class="line">  config: |</span><br><span class="line">    address-pools:</span><br><span class="line">    - name: default</span><br><span class="line">      protocol: layer2</span><br><span class="line">      addresses:</span><br><span class="line">      - 192.168.10.90-192.168.10.100</span><br><span class="line"> </span><br><span class="line">192.168.10.90-192.168.10.100是集群节点服务器IP同一段。</span><br></pre></td></tr></table></figure>

<p>在master01节点应用资源清单文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># kubectl apply -f metallb-conf.yaml</span></span><br></pre></td></tr></table></figure>

<p>验证配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl describe configmap config -n metallb-system</span></span><br><span class="line">Name:         config</span><br><span class="line">Namespace:    metallb-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">config:</span><br><span class="line">----</span><br><span class="line">address-pools:</span><br><span class="line">- name: default</span><br><span class="line">  protocol: layer2</span><br><span class="line">  addresses:</span><br><span class="line">  - 192.168.10.90-192.168.10.100</span><br><span class="line"></span><br><span class="line">Events:  &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>发布Service类型为LoadBalancer的Deployment控制器类型应用</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建Deployment控制器类型应用nginx-metallb及service，service类型为LoadBalancer</span></span><br><span class="line"></span><br><span class="line">[root@master01 ~]<span class="comment"># vim 02_nginx-metabllb.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-metallb</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx-metallb1</span><br><span class="line">        image: nginx:1.15-alpine</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-metallb</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8090</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  <span class="built_in">type</span>: LoadBalancer</span><br><span class="line">  </span><br><span class="line">[root@master01 ~]<span class="comment"># kubectl apply -f nginx.yaml</span></span><br></pre></td></tr></table></figure>

<p>验证</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># kubectl get ns</span></span><br><span class="line">NAME                   STATUS   AGE</span><br><span class="line">default                Active   16d</span><br><span class="line">kube-node-lease        Active   16d</span><br><span class="line">kube-public            Active   16d</span><br><span class="line">kube-system            Active   16d</span><br><span class="line">kubernetes-dashboard   Active   13d</span><br><span class="line">metallb-system         Active   130m</span><br><span class="line">test1                  Active   12d</span><br><span class="line">[root@master01 ~]<span class="comment"># kubectl get pods -n metallb-system</span></span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">controller-64f8f944d-qdf8m   1/1     Running   0          110m</span><br><span class="line">speaker-cwzq7                1/1     Running   0          110m</span><br><span class="line">speaker-qk5fb                1/1     Running   0          110m</span><br><span class="line">speaker-wsllb                1/1     Running   0          110m</span><br><span class="line">speaker-x4bwt                1/1     Running   0          110m</span><br><span class="line"></span><br><span class="line">[root@master01 ~]<span class="comment"># kubectl get svc</span></span><br><span class="line">NAME            TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)          AGE</span><br><span class="line">kubernetes      ClusterIP      10.96.0.1       &lt;none&gt;           443/TCP          16d</span><br><span class="line">nginx-metallb   LoadBalancer   10.105.239.69   192.168.10.90   8090:31372/TCP   106m</span><br><span class="line"></span><br><span class="line">[root@master01 ~]<span class="comment"># ping 192.168.10.90</span></span><br><span class="line">PING 192.168.10.90 (192.168.10.90) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.10.90: icmp_seq=1 ttl=64 time=3.45 ms</span><br><span class="line">64 bytes from 192.168.10.90: icmp_seq=2 ttl=64 time=0.040 ms</span><br></pre></td></tr></table></figure>

<p>访问</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># curl http://192.168.122.90:8090</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">"http://nginx.org/"</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">"http://nginx.com/"</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p><strong>注意：使用kubeadm部署kubernetes集群修改方法</strong></p>
<blockquote>
<p>如果在IPVS模式下使用kube-proxy，从Kubernetes v1.14.2开始，必须启用ARP模式。</p>
<p>可以通过在当前集群中编辑kube-proxy配置来实现：<br><code>kubectl edit configmap -n kube-system kube-proxy</code></p>
<p>并设置：<br>apiVersion: kubeproxy.config.k8s.io/v1alpha1<br>kind: KubeProxyConfiguration<br>mode: “ipvs”<br>ipvs:<br>  strictARP: true</p>
</blockquote>
<h2 id="4-4-ExternalName"><a href="#4-4-ExternalName" class="headerlink" title="4.4 ExternalName"></a>4.4 ExternalName</h2><ul>
<li>把集群外部的服务引入到集群内部中来，实现了集群内部pod和集群外部的服务进行通信</li>
<li>ExternalName 类型的服务适用于外部服务使用域名的方式，缺点是不能指定端口</li>
<li>还有一点要注意: 集群内的Pod会继承Node上的DNS解析规则。所以只要Node可以访问的服务，Pod中也可以访问到, 这就实现了集群内服务访问集群外服务</li>
</ul>
<h3 id="将公网域名引入"><a href="#将公网域名引入" class="headerlink" title="将公网域名引入"></a>将公网域名引入</h3><p>编写YAML文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> [root@master01 ~]<span class="comment"># vim externelname.yml</span></span><br><span class="line"> </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: my-externalname</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ExternalName</span><br><span class="line">  externalName: www.baidu.com                  <span class="comment"># 对应的外部域名为www.baidu.com</span></span><br></pre></td></tr></table></figure>

<p>应用YAML文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># kubectl apply -f externelname.yml</span></span><br><span class="line">service/my-externalname created</span><br></pre></td></tr></table></figure>

<p>查看service</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># kubectl get svc |grep exter</span></span><br><span class="line">my-externalname    ExternalName   &lt;none&gt;         www.baidu.com   &lt;none&gt;         69s</span><br></pre></td></tr></table></figure>

<p>查看my-service的dns解析</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># dig -t A my-externalname.default.svc.cluster.local. @10.96.0.2</span></span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-72.el7 &lt;&lt;&gt;&gt; -t A my-externalname.default.svc.cluster.local. @10.2.0.2</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 31378</span><br><span class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 4, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;my-externalname.default.svc.cluster.local. IN A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">my-externalname.default.svc.cluster.local. 5 IN CNAME www.baidu.com.</span><br><span class="line">www.baidu.com.          5       IN      CNAME   www.a.shifen.com.</span><br><span class="line">www.a.shifen.com.       5       IN      A       14.215.177.38           解析的是百度的IP</span><br><span class="line">www.a.shifen.com.       5       IN      A       14.215.177.39           解析的是百度的IP</span><br><span class="line"></span><br><span class="line">;; Query time: 32 msec</span><br><span class="line">;; SERVER: 10.2.0.2<span class="comment">#53(10.96.0.2)</span></span><br><span class="line">;; WHEN: Thu Nov 05 11:23:41 CST 2020</span><br><span class="line">;; MSG SIZE  rcvd: 245</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> [root@master01 ~]<span class="comment"># kubectl exec -it deploy-nginx-6c9764bb69-86gwj -- /bin/sh</span></span><br><span class="line">/ <span class="comment"># nslookup www.baidu.com</span></span><br><span class="line">......</span><br><span class="line">Name:      www.baidu.com</span><br><span class="line">Address 1: 14.215.177.39</span><br><span class="line">Address 2: 14.215.177.38</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/ <span class="comment"># nslookup my-externalname.default.svc.cluster.local         </span></span><br><span class="line">......</span><br><span class="line">Name:      my-externalname.default.svc.cluster.local</span><br><span class="line">Address 1: 14.215.177.38</span><br><span class="line">Address 2: 14.215.177.39</span><br></pre></td></tr></table></figure>

<p>解析此<code>my-externalname.default.svc.cluster.local</code>域名和解析<code>www.baidu.com</code>是一样的结果</p>
<h3 id="不同命名空间访问"><a href="#不同命名空间访问" class="headerlink" title="不同命名空间访问"></a>不同命名空间访问</h3><p>创建ns1命名空间和相关deploy, pod,service</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"> [root@master01 ~]<span class="comment"># vim ns1-nginx.yml</span></span><br><span class="line">apiVersion: v1                                                  </span><br><span class="line">kind: Namespace                                                 </span><br><span class="line">metadata:                                                             </span><br><span class="line">  name: ns1                                                     <span class="comment"># 创建ns1命名空间</span></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: deploy-nginx                    </span><br><span class="line">  namespace: ns1                                                <span class="comment"># 属于ns1命名空间</span></span><br><span class="line">spec:</span><br><span class="line">  replicas: 1                                  </span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx                                </span><br><span class="line">  template:                                        </span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx                             </span><br><span class="line">    spec:</span><br><span class="line">      containers:                              </span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.15-alpine</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: svc1                                <span class="comment"># 服务名</span></span><br><span class="line">  namespace: ns1                            <span class="comment"># 属于ns1命名空间</span></span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  clusterIP: None                           <span class="comment"># 无头service</span></span><br><span class="line">  ports:</span><br><span class="line">  - port: 80                         </span><br><span class="line">    targetPort: 80                  </span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: external-svc1</span><br><span class="line">  namespace: ns1                            <span class="comment">#  属于ns1命名空间</span></span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ExternalName</span><br><span class="line">  externalName: svc2.ns2.svc.cluster.local   <span class="comment"># 将ns2空间的svc2服务引入到ns1命名空间</span></span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line"> [root@master1 ~]<span class="comment"># kubectl apply -f ns1-nginx.yml</span></span><br><span class="line"> namespace/ns1 created</span><br><span class="line"> deployment.apps/deploy-nginx created</span><br><span class="line"> service/svc1 created</span><br></pre></td></tr></table></figure>

<p>创建ns2命名空间和相关deploy, pod,service</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># vim ns1-nginx.yml</span></span><br><span class="line">apiVersion: v1                                                  </span><br><span class="line">kind: Namespace                                                 </span><br><span class="line">metadata:                                                             </span><br><span class="line">  name: ns2                                                     <span class="comment"># 创建ns2命名空间</span></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: deploy-nginx                    </span><br><span class="line">  namespace: ns2                                                <span class="comment"># 属于ns2命名空间</span></span><br><span class="line">spec:</span><br><span class="line">  replicas: 1                                  </span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx                                </span><br><span class="line">  template:                                        </span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx                             </span><br><span class="line">    spec:</span><br><span class="line">      containers:                              </span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.15-alpine</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: svc2                                <span class="comment"># 服务名</span></span><br><span class="line">  namespace: ns2                            <span class="comment"># 属于ns2命名空间</span></span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  clusterIP: None                           <span class="comment"># 无头service</span></span><br><span class="line">  ports:</span><br><span class="line">  - port: 80                         </span><br><span class="line">    targetPort: 80                  </span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: external-svc1</span><br><span class="line">  namespace: ns2                            <span class="comment">#  属于ns2命名空间</span></span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ExternalName</span><br><span class="line">  externalName: svc1.ns1.svc.cluster.local   <span class="comment"># 将ns1空间的svc1服务引入到ns2命名空间</span></span><br></pre></td></tr></table></figure>

<p>在ns1命名空间的pod里验证</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"> [root@master01 ~]<span class="comment"># kubectl get pods -n ns1</span></span><br><span class="line"> NAME                            READY   STATUS    RESTARTS   AGE</span><br><span class="line"> deploy-nginx-6c9764bb69-g5xl8   1/1     Running   0          8m10s</span><br><span class="line"> </span><br><span class="line">  [root@master01 ~]<span class="comment"># kubectl exec -it -n ns1 deploy-nginx-6c9764bb69-g5xl8 -- /bin/sh</span></span><br><span class="line"> / <span class="comment"># nslookup svc1</span></span><br><span class="line"> ......</span><br><span class="line"> Name:      svc1</span><br><span class="line"> Address 1: 10.3.166.140 deploy-nginx-6c9764bb69-g5xl8       IP与ns1里的podIP一致(见下面的查询结果)</span><br><span class="line"> </span><br><span class="line"> / <span class="comment"># nslookup svc2.ns2.svc.cluster.local</span></span><br><span class="line"> .....</span><br><span class="line"> Name:      svc2.ns2.svc.cluster.local</span><br><span class="line"> Address 1: 10.3.104.17 10-3-104-17.svc2.ns2.svc.cluster.local   IP与ns2里的podIP一致(见下面的查询结果)</span><br><span class="line"> </span><br><span class="line"> / <span class="comment"># exit</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">[root@master01 ~]<span class="comment"># kubectl get pods -o wide -n ns1</span></span><br><span class="line"> NAME                            READY   STATUS    RESTARTS   AGE   IP             NODE             NOMINATED NODE   READINESS GATES</span><br><span class="line"> deploy-nginx-6c9764bb69-g5xl8   1/1     Running   0          70m   10.3.166.140   192.168.122.13   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">[root@master01 ~]<span class="comment"># kubectl get pods -o wide -n ns2</span></span><br><span class="line"> NAME                            READY   STATUS    RESTARTS   AGE   IP            NODE             NOMINATED NODE   READI            NESS GATES</span><br><span class="line"> deploy-nginx-6c9764bb69-8psxl   1/1     Running   0          68m   10.3.104.17   192.168.122.14   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>反之，在ns2命名空间的pod里访问<code>svc1.ns1.svc.cluster.local</code>，解析的IP是ns1命名空间里的pod的IP</p>
<p>验证ns2中的pod的IP变化, ns1中的pod仍然可以使用<code>svc2.ns2.svc.cluster.local</code>访问</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># kubectl get pod -n ns2</span></span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE</span><br><span class="line">deploy-nginx-6c9764bb69-8psxl   1/1     Running   0          81m</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除pod，因为有replicas控制器，所以删除pod会自动拉一个起来</span></span><br><span class="line">[root@master01 ~]<span class="comment"># kubectl delete pod deploy-nginx-6c9764bb69-8psxl -n ns2</span></span><br><span class="line">pod <span class="string">"deploy-nginx-6c9764bb69-8psxl"</span> deleted                  </span><br><span class="line"></span><br><span class="line">[root@master01 ~]<span class="comment"># kubectl get pod -o wide -n ns2</span></span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE     IP             NODE             NOMINATED NODE   READINESS GATES</span><br><span class="line">deploy-nginx-6c9764bb69-8qbz2   1/1     Running   0          5m36s   10.3.166.141   192.168.122.13   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">pod名称变了,IP也变成了10.3.166.141</span><br></pre></td></tr></table></figure>

<p>回到ns1中的pod验证</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># kubectl exec -it -n ns1 deploy-nginx-6c9764bb69-g5xl8 -- /bin/sh</span></span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ping svc2.ns2.svc.cluster.local -c 2</span></span><br><span class="line">PING svc2.ns2.svc.cluster.local (10.3.166.141): 56 data bytes    <span class="comment">#解析的IP就是ns2中pod的新IP</span></span><br><span class="line">64 bytes from 10.3.166.141: seq=0 ttl=63 time=0.181 ms</span><br><span class="line">64 bytes from 10.3.166.141: seq=1 ttl=63 time=0.186 ms</span><br><span class="line"></span><br><span class="line">--- svc2.ns2.svc.cluster.local ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.181/0.183/0.186 ms</span><br><span class="line">/ <span class="comment"># exit</span></span><br></pre></td></tr></table></figure>

<h1 id="五、sessionAffinity"><a href="#五、sessionAffinity" class="headerlink" title="五、sessionAffinity"></a>五、sessionAffinity</h1><p>设置sessionAffinity（会话粘贴）为Clientip  (类似nginx的ip_hash算法,lvs的sh算法)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]<span class="comment"># cat 02_create_deployment_app_nginx_with_service.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-server1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">     metadata:</span><br><span class="line">       labels:</span><br><span class="line">         app: nginx</span><br><span class="line">     spec:</span><br><span class="line">       containers:</span><br><span class="line">       - name: c1</span><br><span class="line">         image: nginx:1.15-alpine</span><br><span class="line">         imagePullPolicy: IfNotPresent</span><br><span class="line">         ports:</span><br><span class="line">         - containerPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-svc</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br></pre></td></tr></table></figure>

<p>应用资源清单</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># kubectl apply -f 02_create_deployment_app_nginx_with_service.yaml</span></span><br><span class="line">deployment.apps/nginx-server1 created</span><br><span class="line">service/nginx-svc created</span><br></pre></td></tr></table></figure>

<p>修改会话粘贴模式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# kubectl patch svc nginx-svc -p &#39;&#123;&quot;spec&quot;:&#123;&quot;sessionAffinity&quot;:&quot;ClientIP&quot;&#125;&#125;&#39;</span><br><span class="line">service&#x2F;nginx-svc patched</span><br><span class="line"></span><br><span class="line">[root@master01 ~]# curl 10.100.53.31</span><br><span class="line">web1</span><br><span class="line">#多次访问,会话粘贴</span><br></pre></td></tr></table></figure>

<p>设置回sessionAffinity为None</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">设置回sessionAffinity为None</span><br><span class="line">[root@master01 ~]<span class="comment"># kubectl patch svc nginx-svc -p '&#123;"spec":&#123;"sessionAffinity":"None"&#125;&#125;'</span></span><br><span class="line">service/my-service patched</span><br><span class="line"></span><br><span class="line"><span class="comment">#多次访问,回到负载均衡</span></span><br></pre></td></tr></table></figure>

<h1 id="六、修改为ipvs调度方式"><a href="#六、修改为ipvs调度方式" class="headerlink" title="六、修改为ipvs调度方式"></a>六、修改为ipvs调度方式</h1><blockquote>
<p>部署方式不同，修改方法不一样。</p>
<p>本次主要介绍使用kubeadm部署集群方式，二进制部署较为简单。</p>
<p>二进制部署修改：/etc/kubernetes/kube-proxy.yaml文件即可。</p>
<p>从kubernetes1.8版本开始，新增了kube-proxy对ipvs的支持，在kubernetes1.11版本中被纳入了GA.</p>
</blockquote>
<h2 id="6-1-修改为IPVS调度方式前升级内核"><a href="#6-1-修改为IPVS调度方式前升级内核" class="headerlink" title="6.1 修改为IPVS调度方式前升级内核"></a>6.1 修改为IPVS调度方式前升级内核</h2><p>现使用Centos7u6发布版本，默认内核版本为3.10.0，使用kubernetes为1.18.0时，可升级内核版本至4.18.0或5.6.0版本。</p>
<p>在所有节点中安装,需要重启操作系统更换内核。以下升级方法供参考。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># yum -y install perl</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># yum -y install https://www.elrepo.org/elrepo-release-7.0-4.el7.elrepo.noarch.rpm</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># yum  --enablerepo="elrepo-kernel"  -y install kernel-ml.x86_64 </span></span><br><span class="line"><span class="comment">#此处升级为5.0以上版本。</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># grub2-set-default 0</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># grub2-mkconfig -o /boot/grub2/grub.cfg</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># reboot</span></span><br></pre></td></tr></table></figure>

<h2 id="6-2-修改kube-proxy的配置文件"><a href="#6-2-修改kube-proxy的配置文件" class="headerlink" title="6.2 修改kube-proxy的配置文件"></a>6.2 修改kube-proxy的配置文件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># kubectl edit configmap kube-proxy -n kube-system</span></span><br><span class="line">    iptables:</span><br><span class="line">      masqueradeAll: <span class="literal">false</span></span><br><span class="line">      masqueradeBit: 14</span><br><span class="line">      minSyncPeriod: 0s</span><br><span class="line">      syncPeriod: 30s</span><br><span class="line">    ipvs:</span><br><span class="line">      excludeCIDRs: null</span><br><span class="line">      minSyncPeriod: 0s</span><br><span class="line">      scheduler: <span class="string">""</span>	  <span class="comment"># 可以在这里修改ipvs的算法,默认为rr轮循算法</span></span><br><span class="line">      strictARP: <span class="literal">false</span></span><br><span class="line">      syncPeriod: 30s</span><br><span class="line">    kind: KubeProxyConfiguration</span><br><span class="line">    metricsBindAddress: 127.0.0.1:10249</span><br><span class="line">    mode: <span class="string">"ipvs"</span>	  <span class="comment"># 默认""号里为空,加上ipvs</span></span><br></pre></td></tr></table></figure>

<h2 id="6-3-查看kube-system的namespace中kube-proxy有关的pod"><a href="#6-3-查看kube-system的namespace中kube-proxy有关的pod" class="headerlink" title="6.3  查看kube-system的namespace中kube-proxy有关的pod"></a>6.3  查看kube-system的namespace中kube-proxy有关的pod</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># kubectl get pods -n kube-system |grep kube-proxy</span></span><br><span class="line">kube-proxy-69mv6                           1/1     Running   6          2d18h</span><br><span class="line">kube-proxy-jpc6c                           1/1     Running   4          4d16h</span><br><span class="line">kube-proxy-kq65l                           1/1     Running   4          4d16h</span><br><span class="line">kube-proxy-lmphf                           1/1     Running   5          4d16h</span><br></pre></td></tr></table></figure>

<h2 id="6-4-验证kube-proxy-xxx的pod中的信息"><a href="#6-4-验证kube-proxy-xxx的pod中的信息" class="headerlink" title="6.4 验证kube-proxy-xxx的pod中的信息"></a>6.4 验证kube-proxy-xxx的pod中的信息</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]<span class="comment"># kubectl logs kube-proxy-jpc6c -n kube-system</span></span><br><span class="line">W0517 00:55:10.914754       1 server_others.go:559] Unknown proxy mode <span class="string">""</span>, assuming iptables proxy</span><br><span class="line">I0517 00:55:10.923228       1 node.go:136] Successfully retrieved node IP: 192.168.122.32</span><br><span class="line">I0517 00:55:10.923264       1 server_others.go:186] Using iptables Proxier.</span><br><span class="line">I0517 00:55:10.923567       1 server.go:583] Version: v1.18.2</span><br><span class="line">I0517 00:55:10.923965       1 conntrack.go:100] Set sysctl <span class="string">'net/netfilter/nf_conntrack_max'</span> to 131072</span><br><span class="line">I0517 00:55:10.924001       1 conntrack.go:52] Setting nf_conntrack_max to 131072</span><br><span class="line">I0517 00:55:10.924258       1 conntrack.go:83] Setting conntrack hashsize to 32768</span><br><span class="line">I0517 00:55:10.927041       1 conntrack.go:100] Set sysctl <span class="string">'net/netfilter/nf_conntrack_tcp_timeout_established'</span> to 86400</span><br><span class="line">I0517 00:55:10.927086       1 conntrack.go:100] Set sysctl <span class="string">'net/netfilter/nf_conntrack_tcp_timeout_close_wait'</span> to 3600</span><br><span class="line">I0517 00:55:10.927540       1 config.go:315] Starting service config controller</span><br><span class="line">I0517 00:55:10.927556       1 shared_informer.go:223] Waiting <span class="keyword">for</span> caches to sync <span class="keyword">for</span> service config</span><br><span class="line">I0517 00:55:10.927576       1 config.go:133] Starting endpoints config controller</span><br><span class="line">I0517 00:55:10.927594       1 shared_informer.go:223] Waiting <span class="keyword">for</span> caches to sync <span class="keyword">for</span> endpoints config</span><br><span class="line">I0517 00:55:11.027749       1 shared_informer.go:230] Caches are synced <span class="keyword">for</span> service config</span><br><span class="line">I0517 00:55:11.027858       1 shared_informer.go:230] Caches are synced <span class="keyword">for</span> endpoints config</span><br></pre></td></tr></table></figure>

<h2 id="6-5-重新启动kube-proxy"><a href="#6-5-重新启动kube-proxy" class="headerlink" title="6.5 重新启动kube-proxy"></a>6.5 重新启动kube-proxy</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#删除kube-proxy-xxx的所有pod，让它重新拉取新的kube-proxy-xxx的pod</span></span><br><span class="line">[root@master01 ~]<span class="comment"># kubectl delete pod kube-proxy-69mv6 -n kube-system</span></span><br><span class="line">pod <span class="string">"kube-proxy-69mv6"</span> deleted</span><br><span class="line"></span><br><span class="line">[root@master01 ~]<span class="comment"># kubectl delete pod kube-proxy-jpc6c -n kube-system</span></span><br><span class="line">pod <span class="string">"kube-proxy-jpc6c"</span> deleted</span><br><span class="line"></span><br><span class="line">[root@master01 ~]<span class="comment"># kubectl delete pod kube-proxy-kq65l -n kube-system</span></span><br><span class="line">pod <span class="string">"kube-proxy-kq65l"</span> deleted</span><br><span class="line"></span><br><span class="line">[root@master01 ~]<span class="comment"># kubectl delete pod kube-proxy-lmphf -n kube-system</span></span><br><span class="line">pod <span class="string">"kube-proxy-lmphf"</span> deleted</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master01 ~]<span class="comment"># kubectl get pods -n kube-system |grep kube-proxy</span></span><br><span class="line">kube-proxy-2mk2b                           1/1     Running   0          2m23s</span><br><span class="line">kube-proxy-5bj87                           1/1     Running   0          30s</span><br><span class="line">kube-proxy-7qq9l                           1/1     Running   0          52s</span><br><span class="line">kube-proxy-tjtqf                           1/1     Running   0          80s</span><br><span class="line"></span><br><span class="line"><span class="comment">#随意查看其中1个或3个kube-proxy-xxx的pod,验证是否为IPVS方式了</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl logs kube-proxy-tjtqf -n kube-system</span></span><br><span class="line">I0517 02:32:26.557696       1 node.go:136] Successfully retrieved node IP: 192.168.122.32</span><br><span class="line">I0517 02:32:26.557745       1 server_others.go:259] Using ipvs Proxier.</span><br><span class="line">W0517 02:32:26.557912       1 proxier.go:429] IPVS scheduler not specified, use rr by default</span><br><span class="line">I0517 02:32:26.560008       1 server.go:583] Version: v1.18.2</span><br><span class="line">I0517 02:32:26.560428       1 conntrack.go:52] Setting nf_conntrack_max to 131072</span><br><span class="line">I0517 02:32:26.561094       1 config.go:315] Starting service config controller</span><br><span class="line">I0517 02:32:26.562251       1 shared_informer.go:223] Waiting <span class="keyword">for</span> caches to sync <span class="keyword">for</span> service config</span><br><span class="line">I0517 02:32:26.561579       1 config.go:133] Starting endpoints config controller</span><br><span class="line">I0517 02:32:26.562271       1 shared_informer.go:223] Waiting <span class="keyword">for</span> caches to sync <span class="keyword">for</span> endpoints config</span><br><span class="line">I0517 02:32:26.662541       1 shared_informer.go:230] Caches are synced <span class="keyword">for</span> service config</span><br><span class="line">I0517 02:32:26.662566       1 shared_informer.go:230] Caches are synced <span class="keyword">for</span> endpoints config</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/K8s/" rel="tag"># K8s</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/11/15/k8s%E6%9E%B6%E6%9E%84%E5%8F%8A%E7%BB%84%E4%BB%B6/" rel="prev" title="K8s架构及组件">
      <i class="fa fa-chevron-left"></i> K8s架构及组件
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/11/15/k8s-controller/" rel="next" title="K8s-controller">
      K8s-controller <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#一、-service作用"><span class="nav-text">一、 service作用</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二、kube-proxy三种代理模式"><span class="nav-text">二、kube-proxy三种代理模式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-UserSpace模式"><span class="nav-text">2.1 UserSpace模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-iptables模式"><span class="nav-text">2.2 iptables模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-ipvs模式"><span class="nav-text">2.3 ipvs模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-iptables与ipvs对比"><span class="nav-text">2.4 iptables与ipvs对比</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三、-service类型"><span class="nav-text">三、 service类型</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-service类型"><span class="nav-text">3.1 service类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-Service参数"><span class="nav-text">3.2 Service参数</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#四、-Service创建"><span class="nav-text">四、 Service创建</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-ClusterIP类型"><span class="nav-text">4.1 ClusterIP类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-1-普通ClusterIP-Service创建"><span class="nav-text">4.1.1 普通ClusterIP Service创建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-1-1-命令行创建Service"><span class="nav-text">4.1.1.1 命令行创建Service</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-1-2-通过资源清单文件创建Service"><span class="nav-text">4.1.1.2 通过资源清单文件创建Service</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-1-3-访问"><span class="nav-text">4.1.1.3 访问</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-1-4-两个pod里做成不同的主页方便测试负载均衡"><span class="nav-text">4.1.1.4 两个pod里做成不同的主页方便测试负载均衡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-1-5-测试"><span class="nav-text">4.1.1.5 测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-2-Headless-Service"><span class="nav-text">4.1.2 Headless Service</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-2-1-编写用于创建Deployment控制器类型的资源清单文件"><span class="nav-text">4.1.2.1 编写用于创建Deployment控制器类型的资源清单文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-2-2-通过资源清单文件创建headless-Service"><span class="nav-text">4.1.2.2 通过资源清单文件创建headless Service</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-2-3-应用资源清单文件创建headless-Service"><span class="nav-text">4.1.2.3 应用资源清单文件创建headless Service</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-2-4-查看已创建的headless-Service"><span class="nav-text">4.1.2.4 查看已创建的headless Service</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-2-5-DNS"><span class="nav-text">4.1.2.5 DNS</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-NodePort类型"><span class="nav-text">4.2 NodePort类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-LoadBalancer"><span class="nav-text">4.3 LoadBalancer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-1-集群外访问过程"><span class="nav-text">4.3.1 集群外访问过程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#用户"><span class="nav-text">用户</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#域名"><span class="nav-text">域名</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#云服务提供商提供LB服务"><span class="nav-text">云服务提供商提供LB服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NodeIP-Port-service-IP"><span class="nav-text">NodeIP:Port(service IP)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Pod-IP：端口"><span class="nav-text">Pod IP：端口</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-2-自建Kubernetes的LoadBalancer类型服务方案-MetalLB"><span class="nav-text">4.3.2  自建Kubernetes的LoadBalancer类型服务方案-MetalLB</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-ExternalName"><span class="nav-text">4.4 ExternalName</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#将公网域名引入"><span class="nav-text">将公网域名引入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#不同命名空间访问"><span class="nav-text">不同命名空间访问</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#五、sessionAffinity"><span class="nav-text">五、sessionAffinity</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#六、修改为ipvs调度方式"><span class="nav-text">六、修改为ipvs调度方式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-修改为IPVS调度方式前升级内核"><span class="nav-text">6.1 修改为IPVS调度方式前升级内核</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-修改kube-proxy的配置文件"><span class="nav-text">6.2 修改kube-proxy的配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-查看kube-system的namespace中kube-proxy有关的pod"><span class="nav-text">6.3  查看kube-system的namespace中kube-proxy有关的pod</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-4-验证kube-proxy-xxx的pod中的信息"><span class="nav-text">6.4 验证kube-proxy-xxx的pod中的信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-5-重新启动kube-proxy"><span class="nav-text">6.5 重新启动kube-proxy</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yrl"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">yrl</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">106</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">54</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yrl</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  
</body>
</html>
